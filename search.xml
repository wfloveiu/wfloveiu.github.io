<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>cmu 10-414 HW2</title>
      <link href="/2024/07/27/cmu%2010-414%20HW2/"/>
      <url>/2024/07/27/cmu%2010-414%20HW2/</url>
      
        <content type="html"><![CDATA[<h1 id="cmu-10-414-HW2"><a href="#cmu-10-414-HW2" class="headerlink" title="cmu 10-414 HW2"></a>cmu 10-414 HW2</h1><h2 id="Question-2"><a href="#Question-2" class="headerlink" title="Question 2"></a>Question 2</h2><h3 id="Xavier-uniform"><a href="#Xavier-uniform" class="headerlink" title="Xavier uniform"></a>Xavier uniform</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‡åŒ€åˆ†å¸ƒ U(-a, a)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xavier_uniform</span>(<span class="params">fan_in, fan_out, gain=<span class="number">1.0</span>, **kwargs</span>):</span><br><span class="line">    a = gain * math.sqrt(<span class="number">6</span> / (fan_in + fan_out))</span><br><span class="line">    out = rand(fan_in, fan_out, low=-a, high=a)</span><br><span class="line">    <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure><h3 id="Xavier-normal"><a href="#Xavier-normal" class="headerlink" title="Xavier normal"></a>Xavier normal</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ­£å¤ªåˆ†å¸ƒ N(0, std)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xavier_normal</span>(<span class="params">fan_in, fan_out, gain=<span class="number">1.0</span>, **kwargs</span>):</span><br><span class="line">    std = gain * math.sqrt(<span class="number">2</span> / (fan_in + fan_out))</span><br><span class="line">    out = randn(fan_in, fan_out, mean=<span class="number">0</span>, std=std)</span><br><span class="line">    <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure><h3 id="Kaiming-uniform"><a href="#Kaiming-uniform" class="headerlink" title="Kaiming uniform"></a>Kaiming uniform</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‡åŒ€åˆ†å¸ƒ U(-bound, bound)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">kaiming_uniform</span>(<span class="params">fan_in, fan_out, nonlinearity=<span class="string">&quot;relu&quot;</span>, **kwargs</span>):</span><br><span class="line">    <span class="keyword">assert</span> nonlinearity == <span class="string">&quot;relu&quot;</span>, <span class="string">&quot;Only relu supported currently&quot;</span></span><br><span class="line">    gain = math.sqrt(<span class="number">2</span>)</span><br><span class="line">    bound = gain * math.sqrt(<span class="number">3</span> / fan_in)</span><br><span class="line">    out = rand(fan_in, fan_out, low=-bound, high=bound)</span><br><span class="line">    <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure><h3 id="Kaiming-normal"><a href="#Kaiming-normal" class="headerlink" title="Kaiming normal"></a>Kaiming normal</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">kaiming_normal</span>(<span class="params">fan_in, fan_out, nonlinearity=<span class="string">&quot;relu&quot;</span>, **kwargs</span>):</span><br><span class="line">    <span class="keyword">assert</span> nonlinearity == <span class="string">&quot;relu&quot;</span>, <span class="string">&quot;Only relu supported currently&quot;</span></span><br><span class="line">    gain = math.sqrt(<span class="number">2</span>)</span><br><span class="line">    std = gain / math.sqrt(fan_in)</span><br><span class="line">    out = randn(fan_in, fan_out, mean=<span class="number">0</span>, std=std)</span><br><span class="line">    <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure><h2 id="Question-2-1"><a href="#Question-2-1" class="headerlink" title="Question 2"></a>Question 2</h2><h3 id="Linear"><a href="#Linear" class="headerlink" title="Linear"></a>Linear</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Linear</span>(<span class="title class_ inherited__">Module</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self, in_features, out_features, bias=<span class="literal">True</span>, device=<span class="literal">None</span>, dtype=<span class="string">&quot;float32&quot;</span></span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.in_features = in_features</span><br><span class="line">        self.out_features = out_features</span><br><span class="line">        self.have_bias = bias</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># weightå’Œbiaséœ€è¦å®šä¹‰æˆParameterç±»å‹</span></span><br><span class="line">        self.weight = Parameter(init.kaiming_uniform(in_features, out_features,device = device, dtype = dtype))</span><br><span class="line">        <span class="keyword">if</span> self.have_bias:</span><br><span class="line">            self.bias = Parameter(init.kaiming_uniform(out_features, <span class="number">1</span>, device = device, dtype = dtype).reshape((<span class="number">1</span>, out_features)))</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, X: Tensor</span>) -&gt; Tensor:</span><br><span class="line">        <span class="keyword">if</span> self.have_bias:</span><br><span class="line">            bias = ops.broadcast_to(self.bias, (X.shape[<span class="number">0</span>], self.out_features))</span><br><span class="line">            <span class="keyword">return</span> ops.matmul(X, self.weight) + bias</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> ops.matmul(X, self.weight)</span><br></pre></td></tr></table></figure><h3 id="Sequential"><a href="#Sequential" class="headerlink" title="Sequential"></a>Sequential</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Sequential</span>(<span class="title class_ inherited__">Module</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, *modules</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.modules = modules</span><br><span class="line">        <span class="comment"># print(type(modules))</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: Tensor</span>) -&gt; Tensor:</span><br><span class="line">        <span class="built_in">input</span> = x</span><br><span class="line">        <span class="keyword">for</span> module <span class="keyword">in</span> self.modules:</span><br><span class="line">            <span class="built_in">input</span> = module(<span class="built_in">input</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">input</span></span><br></pre></td></tr></table></figure><h3 id="LogSumExp"><a href="#LogSumExp" class="headerlink" title="LogSumExp"></a>LogSumExp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LogSumExp</span>(<span class="title class_ inherited__">TensorOp</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, axes: <span class="type">Optional</span>[<span class="built_in">tuple</span>] = <span class="literal">None</span></span>):</span><br><span class="line">        self.axes = axes</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compute</span>(<span class="params">self, Z</span>): <span class="comment"># å†æ¬¡è®°ä½ï¼Œåœ¨è¿›è¡Œcomputeçš„æ—¶å€™è¾“å…¥è¾“å‡ºæ˜¯arrayï¼Œè¦ä½¿ç”¨array_apiä¸­çš„å‡½æ•°</span></span><br><span class="line">        max_z_f = array_api.<span class="built_in">max</span>(Z, axis=self.axes, keepdims=<span class="literal">False</span>) <span class="comment">#å’ŒZçš„ç»´åº¦ä¸€è‡´ï¼Œæ¯ä¸€è¡Œä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯è¿™ä¸€è¡Œçš„æœ€å¤§å€¼</span></span><br><span class="line">        max_z_t = array_api.<span class="built_in">max</span>(Z, axis=self.axes, keepdims=<span class="literal">True</span>) <span class="comment"># å…¬å¼æœ€åçš„é‚£ä¸ªmaxz</span></span><br><span class="line">        tmp = array_api.<span class="built_in">sum</span>(array_api.exp(Z - max_z_t),axis=self.axes, keepdims=<span class="literal">False</span>)</span><br><span class="line">        out = array_api.log(tmp) + max_z_f</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç–‘é—®ï¼šmaxzå¯¹zçš„æ¢¯åº¦ä¸º0å—ï¼Œä¸ºä»€ä¹ˆä¸è®¡ç®—</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gradient</span>(<span class="params">self, out_grad, node</span>):</span><br><span class="line">        <span class="built_in">input</span> = node.inputs[<span class="number">0</span>].cached_data</span><br><span class="line">        max_val_t = array_api.<span class="built_in">max</span>(<span class="built_in">input</span>, axis=self.axes, keepdims=<span class="literal">True</span>)</span><br><span class="line">        exp_val = array_api.exp(<span class="built_in">input</span> - max_val_t)</span><br><span class="line">        sum_val = array_api.<span class="built_in">sum</span>(exp_val, axis=self.axes, keepdims=<span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># log_val = array_api.log(sum_val)</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#æŠŠlogä¸­çœ‹æˆæ•´ä½“ï¼Œå…ˆæ±‚å¯¹logçš„æ¢¯åº¦</span></span><br><span class="line">        grad_log = out_grad.cached_data / sum_val </span><br><span class="line">        </span><br><span class="line">        <span class="comment">#æ±‚sumçš„æ¢¯åº¦ï¼Œå’Œsummationä¸€æ ·</span></span><br><span class="line">        shape = <span class="built_in">list</span>(node.inputs[<span class="number">0</span>].shape)</span><br><span class="line">        axes = self.axes</span><br><span class="line">        <span class="keyword">if</span> axes <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">           axes = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(shape))) <span class="comment">#axesä¸ºNoneæ˜¯å¯¹æ‰€æœ‰ç»´åº¦æ±‚å’Œï¼Œç›¸å½“äºaxes=(0,1,..)</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> axes:</span><br><span class="line">            shape[_] = <span class="number">1</span></span><br><span class="line">        grad_sum = array_api.broadcast_to(array_api.reshape(grad_log, shape), node.inputs[<span class="number">0</span>].shape)</span><br><span class="line">        <span class="comment"># broadcast_to(reshape(grad_log, shape), node.inputs[0].shape)</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#æ±‚expçš„æ¢¯åº¦</span></span><br><span class="line">        grad_exp = grad_sum * exp_val</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Tensor(grad_exp)</span><br></pre></td></tr></table></figure><h3 id="SoftmaxLoss"><a href="#SoftmaxLoss" class="headerlink" title="SoftmaxLoss"></a>SoftmaxLoss</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SoftmaxLoss</span>(<span class="title class_ inherited__">Module</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, logits: Tensor, y: Tensor</span>):</span><br><span class="line">        softmax = ops.logsumexp(logits, axes=(<span class="number">1</span>,))</span><br><span class="line">        </span><br><span class="line">        shape =  logits.shape</span><br><span class="line">        batch_size = shape[<span class="number">0</span>]</span><br><span class="line">        num_class = shape[<span class="number">1</span>]</span><br><span class="line">        y_one_hot = init.one_hot(num_class, y)</span><br><span class="line">        I = ops.summation(logits * y_one_hot, axes=(<span class="number">1</span>,))</span><br><span class="line">        <span class="comment"># print(I)</span></span><br><span class="line">        <span class="keyword">return</span> ops.summation(softmax - I) / batch_size</span><br></pre></td></tr></table></figure><h3 id="LayerNorm1d"><a href="#LayerNorm1d" class="headerlink" title="LayerNorm1d"></a>LayerNorm1d</h3><p>ä¸ºä»€ä¹ˆéœ€è¦Normalizationï¼Ÿ</p><blockquote><p>æ·±åº¦ç¥ç»ç½‘ç»œæ¨¡å‹çš„è®­ç»ƒä¸ºä»€ä¹ˆä¼šå¾ˆå›°éš¾ï¼Ÿå…¶ä¸­ä¸€ä¸ªé‡è¦çš„åŸå› æ˜¯ï¼Œæ·±åº¦ç¥ç»ç½‘ç»œæ¶‰åŠåˆ°å¾ˆå¤šå±‚çš„å åŠ ï¼Œè€Œæ¯ä¸€å±‚çš„å‚æ•°æ›´æ–°ä¼šå¯¼è‡´ä¸Šå±‚çš„è¾“å…¥æ•°æ®åˆ†å¸ƒå‘ç”Ÿå˜åŒ–ï¼Œé€šè¿‡å±‚å±‚å åŠ ï¼Œé«˜å±‚çš„è¾“å…¥åˆ†å¸ƒå˜åŒ–ä¼šéå¸¸å‰§çƒˆï¼Œè¿™å°±ä½¿å¾—é«˜å±‚éœ€è¦ä¸æ–­å»é‡æ–°é€‚åº”åº•å±‚çš„å‚æ•°æ›´æ–°ã€‚ä¸ºäº†è®­å¥½æ¨¡å‹ï¼Œæˆ‘ä»¬éœ€è¦éå¸¸è°¨æ…åœ°å»è®¾å®šå­¦ä¹ ç‡ã€åˆå§‹åŒ–æƒé‡ã€ä»¥åŠå°½å¯èƒ½ç»†è‡´çš„å‚æ•°æ›´æ–°ç­–ç•¥ã€‚Google å°†è¿™ä¸€ç°è±¡æ€»ç»“ä¸º Internal Covariate Shiftï¼Œç®€ç§° ICS. </p></blockquote><blockquote><p>å¤§å®¶éƒ½çŸ¥é“åœ¨ç»Ÿè®¡æœºå™¨å­¦ä¹ ä¸­çš„ä¸€ä¸ªç»å…¸å‡è®¾æ˜¯â€œæºç©ºé—´ï¼ˆsource domainï¼‰å’Œç›®æ ‡ç©ºé—´ï¼ˆtarget domainï¼‰çš„æ•°æ®åˆ†å¸ƒï¼ˆdistributionï¼‰æ˜¯ä¸€è‡´çš„â€ã€‚å¦‚æœä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±å‡ºç°äº†æ–°çš„æœºå™¨å­¦ä¹ é—®é¢˜ï¼Œå¦‚ transfer learning &#x2F; domain adaptation ç­‰ã€‚è€Œ covariate shift å°±æ˜¯åˆ†å¸ƒä¸ä¸€è‡´å‡è®¾ä¹‹ä¸‹çš„ä¸€ä¸ªåˆ†æ”¯é—®é¢˜ï¼Œå®ƒæ˜¯æŒ‡æºç©ºé—´å’Œç›®æ ‡ç©ºé—´çš„æ¡ä»¶æ¦‚ç‡æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯å…¶è¾¹ç¼˜æ¦‚ç‡ä¸åŒï¼Œå³ï¼šå¯¹æ‰€æœ‰ğ‘¥âˆˆğ‘‹,ğ‘ƒğ‘ (ğ‘Œ|ğ‘‹&#x3D;ğ‘¥)&#x3D;ğ‘ƒğ‘¡(ğ‘Œ|ğ‘‹&#x3D;ğ‘¥) ä½†æ˜¯ğ‘ƒğ‘ (ğ‘‹)â‰ ğ‘ƒğ‘¡(ğ‘‹) å¤§å®¶ç»†æƒ³ä¾¿ä¼šå‘ç°ï¼Œçš„ç¡®ï¼Œå¯¹äºç¥ç»ç½‘ç»œçš„å„å±‚è¾“å‡ºï¼Œç”±äºå®ƒä»¬ç»è¿‡äº†å±‚å†…æ“ä½œä½œç”¨ï¼Œå…¶åˆ†å¸ƒæ˜¾ç„¶ä¸å„å±‚å¯¹åº”çš„è¾“å…¥ä¿¡å·åˆ†å¸ƒä¸åŒï¼Œè€Œä¸”å·®å¼‚ä¼šéšç€ç½‘ç»œæ·±åº¦å¢å¤§è€Œå¢å¤§ï¼Œå¯æ˜¯å®ƒä»¬æ‰€èƒ½â€œæŒ‡ç¤ºâ€çš„æ ·æœ¬æ ‡è®°ï¼ˆlabelï¼‰ä»ç„¶æ˜¯ä¸å˜çš„ï¼Œè¿™ä¾¿ç¬¦åˆäº†covariate shiftçš„å®šä¹‰ã€‚ç”±äºæ˜¯å¯¹å±‚é—´ä¿¡å·çš„åˆ†æï¼Œä¹Ÿå³æ˜¯â€œinternalâ€çš„æ¥ç”±ã€‚</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">å¼€å§‹æ—¶è®¡ç®—Eæ—¶ï¼Œæƒ³ç›´æ¥ä½¿ç”¨.dataæ¥è®¡ç®—ï¼Œä¸æƒ³åˆ›å»ºå¤æ‚çš„è®¡ç®—å›¾ã€‚åæ¥æ„è¯†åˆ°è¿™è®¡ç®—è¿‡ç¨‹å°±æ˜¯éœ€è¦åˆ›å»ºè®¡ç®—å›¾çš„ã€‚ä¹</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LayerNorm1d</span>(<span class="title class_ inherited__">Module</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, dim, eps=<span class="number">1e-5</span>, device=<span class="literal">None</span>, dtype=<span class="string">&quot;float32&quot;</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.dim = dim</span><br><span class="line">        self.eps = eps</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–å‚æ•°</span></span><br><span class="line">        self.weight = Parameter(init.ones(dim, device=device, dtype=dtype))</span><br><span class="line">        self.bias = Parameter(init.zeros(dim, device=device, dtype=dtype))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: Tensor</span>) -&gt; Tensor:</span><br><span class="line">        batch_size = x.shape[<span class="number">0</span>]</span><br><span class="line">        features = x.shape[<span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—å‡å€¼</span></span><br><span class="line">        sum_x = ops.summation(x, <span class="number">1</span>) <span class="comment">#è®¡ç®—å®Œåç»´åº¦é™ä½äº†,åŸæ¥æ˜¯(batch_size, features)ç°åœ¨æ˜¯(batch_size,)</span></span><br><span class="line">        mean_x = ops.divide_scalar(sum_x, features)</span><br><span class="line">        mean_x_reshape = ops.reshape(mean_x, (-<span class="number">1</span>,<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">        E = ops.broadcast_to(mean_x_reshape, x.shape)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®—æ ‡å‡†å·®</span></span><br><span class="line">        V_inner = ops.power_scalar(x-E, <span class="number">2</span>)</span><br><span class="line">        V_sum = ops.summation(V_inner, <span class="number">1</span>)   <span class="comment"># (batch_size,)</span></span><br><span class="line">        V_mean = ops.divide_scalar(V_sum, features)</span><br><span class="line">        V = ops.add_scalar(V_mean, self.eps)</span><br><span class="line">        sqrt_Var = ops.power_scalar(V, <span class="number">1</span>/<span class="number">2</span>)    <span class="comment"># (batch_size,)</span></span><br><span class="line">        sqrt_Var_reshape = ops.reshape(sqrt_Var, (-<span class="number">1</span>,<span class="number">1</span>))</span><br><span class="line">        sqrt_Var_reshape_brocst = ops.broadcast_to(sqrt_Var_reshape, x.shape) <span class="comment"># (batch_size,feature)</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—X</span></span><br><span class="line">        X  = (x - E) / sqrt_Var_reshape_brocst</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># weightå’Œbiasçš„ç»´åº¦éƒ½æ˜¯dimå³features</span></span><br><span class="line">        broadcast_weight = ops.broadcast_to(ops.reshape(self.weight, (<span class="number">1</span>, -<span class="number">1</span>)), x.shape)</span><br><span class="line">        broadcast_bias = ops.broadcast_to(ops.reshape(self.bias, (<span class="number">1</span>,-<span class="number">1</span>)), x.shape)</span><br><span class="line">        </span><br><span class="line">        out = broadcast_weight * X + broadcast_bias</span><br><span class="line">        <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure><h3 id="BatchNorm1d"><a href="#BatchNorm1d" class="headerlink" title="BatchNorm1d"></a>BatchNorm1d</h3><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202407241018831.png" alt="image-20240724101503540"></p><p>LayerNormalizeæ˜¯åœ¨ä¸€ä¸ªsampleä¸­å¯¹æ‰€æœ‰dimensionè¿›è¡Œçš„ã€‚è€ŒBatchNormalizeæ˜¯é’ˆå¯¹ä¸€ä¸ªdimå°†minibatchä¸­è¯¥dimæ‰€æœ‰çš„å€¼è¿›è¡Œè§„èŒƒ</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202407241019761.png" alt="image-20240724101916737"></p><p>å…¬å¼åˆ†ä¸¤æ­¥ï¼š</p><ul><li>ä¸­é—´çš„è®¡ç®—<strong>ä½¿å¾—ç¬¬ ğ‘™ å±‚çš„è¾“å…¥æ¯ä¸ªç‰¹å¾çš„åˆ†å¸ƒå‡å€¼ä¸º0ï¼Œæ–¹å·®ä¸º1ã€‚</strong></li><li>å¼•å…¥å¯å­¦ä¹ çš„å‚æ•°wå’Œbï¼Œå¼•å…¥çš„ç›®çš„æ˜¯ä¸ºäº†æ¢å¤æ•°æ®æœ¬èº«çš„è¡¨è¾¾èƒ½åŠ›ï¼Œå¯¹è§„èŒƒåŒ–åçš„æ•°æ®è¿›è¡Œçº¿æ€§å˜æ¢</li></ul><p>åœ¨è®­ç»ƒæ¨¡å‹æ—¶ï¼Œåœ¨æ¯ä¸€å±‚è®¡ç®—çš„ ğœ‡ ä¸ ğœ2 éƒ½æ˜¯åŸºäºå½“å‰batchä¸­çš„è®­ç»ƒæ•°æ®ï¼›è€Œå½“åšé¢„æµ‹æ—¶ï¼Œä¸€æ‰¹é¢„æµ‹åªæœ‰ä¸€ä¸ªæˆ–è€…å¾ˆå°‘æ ·æœ¬ï¼Œè®¡ç®—å‡ºçš„ğœ‡ ä¸ ğœ2 ä¸€å®šæœ‰åå·®ã€‚å¦‚ä½•è§£å†³ï¼Ÿ</p><p>ä¿ç•™æ¯ç»„mini-batchè®­ç»ƒæ•°æ®åœ¨ç½‘ç»œä¸­æ¯ä¸€å±‚çš„ ğœ‡ğ‘ğ‘ğ‘¡ğ‘â„ ä¸ ğœğ‘ğ‘ğ‘¡ğ‘â„2 ã€‚é¢„æµ‹æ—¶ä½¿ç”¨æ•´ä¸ªæ ·æœ¬çš„ç»Ÿè®¡é‡æ¥å¯¹é¢„æµ‹æ•°æ®è¿›è¡Œå½’ä¸€åŒ–ã€‚å³<strong>é¢å¤–è®¡ç®—æ¯å±‚ç½‘ç»œçš„è¿è¡Œæ—¶å‡å€¼å’Œæ–¹å·®</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BatchNorm1d</span>(<span class="title class_ inherited__">Module</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, dim, eps=<span class="number">1e-5</span>, momentum=<span class="number">0.1</span>, device=<span class="literal">None</span>, dtype=<span class="string">&quot;float32&quot;</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.dim = dim</span><br><span class="line">        self.eps = eps</span><br><span class="line">        self.momentum = momentum</span><br><span class="line">        </span><br><span class="line">        self.weight = Parameter(init.ones(dim, device=device, dtype=dtype))</span><br><span class="line">        self.bias = Parameter(init.zeros(dim, device=device, dtype=dtype))</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ä¸‹è¾¹ä¸¤ä¸ªå¹¶ä¸æ˜¯Parameterï¼Œå› ä¸ºä»–ä»¬ä¸æ˜¯æƒé‡ï¼Œåœ¨æœ€åä¸€ä¸ªæµ‹è¯•æ—¶å‘ç°</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.running_mean = init.zeros(dim, device=device, dtype=dtype) <span class="comment">#è¿è¡Œæ—¶æ¯ä¸€dimä¸Šçš„å‡å€¼æ–¹å·®</span></span><br><span class="line">        self.running_var = init.ones(dim, device=device, dtype=dtype)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: Tensor</span>) -&gt; Tensor:</span><br><span class="line">        batch_size = x.shape[<span class="number">0</span>]</span><br><span class="line">        broadcast_weight = ops.broadcast_to(ops.reshape(self.weight, (<span class="number">1</span>, -<span class="number">1</span>)), x.shape)</span><br><span class="line">        broadcast_bias = ops.broadcast_to(ops.reshape(self.bias, (<span class="number">1</span>,-<span class="number">1</span>)), x.shape)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> self.training:    </span><br><span class="line">        <span class="comment"># è®¡ç®—å½“å‰batchçš„å‡å€¼</span></span><br><span class="line">            sum_x = ops.summation(x, <span class="number">0</span>) <span class="comment">#(batch_size, features)-&gt;(features)</span></span><br><span class="line">            mean_x = ops.divide_scalar(sum_x, batch_size)</span><br><span class="line">            broadcast_mean = ops.broadcast_to(mean_x, x.shape)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># è®¡ç®—å½“å‰batchçš„æ ‡å‡†å·®</span></span><br><span class="line">            pow_Var = ops.power_scalar(x-broadcast_mean, <span class="number">2</span>)</span><br><span class="line">            sum_Var = ops.summation(pow_Var, <span class="number">0</span>) <span class="comment">#(batch_size, features)-&gt;(features)</span></span><br><span class="line">            Var = ops.divide_scalar(sum_Var, batch_size)</span><br><span class="line">            Var_add_eps = ops.power_scalar(ops.add_scalar(Var, self.eps), <span class="number">1</span>/<span class="number">2</span>)</span><br><span class="line">            broadcast_var = ops.broadcast_to(Var_add_eps, x.shape)</span><br><span class="line">            </span><br><span class="line">            out = broadcast_weight * (x - broadcast_mean) / broadcast_var + broadcast_bias</span><br><span class="line">            </span><br><span class="line">            self.running_mean = (<span class="number">1</span> - self.momentum) * self.running_mean + self.momentum * mean_x</span><br><span class="line">            self.running_var = (<span class="number">1</span> - self.momentum) * self.running_var + self.momentum * Var</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            broadcast_running_mean = ops.broadcast_to(ops.reshape(self.running_mean, (<span class="number">1</span>,-<span class="number">1</span>)), x.shape)</span><br><span class="line">            running_var_add_eps = ops.power_scalar(ops.add_scalar(self.running_var, self.eps), <span class="number">1</span>/<span class="number">2</span>)</span><br><span class="line">            broadcast_running_var = ops.broadcast_to(ops.reshape(running_var_add_eps, (<span class="number">1</span>,-<span class="number">1</span>)), x.shape)</span><br><span class="line">            out = broadcast_weight * (x-broadcast_running_mean) / broadcast_running_var + broadcast_bias</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure><h3 id="Dropout"><a href="#Dropout" class="headerlink" title="Dropout"></a>Dropout</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Dropout</span>(<span class="title class_ inherited__">Module</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, p=<span class="number">0.5</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.p = p</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: Tensor</span>) -&gt; Tensor:</span><br><span class="line">        <span class="keyword">if</span> self.training:</span><br><span class="line">            mask = init.randb(*x.shape, p = <span class="number">1</span>- self.p) / (<span class="number">1</span> - self.p)</span><br><span class="line">            x = x * mask</span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure><h3 id="Residual"><a href="#Residual" class="headerlink" title="Residual"></a>Residual</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Residual</span>(<span class="title class_ inherited__">Module</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, fn: Module</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.fn = fn</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: Tensor</span>) -&gt; Tensor:</span><br><span class="line">        <span class="keyword">return</span> self.fn(x) + x</span><br></pre></td></tr></table></figure><h2 id="Question3"><a href="#Question3" class="headerlink" title="Question3"></a>Question3</h2><h3 id="SGD"><a href="#SGD" class="headerlink" title="SGD"></a>SGD</h3><p>æœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„</p><ul><li>uæ˜¯å­—å…¸ï¼Œkeyæ˜¯Paramï¼Œvalueæ˜¯è¯¥Paramä¸Šä¸€æ¬¡è®¡ç®—æ—¶çš„æ¢¯åº¦ã€‚</li><li>weight_decayè¡¨æ˜éœ€è¦è€ƒè™‘L2regularizationï¼Œå³çœŸæ­£çš„æ¢¯åº¦æ˜¯param.grad.data + weight_decay * Wï¼Œè¿™æ‰æ˜¯(1-Î²)åçš„é‚£ä¸ªæ¢¯åº¦</li><li>å› ä¸ºå†™å®ŒåæŠ¥é”™float64å’Œfloat32ä¸ä¸€è‡´ï¼Œæ‰€ä»¥å°†gradçš„dtypeæ”¹æˆparamçš„dtype</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SGD</span>(<span class="title class_ inherited__">Optimizer</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, params, lr=<span class="number">0.01</span>, momentum=<span class="number">0.0</span>, weight_decay=<span class="number">0.0</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(params) <span class="comment"># paramsæ˜¯åŒ…å«å¤šä¸ªéœ€è¦è¿›è¡Œå¤šæ¬¡è¿­ä»£è®¡ç®—çš„Param</span></span><br><span class="line">        self.lr = lr</span><br><span class="line">        self.momentum = momentum</span><br><span class="line">        self.u = &#123;&#125; <span class="comment"># å­—å…¸ï¼Œkeyæ˜¯Paramï¼Œvalueæ˜¯è¯¥Paramä¸Šä¸€æ¬¡è®¡ç®—æ—¶çš„æ¢¯åº¦</span></span><br><span class="line">        self.weight_decay = weight_decay</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">step</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> param <span class="keyword">in</span> self.params:</span><br><span class="line">            grad  = self.u.get(param, <span class="number">0</span>) * self.momentum + (<span class="number">1</span>-self.momentum) * (param.grad.data + self.weight_decay * param.data)</span><br><span class="line">            grad = ndl.Tensor(grad, dtype = param.dtype)</span><br><span class="line">            self.u[param] = grad</span><br><span class="line">            param.data =  param.data - self.lr * grad</span><br></pre></td></tr></table></figure><h3 id="Adam"><a href="#Adam" class="headerlink" title="Adam"></a>Adam</h3><p>å¢åŠ <code> if param.grad is not None:</code>åˆ¤æ–­æ¡ä»¶æ˜¯å› ä¸ºæŠ¥é”™<code>param.grad</code>æ˜¯<code>NoneType</code>çš„æƒ…å†µ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Adam</span>(<span class="title class_ inherited__">Optimizer</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        params,</span></span><br><span class="line"><span class="params">        lr=<span class="number">0.01</span>,</span></span><br><span class="line"><span class="params">        beta1=<span class="number">0.9</span>,</span></span><br><span class="line"><span class="params">        beta2=<span class="number">0.999</span>,</span></span><br><span class="line"><span class="params">        eps=<span class="number">1e-8</span>,</span></span><br><span class="line"><span class="params">        weight_decay=<span class="number">0.0</span>,</span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(params)</span><br><span class="line">        self.lr = lr</span><br><span class="line">        self.beta1 = beta1</span><br><span class="line">        self.beta2 = beta2</span><br><span class="line">        self.eps = eps</span><br><span class="line">        self.weight_decay = weight_decay</span><br><span class="line">        self.t = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        self.m = &#123;&#125;</span><br><span class="line">        self.v = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">step</span>(<span class="params">self</span>):</span><br><span class="line">        self.t += <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> param <span class="keyword">in</span> self.params:</span><br><span class="line">            <span class="keyword">if</span> param.grad <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                grad_with_L2rgl = param.grad.data + self.weight_decay * param.data</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                grad_with_L2rgl = self.weight_decay * param.data</span><br><span class="line">            new_m = self.beta1 * self.m.get(param, <span class="number">0</span>) + (<span class="number">1</span>-self.beta1) * grad_with_L2rgl.data</span><br><span class="line">            new_v = self.beta2 * self.v.get(param, <span class="number">0</span>) + (<span class="number">1</span>-self.beta2) * grad_with_L2rgl.data * grad_with_L2rgl.data</span><br><span class="line">            self.m[param] = new_m</span><br><span class="line">            self.v[param] = new_v</span><br><span class="line">            m_hat = new_m.data / (<span class="number">1</span> - self.beta1 ** self.t)</span><br><span class="line">            v_hat = new_v.data / (<span class="number">1</span> - self.beta2 ** self.t)</span><br><span class="line">            out = param.data - self.lr * m_hat / (ndl.ops.power_scalar(v_hat, <span class="number">1</span>/<span class="number">2</span>) + self.eps)</span><br><span class="line">            out = ndl.Tensor(out, dtype=param.dtype)</span><br><span class="line">            param.data = out</span><br></pre></td></tr></table></figure><h2 id="Question4"><a href="#Question4" class="headerlink" title="Question4"></a>Question4</h2><h3 id="Transformations"><a href="#Transformations" class="headerlink" title="Transformations"></a>Transformations</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RandomFlipHorizontal</span>(<span class="title class_ inherited__">Transform</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, p = <span class="number">0.5</span></span>):</span><br><span class="line">        self.p = p</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, img</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Horizonally flip an image, specified as an H x W x C NDArray.</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            img: H x W x C NDArray of an image</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            H x W x C ndarray corresponding to image flipped with probability self.p</span></span><br><span class="line"><span class="string">        Note: use the provided code to provide randomness, for easier testing</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        flip_img = np.random.rand() &lt; self.p</span><br><span class="line">        <span class="keyword">if</span> flip_img:</span><br><span class="line">            img = img[:,::-<span class="number">1</span>,:]</span><br><span class="line">        <span class="keyword">return</span> img</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RandomCrop</span>(<span class="title class_ inherited__">Transform</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, padding=<span class="number">3</span></span>):</span><br><span class="line">        self.padding = padding</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, img</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; Zero pad and then randomly crop an image.</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">             img: H x W x C NDArray of an image</span></span><br><span class="line"><span class="string">        Return </span></span><br><span class="line"><span class="string">            H x W x C NAArray of cliped image</span></span><br><span class="line"><span class="string">        Note: generate the image shifted by shift_x, shift_y specified below</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        shift_x, shift_y = np.random.randint(low=-self.padding, high=self.padding+<span class="number">1</span>, size=<span class="number">2</span>) <span class="comment"># [-self.padding, self.padding]</span></span><br><span class="line">        H, W, C = img.shape</span><br><span class="line">        pad = np.zeros((H+<span class="number">2</span>*self.padding, W+<span class="number">2</span>*self.padding, C))</span><br><span class="line">        pad[self.padding:self.padding+H,self.padding:self.padding+W,:] = img</span><br><span class="line">        x = shift_x + self.padding</span><br><span class="line">        y = shift_y + self.padding</span><br><span class="line">        img = pad[x:x+H, y:y+W,:]</span><br><span class="line">        <span class="keyword">return</span> img</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="MNISTDataset"><a href="#MNISTDataset" class="headerlink" title="MNISTDataset"></a>MNISTDataset</h3><p><code>Dataset</code>çš„ä½œç”¨æ˜¯å¯¹äºç»™å®šçš„æ•°æ®è·¯å¾„ï¼Œè¯»å–å…¶ä¸­çš„æ•°æ®</p><ul><li><code>parse_mnist</code>æ˜¯ä»hw0å¤åˆ¶æ¥çš„ï¼Œä½†æ˜¯ç”±äºä¸Šè¾¹çš„è½¬æ¢å‡½æ•°æˆ‘ä»¬å‘ç°å¯¹äºä¸€ä¸ªsampleæ˜¯H* W* Cï¼Œå› æ­¤è¾“å‡ºçš„Xçš„ç»´åº¦åº”è¯¥æ˜¯(sample_numbles, H, W, C)</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MNISTDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        image_filename: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        label_filename: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        transforms: <span class="type">Optional</span>[<span class="type">List</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        self.images, self.labels = parse_mnist(image_filename, label_filename)</span><br><span class="line">        self.transforms = transforms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index</span>) -&gt; <span class="built_in">object</span>:</span><br><span class="line">        img = self.images[index]</span><br><span class="line">        <span class="keyword">return</span> self.apply_transforms(img), self.labels[index]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> self.images.shape[<span class="number">0</span>]</span><br><span class="line"><span class="comment"># copy from hw0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_mnist</span>(<span class="params">image_filename, label_filename</span>):</span><br><span class="line">    <span class="keyword">with</span> gzip.<span class="built_in">open</span>(image_filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> img_f:</span><br><span class="line">        img_f.read(<span class="number">4</span>) <span class="comment">#skip magic number</span></span><br><span class="line">        num_images = <span class="built_in">int</span>.from_bytes(img_f.read(<span class="number">4</span>), <span class="string">&#x27;big&#x27;</span>) <span class="comment"># stored by high(big) endian</span></span><br><span class="line">        rows = <span class="built_in">int</span>.from_bytes(img_f.read(<span class="number">4</span>), <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        cols = <span class="built_in">int</span>.from_bytes(img_f.read(<span class="number">4</span>), <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        image_data = img_f.read(num_images * rows * cols)</span><br><span class="line">        X = np.frombuffer(image_data, dtype=np.uint8).astype(np.float32)</span><br><span class="line">        X = X.reshape(num_images, rows, cols, <span class="number">1</span>) <span class="comment">#(sample_numbles, H, W, C)</span></span><br><span class="line">        X /= <span class="number">255.0</span> <span class="comment"># normalize to [0,1]</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">with</span> gzip.<span class="built_in">open</span>(label_filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> lb_f:</span><br><span class="line">        lb_f.read(<span class="number">4</span>)</span><br><span class="line">        num_labels = <span class="built_in">int</span>.from_bytes(lb_f.read(<span class="number">4</span>), <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        lable_data = lb_f.read(num_labels)</span><br><span class="line">        y = np.frombuffer(lable_data, dtype=np.uint8)</span><br><span class="line">    <span class="keyword">return</span> X, y</span><br></pre></td></tr></table></figure><h3 id="Dataloader"><a href="#Dataloader" class="headerlink" title="Dataloader"></a>Dataloader</h3><p>ç»™å®šDatasetï¼Œå°†æ•°æ®æŒ‰batch_sizeè¿›è¡Œåˆ†æ‰¹ï¼Œå¹¶é€šè¿‡iterå’Œnextå®ç°è¿­ä»£ã€‚æ¯æ¬¡è®­ç»ƒè¾“å…¥ä¸€æ‰¹æ•°æ®ã€‚éœ€è¦æ³¨æ„ä¸€ä¸ªå‘ï¼šshuffleè¡¨ç¤ºæ•°æ®é›†ä¸­çš„sampleæ˜¯å¦éœ€è¦æ‰“ä¹±ã€‚å¼€å§‹æ—¶æˆ‘ç›´æ¥åœ¨init()å‡½æ•°ä¸­åˆ¤æ–­ï¼Œå¦‚æœä¸ºtrueï¼Œç›´æ¥åšæ•°æ®çš„æ‰“ä¹±ï¼Œè€Œåœ¨iterå‡½æ•°ä¸­ç›´æ¥<code>return self</code>ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> self.shuffle:</span><br><span class="line">self.ordering = np.array_split(np.arange(<span class="built_in">len</span>(dataset)), </span><br><span class="line">                                           <span class="built_in">range</span>(batch_size, <span class="built_in">len</span>(dataset), batch_size))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">self.ordering = np.array_split(np.random.permutation(<span class="built_in">len</span>(self.dataset)), </span><br><span class="line">                                           <span class="built_in">range</span>(self.batch_size, <span class="built_in">len</span>(self.dataset), self.batch_size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">return</span> self</span><br></pre></td></tr></table></figure><p>è€Œè¿™ä¹ˆåšçš„é—®é¢˜æ˜¯ï¼Œä¸€æ—¦åœ¨initä¸­æ‰“ä¹±ï¼Œé‚£ä¹ˆå½“åšå¤šepochçš„è®­ç»ƒæ—¶ï¼Œå¯¹äºä¸åŒçš„epochæ¥è¯´ï¼Œå…¶orderingä¸­çš„minibatchæ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºåªæ‰“ä¹±äº†ä¸€æ¬¡ã€‚</p><p>å› æ­¤ä¸èƒ½å†initä¸­æ‰“ä¹±ï¼Œè€Œéœ€è¦åœ¨iterä¸­æ‰“ä¹±ã€‚è¿™æ ·åœ¨æ¯ä¸ªepochä¸­ï¼Œå¯¹minibatchçš„è¿­ä»£å¼€å§‹æ—¶è°ƒç”¨ä¸€æ¬¡iterï¼Œåˆ°ä¸‹ä¸€ä¸ªepochæ—¶ï¼Œå¯¹minibatchè¿­ä»£ä¼šå†æ¬¡è°ƒç”¨iterï¼Œä¿è¯ä¸åŒepochä¸­minibatchéƒ½ä¸åŒ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoader</span>:</span><br><span class="line">    <span class="string">r&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Data loader. Combines a dataset and a sampler, and provides an iterable over</span></span><br><span class="line"><span class="string">    the given dataset.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        dataset (Dataset): dataset from which to load the data.</span></span><br><span class="line"><span class="string">        batch_size (int, optional): how many samples per batch to load</span></span><br><span class="line"><span class="string">            (default: ``1``).</span></span><br><span class="line"><span class="string">        shuffle (bool, optional): set to ``True`` to have the data reshuffled</span></span><br><span class="line"><span class="string">            at every epoch (default: ``False``).</span></span><br><span class="line"><span class="string">     &quot;&quot;&quot;</span></span><br><span class="line">    dataset: Dataset</span><br><span class="line">    batch_size: <span class="type">Optional</span>[<span class="built_in">int</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        dataset: Dataset,</span></span><br><span class="line"><span class="params">        batch_size: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">1</span>,</span></span><br><span class="line"><span class="params">        shuffle: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line"></span><br><span class="line">        self.dataset = dataset</span><br><span class="line">        self.shuffle = shuffle</span><br><span class="line">        self.batch_size = batch_size</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.shuffle:</span><br><span class="line">            self.ordering = np.array_split(np.arange(<span class="built_in">len</span>(dataset)), </span><br><span class="line">                                           <span class="built_in">range</span>(batch_size, <span class="built_in">len</span>(dataset), batch_size))</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self.shuffle:</span><br><span class="line">            self.ordering = np.array_split(np.random.permutation(<span class="built_in">len</span>(self.dataset)), </span><br><span class="line">                                           <span class="built_in">range</span>(self.batch_size, <span class="built_in">len</span>(self.dataset), self.batch_size))</span><br><span class="line">        self.idx = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__next__</span>(<span class="params">self</span>):</span><br><span class="line">        self.idx += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> self.idx &gt;= <span class="built_in">len</span>(self.ordering):</span><br><span class="line">            self.idx = -<span class="number">1</span></span><br><span class="line">            <span class="keyword">raise</span> StopIteration()</span><br><span class="line">        samples = self.dataset[self.ordering[self.idx]]</span><br><span class="line">        samples = [Tensor(s) <span class="keyword">for</span> s <span class="keyword">in</span> samples]</span><br><span class="line">        <span class="keyword">return</span> samples</span><br></pre></td></tr></table></figure><h2 id="Question-5"><a href="#Question-5" class="headerlink" title="Question 5"></a>Question 5</h2><h3 id="ResidualBlock"><a href="#ResidualBlock" class="headerlink" title="ResidualBlock"></a>ResidualBlock</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ResidualBlock</span>(<span class="params">dim, hidden_dim, norm=nn.BatchNorm1d, drop_prob=<span class="number">0.1</span></span>):</span><br><span class="line">    main = nn.Sequential(</span><br><span class="line">        nn.Linear(dim, hidden_dim),</span><br><span class="line">        norm(hidden_dim),</span><br><span class="line">        nn.ReLU(),</span><br><span class="line">        nn.Dropout(drop_prob),</span><br><span class="line">        nn.Linear(hidden_dim, dim),</span><br><span class="line">        norm(dim),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> nn.Sequential(nn.Residual(main), nn.ReLU())</span><br></pre></td></tr></table></figure><h3 id="MLPResNet"><a href="#MLPResNet" class="headerlink" title="MLPResNet"></a>MLPResNet</h3><p>ä½œä¸šçš„å›¾ä¸­æ˜¯æ²¡ç”¨Flattençš„ï¼Œä½†æ˜¯è¾“å…¥çš„Xçš„dimæ˜¯(batch_size, H, W, C), è€Œç¬¬ä¸€ä¸ªWçš„ç»´åº¦æ˜¯(dim, hidden_dim),è¿™é‡Œçš„dim&#x3D;H* W* 1ã€‚å› æ­¤è¦ç»™Xè¿›è¡ŒFlatten</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">MLPResNet</span>(<span class="params"></span></span><br><span class="line"><span class="params">    dim,</span></span><br><span class="line"><span class="params">    hidden_dim=<span class="number">100</span>,</span></span><br><span class="line"><span class="params">    num_blocks=<span class="number">3</span>,</span></span><br><span class="line"><span class="params">    num_classes=<span class="number">10</span>,</span></span><br><span class="line"><span class="params">    norm=nn.BatchNorm1d,</span></span><br><span class="line"><span class="params">    drop_prob=<span class="number">0.1</span>,</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    layers = []</span><br><span class="line">    layers.append(nn.Flatten())</span><br><span class="line">    layers.append(nn.Linear(dim, hidden_dim))</span><br><span class="line">    layers.append(nn.ReLU())</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_blocks):</span><br><span class="line">        layers.append(ResidualBlock(hidden_dim, hidden_dim // <span class="number">2</span>, norm, drop_prob))</span><br><span class="line">    layers.append(nn.Linear(hidden_dim, num_classes))</span><br><span class="line">    <span class="keyword">return</span> nn.Sequential(*layers)</span><br></pre></td></tr></table></figure><h3 id="Epoch"><a href="#Epoch" class="headerlink" title="Epoch"></a>Epoch</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">epoch</span>(<span class="params">dataloader, model, opt=<span class="literal">None</span></span>): <span class="comment"># optæ˜¯ä¼˜åŒ–å™¨ï¼Œå¦‚SGDï¼Œ Adam</span></span><br><span class="line">    np.random.seed(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">if</span> opt <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        model.<span class="built_in">eval</span>()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        model.train()</span><br><span class="line">    loss_fuc = nn.SoftmaxLoss()</span><br><span class="line">    acc_num = <span class="number">0</span></span><br><span class="line">    losses = []</span><br><span class="line">    <span class="keyword">for</span> X, y <span class="keyword">in</span> dataloader:</span><br><span class="line">        out = model(X)</span><br><span class="line">        loss = loss_fuc(out, y)</span><br><span class="line">        <span class="keyword">if</span> opt <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            loss.backward() <span class="comment">#è®¡ç®—èŠ‚ç‚¹æ¢¯åº¦</span></span><br><span class="line">            opt.step() <span class="comment">#æƒé‡æ›´æ–°</span></span><br><span class="line">            </span><br><span class="line">        losses.append(loss.numpy())</span><br><span class="line">        acc_num += (out.numpy().argmax(axis=<span class="number">1</span>) == y.numpy()).<span class="built_in">sum</span>()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - acc_num / <span class="built_in">len</span>(dataloader.dataset), np.mean(losses)</span><br></pre></td></tr></table></figure><h3 id="Train-Mnist"><a href="#Train-Mnist" class="headerlink" title="Train Mnist"></a>Train Mnist</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">train_mnist</span>(<span class="params"></span></span><br><span class="line"><span class="params">    batch_size=<span class="number">100</span>,</span></span><br><span class="line"><span class="params">    epochs=<span class="number">10</span>,</span></span><br><span class="line"><span class="params">    optimizer=ndl.optim.Adam,</span></span><br><span class="line"><span class="params">    lr=<span class="number">0.001</span>,</span></span><br><span class="line"><span class="params">    weight_decay=<span class="number">0.001</span>,</span></span><br><span class="line"><span class="params">    hidden_dim=<span class="number">100</span>,</span></span><br><span class="line"><span class="params">    data_dir=<span class="string">&quot;data&quot;</span>,</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    np.random.seed(<span class="number">4</span>)</span><br><span class="line">    <span class="comment">#  Initialize tranning dataloader</span></span><br><span class="line">    trainning_dataset = ndl.data.MNISTDataset(</span><br><span class="line">        os.path.join(data_dir, <span class="string">&quot;train-images-idx3-ubyte.gz&quot;</span>),</span><br><span class="line">        os.path.join(data_dir, <span class="string">&quot;train-labels-idx1-ubyte.gz&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">    trainning_data_loader = ndl.data.DataLoader(trainning_dataset, batch_size, shuffle=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment">#  Initialize test dataloader</span></span><br><span class="line">    test_dataset = ndl.data.MNISTDataset(</span><br><span class="line">        os.path.join(data_dir, <span class="string">&quot;t10k-images-idx3-ubyte.gz&quot;</span>),</span><br><span class="line">        os.path.join(data_dir, <span class="string">&quot;t10k-labels-idx1-ubyte.gz&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">    test_data_loader = ndl.data.DataLoader(test_dataset, batch_size)</span><br><span class="line"></span><br><span class="line">    shape = test_data_loader.dataset.images.shape</span><br><span class="line">    dim = shape[<span class="number">1</span>] * shape[<span class="number">2</span>]</span><br><span class="line">    <span class="built_in">print</span>(dim)</span><br><span class="line">    model = MLPResNet(dim=dim, hidden_dim=hidden_dim)</span><br><span class="line"></span><br><span class="line">    opt = optimizer(model.parameters(), lr=lr, weight_decay=weight_decay)</span><br><span class="line"></span><br><span class="line">    train_err,train_loss = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    test_err,test_loss = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(epochs):</span><br><span class="line">        train_err, train_loss = epoch(trainning_data_loader, model, opt)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Epoch %d: Train err: %f, Train loss: %f&quot;</span> % (</span><br><span class="line">            i, train_err, train_loss</span><br><span class="line">        ))</span><br><span class="line">    test_err, test_loss = epoch(test_data_loader, model)</span><br><span class="line">    <span class="keyword">return</span> train_err, train_loss, test_err, test_loss</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> cmu10-414 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>cmu10-414é˜¶æ®µæ€§æ€»ç»“20</title>
      <link href="/2024/07/22/cmu10-414%E9%98%B6%E6%AE%B5%E6%80%A7%E6%80%BB%E7%BB%93/"/>
      <url>/2024/07/22/cmu10-414%E9%98%B6%E6%AE%B5%E6%80%A7%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h1 id="cmu10-414çŸ¥è¯†ç‚¹æ€»ç»“-HW2"><a href="#cmu10-414çŸ¥è¯†ç‚¹æ€»ç»“-HW2" class="headerlink" title="cmu10-414çŸ¥è¯†ç‚¹æ€»ç»“(HW2)"></a>cmu10-414çŸ¥è¯†ç‚¹æ€»ç»“(HW2)</h1><h2 id="é‡è¦ä»£ç å—"><a href="#é‡è¦ä»£ç å—" class="headerlink" title="é‡è¦ä»£ç å—"></a>é‡è¦ä»£ç å—</h2><p>HW2åˆ†æ”¯çš„ä»£ç ç»“æ„å¦‚ä¸‹</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202407221551271.png" alt="image-20240722155125198"></p><h3 id="inin-py"><a href="#inin-py" class="headerlink" title="inin.py"></a><strong>inin</strong>.py</h3><p><code>__inin__.py</code>ä¸­å®šä¹‰<strong>needleå¯¹å¤–æš´éœ²çš„æ¨¡å—ã€ç±»ã€å‡½æ•°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">from . import ops</span><br><span class="line">from .ops import *</span><br><span class="line">from .autograd import Tensor, cpu, all_devices</span><br><span class="line"></span><br><span class="line">from . import init</span><br><span class="line">from .init import ones, zeros, zeros_like, ones_like</span><br><span class="line"></span><br><span class="line">from . import data</span><br><span class="line">from . import nn</span><br><span class="line">from . import optim</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€äºŒè¡Œå«ä¹‰ï¼Œå¯ä»¥é€šè¿‡needle.ops.summationæˆ–è€…needle.summationè°ƒç”¨summationå‡½æ•°</p><h3 id="optim-py"><a href="#optim-py" class="headerlink" title="optim.py"></a>optim.py</h3><p>å®šä¹‰äº†ä¸€äº›å¾…å®ç°çš„ä¼˜åŒ–å™¨</p><h3 id="autograd-py"><a href="#autograd-py" class="headerlink" title="autograd.py"></a>autograd.py</h3><p>å®šä¹‰äº†Opã€Valueã€Tensoræ ¸å¿ƒæ•°æ®ç»“æ„</p><p>å¯¹äºTensorOpï¼Œå®ƒç»§æ‰¿äº†Opï¼Œæœ‰3ä¸ªé‡è¦å‡½æ•°(å±æ€§)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">compute</span>(<span class="params">self, *args: <span class="type">Tuple</span>[NDArray]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Calculate forward pass of operator.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Parameters</span></span><br><span class="line"><span class="string">        ----------</span></span><br><span class="line"><span class="string">        input: np.ndarray</span></span><br><span class="line"><span class="string">            A list of input arrays to the function</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns</span></span><br><span class="line"><span class="string">        -------</span></span><br><span class="line"><span class="string">        output: nd.array</span></span><br><span class="line"><span class="string">            Array output of the operation</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br></pre></td></tr></table></figure><p>è¾“å…¥è¾“å‡ºéƒ½æ˜¯array</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">gradient</span>(<span class="params"></span></span><br><span class="line"><span class="params">    self, out_grad: <span class="string">&quot;Value&quot;</span>, node: <span class="string">&quot;Value&quot;</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="type">Union</span>[<span class="string">&quot;Value&quot;</span>, <span class="type">Tuple</span>[<span class="string">&quot;Value&quot;</span>]]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Compute partial adjoint for each input value for a given output adjoint.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters</span></span><br><span class="line"><span class="string">    ----------</span></span><br><span class="line"><span class="string">    out_grad: Value</span></span><br><span class="line"><span class="string">        The adjoint wrt to the output value.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    node: Value</span></span><br><span class="line"><span class="string">        The value node of forward evaluation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns</span></span><br><span class="line"><span class="string">    -------</span></span><br><span class="line"><span class="string">    input_grads: Value or Tuple[Value]</span></span><br><span class="line"><span class="string">        A list containing partial gradient adjoints to be propagated to</span></span><br><span class="line"><span class="string">        each of the input node.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>è¾“å…¥è¾“å‡ºå®é™…éƒ½æ˜¯Tensorã€‚è®¡ç®—è¿™ä¸ªopå¯¹inputçš„åå¯¼æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, *args</span>):</span><br><span class="line">    <span class="comment"># print(self)</span></span><br><span class="line">    <span class="keyword">return</span> Tensor.make_from_op(self, args)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">make_from_op</span>(<span class="params">op: Op, inputs: <span class="type">List</span>[<span class="string">&quot;Value&quot;</span>]</span>):</span><br><span class="line">    <span class="comment"># print(op)</span></span><br><span class="line">    <span class="comment"># print(inputs)</span></span><br><span class="line">    tensor = Tensor.__new__(Tensor)</span><br><span class="line">    tensor._init(op, inputs)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> LAZY_MODE:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> tensor.requires_grad:</span><br><span class="line">            <span class="keyword">return</span> tensor.detach()</span><br><span class="line">        tensor.realize_cached_data()</span><br><span class="line">    <span class="keyword">return</span> tensor</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">realize_cached_data</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Run compute to realize the cached data&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># avoid recomputation</span></span><br><span class="line">    <span class="keyword">if</span> self.cached_data <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> self.cached_data</span><br><span class="line">    <span class="comment"># note: data implicitly calls realized cached data</span></span><br><span class="line">    <span class="comment"># op.computeçš„è¾“å…¥è¾“å‡ºéƒ½æ˜¯NDarrayç±»å‹</span></span><br><span class="line">    self.cached_data = self.op.compute(</span><br><span class="line">        *[x.realize_cached_data() <span class="keyword">for</span> x <span class="keyword">in</span> self.inputs]</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> self.cached_data</span><br></pre></td></tr></table></figure><p><code>__call__</code>å‡½æ•°å¯ä»¥å°†ä¸€ä¸ªå¯¹è±¡å½“æˆä¸€ä¸ªå‡½æ•°ä½¿ç”¨ï¼Œå½“ä½¿ç”¨â€œsummationâ€è®¡ç®—aæŸäº›ç»´åº¦ä¸Šçš„å’Œæ—¶ï¼Œ</p><p>å…ˆé€šè¿‡<code>Summation(axes)(a)</code>åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¼ å…¥å‚æ•°aã€‚æ­¤æ—¶å°†å¯¹è±¡å½“ä½œå‡½æ•°ä½¿ç”¨ï¼Œè°ƒç”¨<code>__call__</code>ã€‚åœ¨<code>make_from_op</code>ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„tensorï¼Œå¹¶å°†å…¶opå’Œinputè®¾ç½®ä¸ºSummationå’Œaã€‚é€šè¿‡<code>realize_cached_data()</code>ä¸­è°ƒç”¨op.compute()æ¥è®¡ç®—å…¶<code>cached_data</code></p><p>å¯¹äºValueç±»ï¼Œå…³æ³¨å…¶å±æ€§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Value</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;A value in the computational graph.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># trace of computational graph</span></span><br><span class="line">    op: <span class="type">Optional</span>[Op]</span><br><span class="line">    inputs: <span class="type">List</span>[<span class="string">&quot;Value&quot;</span>]</span><br><span class="line">    <span class="comment"># The following fields are cached fields for</span></span><br><span class="line">    <span class="comment"># dynamic computation</span></span><br><span class="line">    cached_data: NDArray</span><br><span class="line">    requires_grad: <span class="built_in">bool</span></span><br></pre></td></tr></table></figure><p><code>inputs</code>æ˜¯è®¡ç®—èŠ‚ç‚¹çš„è¾“å…¥ï¼Œæœ€å¤šæ˜¯2ä¸ª</p><p><code>cached_data</code>æ˜¯è¿™ä¸ªè®¡ç®—èŠ‚ç‚¹å°†<code>inputs</code>é€šè¿‡<code>op</code>è®¡ç®—åçš„ç»“æœ</p><p><code>requires_grad</code>æ˜¯å¦éœ€è¦æ¢¯åº¦ï¼Œå› ä¸ºå¸¸æ•°å€¼ä¸éœ€è¦è®¡ç®—æ¢¯åº¦</p><p>å¯¹äºTensorç±»ï¼Œæ–°å¢äº†<code>grad: &quot;Tensor&quot;</code>å±æ€§(æ³¨æ„æ¢¯åº¦ä¹Ÿæ˜¯Tensorç±»å‹)ï¼Œå…³æ³¨å…¶å‡½æ•°</p><p>é¦–å…ˆæ˜¯<code>__init__()</code>ï¼Œå½“ä½¿ç”¨<code>Tensor([2,3,4])</code>åˆå§‹åŒ–æ—¶è°ƒç”¨è¯¥å‡½æ•°ã€‚<code>make_from_op()</code>çš„ç”¨æ³•ä¸Šæ–‡è¯´è¿‡ã€‚</p><p>A.dataçš„ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªå’ŒAçš„<code>cached_data</code>ä¸€æ ·çš„Tensorï¼Œä½†æ˜¯ä¸å…·æœ‰Açš„opã€inputsç­‰è®¡ç®—å›¾ä¸­çš„å…³ç³»ï¼Œå³ç‹¬ç«‹äºAæ‰€åœ¨çš„è®¡ç®—å›¾ã€‚<code>@data.setter</code>çš„ä½œç”¨æ˜¯å½“è®¾ç½®ä¿®æ”¹dataçš„æ•°æ®æ—¶è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œç›´æ¥å°†<code>A.cache_data</code>è®¾ç½®ä¸º<code>value.cache_data</code> ã€‚  </p><p>å³<code>A.data = A.data + B.data</code>çš„æµç¨‹æ˜¯ï¼š</p><ul><li>Aå’ŒBåˆ†åˆ«è°ƒç”¨detach()åˆ›å»ºä¸€ä¸ªä¸ä¹‹cached_dataä¸€è‡´çš„ç‹¬ç«‹äºè®¡ç®—å›¾çš„æ— æ¢¯åº¦Tensor</li><li>äºŒè€…ç›¸åŠ (Tensorç±»å¯¹ä¸€äº›åŸºæœ¬çš„è¿ç®—åšäº†é‡è½½ï¼Œåæ–‡è¯´æ˜)</li><li>å› ä¸ºè¿™é‡Œè¦ä¿®æ”¹dataçš„å€¼ï¼Œå› æ­¤è°ƒç”¨setterä¸‹çš„å‡½æ•°ï¼Œå°†Açš„cached_dataè®¾ç½®ä¸ºç›¸åŠ åçš„Tensorçš„cached_data</li></ul><p>è®¾ç½®è¿™æ ·çš„ä¸€ä¸ªå±æ€§çš„ç›®çš„æ˜¯ï¼š</p><blockquote><p>å‡å¦‚æˆ‘ä»¬è¦è®¡ç®—å¤šè½®è¿­ä»£ä¹‹åçš„ä¸€ä¸ªTensorçš„æ¢¯åº¦ã€‚åªè¦æœ€åçš„ç»“æœ</p><p>grad &#x3D; ndl.Tensor([1, 1, 1], dtype&#x3D;â€float32â€)</p><p>lr &#x3D; 0.1</p><p>for i in range(5):</p><p>â€‹w &#x3D; w + (-lr) * grad</p><p>ä¸Šè¾¹å†™æ³•ä¼šåœ¨å¤šè½®çš„â€+â€æ„å»ºä¸€ä¸ªè®¡ç®—å›¾ï¼Œå ç”¨å¾ˆå¤§å­˜å‚¨ç©ºé—´ï¼Œä½†æ˜¯æˆ‘ä»¬åªè¦æœ€åçš„ç»“æœã€‚</p><p>è€Œç”¨ä¸Šdataå±æ€§åï¼Œå¦‚ä¸‹çš„è®¡ç®—æ–¹å¼æ— éœ€åˆ›å»ºé¢å¤–çš„Tensor</p><p>for i in range(5):</p><p>â€‹w.data &#x3D; w.data + (-lr) * grad.data</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@property </span><span class="comment">#å°†æ–¹æ³•è½¬æ¢æˆå±æ€§ï¼Œé€šè¿‡.dataè¿”é—®</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">data</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">return</span> self.detach()</span><br><span class="line"></span><br><span class="line"><span class="meta">@data.setter</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">data</span>(<span class="params">self, value</span>):</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">isinstance</span>(value, Tensor)</span><br><span class="line">    <span class="keyword">assert</span> value.dtype == self.dtype, <span class="string">&quot;%s %s&quot;</span> % (</span><br><span class="line">        value.dtype,</span><br><span class="line">        self.dtype,</span><br><span class="line">    )</span><br><span class="line">    self.cached_data = value.realize_cached_data()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detach</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Create a new tensor that shares the data but detaches from the graph.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> Tensor.make_const(self.realize_cached_data())</span><br><span class="line"></span><br><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_const</span>(<span class="params">data, requires_grad=<span class="literal">False</span></span>): </span><br><span class="line">    tensor = Tensor.__new__(Tensor)</span><br><span class="line">    tensor._init(</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">        [],</span><br><span class="line">        cached_data=data</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(data, Tensor)</span><br><span class="line">        <span class="keyword">else</span> data.realize_cached_data(),</span><br><span class="line">        requires_grad=requires_grad,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> tensor</span><br></pre></td></tr></table></figure><p>å½“è¦è¿›è¡Œåå‘ä¼ æ’­æ—¶ï¼Œé€šè¿‡backwardå‡½æ•°è®¡ç®—<strong>è®¡ç®—å›¾</strong>ä¸­èŠ‚ç‚¹æ¢¯åº¦ã€‚ä½¿ç”¨æ–¹å¼A.backward()ã€‚</p><p>åœ¨backwardä¸­è°ƒç”¨<code>compute_gradient_of_variables()</code>å‡½æ•°ï¼Œå…ˆé€šè¿‡<code>find_topo_sort()</code>ä½¿ç”¨æ‹“æ‰‘æ’åºè®¡ç®—ç”±output_tensorç»“æŸçš„è®¡ç®—å›¾çš„æ‹“æ‰‘æ’åºç»“æœï¼Œè¿›è¡Œreversedçš„ç›®çš„æ˜¯æˆ‘ä»¬è®¡ç®—æ¢¯åº¦çš„è¿‡ç¨‹æ˜¯ä»åå¾€å‰ç®—çš„</p><h3 id="ops-ops-mathematic-py"><a href="#ops-ops-mathematic-py" class="headerlink" title="ops-&gt;ops_mathematic.py"></a>ops-&gt;ops_mathematic.py</h3><p>å®ç°äº†ä¸€äº›ç®—å­ç±»çš„å‰å‘è®¡ç®—ä¸æ¢¯åº¦è®¡ç®—ï¼Œç»§æ‰¿è‡ªTensorOp</p><h3 id="ops-ops-logarithmatic-py"><a href="#ops-ops-logarithmatic-py" class="headerlink" title="ops-&gt;ops_logarithmatic.py"></a>ops-&gt;ops_logarithmatic.py</h3><h3 id="init-init-initializers-py"><a href="#init-init-initializers-py" class="headerlink" title="init-&gt;init_initializers.py"></a>init-&gt;init_initializers.py</h3><p>å®šä¹‰äº†å‡ ä¸ªæƒé‡çš„åˆå§‹åŒ–ç±»ï¼Œç”¨äºåˆå§‹åŒ–æƒé‡</p><h2 id="å½’ä¸€åŒ–-Normalization-ä¸æ­£åˆ™åŒ–-Regularization"><a href="#å½’ä¸€åŒ–-Normalization-ä¸æ­£åˆ™åŒ–-Regularization" class="headerlink" title="å½’ä¸€åŒ–(Normalization)ä¸æ­£åˆ™åŒ–(Regularization)"></a>å½’ä¸€åŒ–(Normalization)ä¸æ­£åˆ™åŒ–(Regularization)</h2><p>å½’ä¸€åŒ–æ˜¯ç‰¹å¾ç¼©æ”¾çš„ä¸€ç§å½¢å¼ï¼Œæ˜¯æŠŠæ•°æ®å‹ç¼©åˆ°ä¸€ä¸ªåŒºé—´å†…ï¼Œæ¯”å¦‚[0,1]ã€‚æœ¬èŠ‚æœ‰BatchNormå’ŒLayerNormã€‚</p><p>æ­£åˆ™åŒ–æ˜¯ä¸ºäº†è§£å†³è¿‡æ‹Ÿåˆé—®é¢˜ã€‚æœ‰L2æ­£åˆ™åŒ–å’ŒL1æ­£åˆ™åŒ–ã€‚æƒé‡çš„å¤§å°ä¼šå½±å“è®­ç»ƒçš„å¤æ‚æ€§ã€‚å› æ­¤å¯ä»¥ï¼Œä½¿å¤§çš„æƒé‡å°ä¸€ç‚¹ã€‚</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202407241705501.png" alt="image-20240724170512416"></p><p>å¦‚å›¾L2æ­£åˆ™åŒ–ä¿®æ”¹ä¼˜åŒ–çš„ç›®æ ‡å‡½æ•°ï¼Œä½¿åœ¨è®¡ç®—æ¢¯åº¦å‰å…ˆå°†æƒé‡è¿›è¡Œæ”¶ç¼©</p>]]></content>
      
      
      <categories>
          
          <category> cmu10-414 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨qemuè¿è¡Œå†…æ ¸å¹¶ä½¿ç”¨Redis-benchmarkæµ‹è¯•è¿ç§»</title>
      <link href="/2024/01/07/%E4%BD%BF%E7%94%A8qemu%E8%BF%90%E8%A1%8C%E5%86%85%E6%A0%B8%E5%B9%B6%E4%BD%BF%E7%94%A8Redis-benchmark%E6%B5%8B%E8%AF%95%E8%BF%81%E7%A7%BB/"/>
      <url>/2024/01/07/%E4%BD%BF%E7%94%A8qemu%E8%BF%90%E8%A1%8C%E5%86%85%E6%A0%B8%E5%B9%B6%E4%BD%BF%E7%94%A8Redis-benchmark%E6%B5%8B%E8%AF%95%E8%BF%81%E7%A7%BB/</url>
      
        <content type="html"><![CDATA[<h1 id="ä½¿ç”¨qemuè¿è¡Œå†…æ ¸å¹¶ä½¿ç”¨Redis-benchmarkæµ‹è¯•è¿ç§»"><a href="#ä½¿ç”¨qemuè¿è¡Œå†…æ ¸å¹¶ä½¿ç”¨Redis-benchmarkæµ‹è¯•è¿ç§»" class="headerlink" title="ä½¿ç”¨qemuè¿è¡Œå†…æ ¸å¹¶ä½¿ç”¨Redis-benchmarkæµ‹è¯•è¿ç§»"></a>ä½¿ç”¨qemuè¿è¡Œå†…æ ¸å¹¶ä½¿ç”¨Redis-benchmarkæµ‹è¯•è¿ç§»</h1><p>å‰æƒ…æè¦ï¼šæœ¬æ¥åœ¨å®ä½“æœºä¸Šæƒ³è¿›è¡Œæµ‹è¯•ç¨‹åºæ£€éªŒNUMAèŠ‚ç‚¹é—´çš„è¿ç§»ï¼Œå› ä¸ºCPUå‹å·é—®é¢˜æ— æ³•å¼€å¯NUMAï¼ˆåªæœ‰ä¸€ä¸ªNUMAèŠ‚ç‚¹ï¼‰ã€‚é‚é‡‡ç”¨å¸ˆå…„çš„æ–¹æ³•ï¼šä½¿ç”¨qemuè™šæ‹Ÿæœºæ¥è¿è¡Œå†…æ ¸ã€‚</p><p>ä¸‹è¾¹ç»™å‡ºé…ç½®è¿‡ç¨‹</p><h2 id="ç¼–è¯‘å†…æ ¸é•œåƒ"><a href="#ç¼–è¯‘å†…æ ¸é•œåƒ" class="headerlink" title="ç¼–è¯‘å†…æ ¸é•œåƒ"></a>ç¼–è¯‘å†…æ ¸é•œåƒ</h2><p>1ã€å…ˆæå‰å®‰è£…ä¸€äº›åŒ…</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt upgrade</span><br><span class="line">sudo apt-get install git fakeroot build-essential ncurses-dev xz-utils libssl-dev bc flex libelf-dev bison</span><br></pre></td></tr></table></figure><p>2ã€ä¸‹è½½kernel</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone è‡ªå·±çš„kernelåœ°å€</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make menuconfg</span><br></pre></td></tr></table></figure><p>3ã€ä¿®æ”¹.config</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim ./.config</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†ä¸‹è¾¹ä¸¤è¡Œæ³¨é‡Š</span></span><br><span class="line">CONFIG_DEBUG_INFO=y  </span><br><span class="line">CONFIG_DEBUG_INFO_BTF=y</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†ä¸‹è¾¹ä¸€è¡Œå¼•å·å†…æ”¹ä¸ºç©º</span></span><br><span class="line">CONFIG_SYSTEM_TRUSTED_KEYS=&quot;debian/canonical-certs.pem&quot;</span><br><span class="line">CONFIG_SYSTEM_REVOCATION_KEYS=&quot;debian/canonical-revoked-certs.pem&quot;</span><br></pre></td></tr></table></figure><p>4ã€ç¼–è¯‘</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j 32</span><br></pre></td></tr></table></figure><p>5ã€å®‰è£…qemu</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install qemu-system-x86</span><br></pre></td></tr></table></figure><h2 id="åŸºäºubuntu-baseæ„å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿ"><a href="#åŸºäºubuntu-baseæ„å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="åŸºäºubuntu baseæ„å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿ"></a>åŸºäºubuntu baseæ„å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿ</h2><p>ä¹‹å‰ä½¿ç”¨busyboxä¼šå¯¼è‡´å…¶ä¸­æ²¡æœ‰æˆ‘ä»¬éœ€è¦çš„bashæŒ‡ä»¤ï¼Œéšä½¿ç”¨ubuntu base</p><p>1ã€ä¸‹è½½ubuntu base</p><p>å»æ¸…åé•œåƒæºæˆ–è€…<a href="https://cdimage.ubuntu.com/ubuntu-base/releases/">ubuntuå®˜ç½‘</a>ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯22.04ä¸‹çš„<code>ubuntu-base-23.04-base-amd64.tar.gz</code>ï¼ˆå› ä¸ºæˆ‘çš„ubuntuç³»ç»Ÿæ˜¯22.04ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/download</span><br><span class="line">wget https://cdimage.ubuntu.com/ubuntu-base/releases/23.04/release/ubuntu-base-23.04-base-amd64.tar.gz</span><br></pre></td></tr></table></figure><p>2ã€åˆ›å»ºimageé•œåƒï¼ˆæ­¤å¤„èµ·åä¸ºubuntu_rootfs.ext4ï¼‰</p><p>ä¸‹é¢ç»™å‡ºæˆ‘çš„æ–¹æ³•ï¼Œåœ¨downloadç›®å½•ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/zero of=ubuntu_rootfs.ext4 bs=1G count=30 # åˆ›å»º30Gå®¹é‡çš„é•œåƒæ–‡ä»¶</span><br><span class="line">mkfs.ext4 ubuntu_rootfs.ext4  #æ ¼å¼åŒ–ä¸ºext4çš„æ–‡ä»¶ç³»ç»Ÿ</span><br></pre></td></tr></table></figure><p>3ã€åˆ›å»ºç›®å½•ä½œä¸ºé•œåƒæ–‡ä»¶çš„æŒ‚è½½ç‚¹ï¼Œå°†é•œåƒæ–‡ä»¶æŒ‚åœ¨ä¸Šå»</p><p>åœ¨downloadç›®å½•ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir rootfs</span><br><span class="line">sudo mount ubuntu_rootfs.ext4 rootfs/</span><br></pre></td></tr></table></figure><p>4ã€å°†ubuntu baseè§£å‹åˆ°rootfsä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -zxvf  ubuntu-base-22.04-base-amd64.tar.gz -C rootfs</span><br></pre></td></tr></table></figure><p>5ã€æ‹·è´ä¸»æœºä¸­çš„ç½‘ç»œé…ç½®ä¿¡æ¯åˆ°é•œåƒä¸­ï¼Œæ–¹ä¾¿åç»­ç”¨aptå®‰è£…è½¯ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/resolv.conf rootfs/etc</span><br></pre></td></tr></table></figure><p>6ã€åˆ›å»º<code>mount.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mnt() &#123;</span><br><span class="line">echo &quot;MOUNTING&quot;</span><br><span class="line">sudo mount -t proc /proc $&#123;2&#125;proc</span><br><span class="line">sudo mount -t sysfs /sys $&#123;2&#125;sys</span><br><span class="line">sudo mount -o bind /dev $&#123;2&#125;dev</span><br><span class="line">sudo mount -o bind /dev/pts $&#123;2&#125;dev/pts</span><br><span class="line">sudo chroot $&#123;2&#125;</span><br><span class="line">&#125;</span><br><span class="line">umnt() &#123;</span><br><span class="line">echo &quot;UNMOUNTING&quot;</span><br><span class="line">sudo umount $&#123;2&#125;proc</span><br><span class="line">sudo umount $&#123;2&#125;sys</span><br><span class="line">sudo umount $&#123;2&#125;dev/pts</span><br><span class="line">sudo umount $&#123;2&#125;dev</span><br><span class="line">sudo umount $&#123;2&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [ &quot;$1&quot; == &quot;-m&quot; ] &amp;&amp; [ -n &quot;$2&quot; ] ;</span><br><span class="line">then</span><br><span class="line">mnt $1 $2</span><br><span class="line">elif [ &quot;$1&quot; == &quot;-u&quot; ] &amp;&amp; [ -n &quot;$2&quot; ];</span><br><span class="line">then</span><br><span class="line">umnt $1 $2</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>7ã€æ‰§è¡ŒæŒ‚è½½ä»»åŠ¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mount.sh -m rootfs/</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„æŒ‡ä»¤<code>chroot</code>å°†<code>rootfs</code>æš‚æ—¶è®¾ç½®ä¸ºæ ¹ç›®å½•ï¼Œå¹¶å¯åŠ¨ç»ˆç«¯ã€‚</p><p>8ã€å®‰è£…å¿…è¦çš„è½¯ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apt update &amp;&amp; apt upgrade</span><br><span class="line">apt install git vim init linux-image-kvm ......</span><br><span class="line">apt install redis-server   #å®‰è£…redisæœåŠ¡å™¨</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£…redis-benchmark</span></span><br><span class="line">wget http://download.redis.io/releases/redis-6.0.9.tar.gz</span><br><span class="line">tar xzf redis-6.0.9.tar.gz</span><br><span class="line">cd redis-6.0.9/src</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">redis-benchmark --help #æ£€æµ‹æ˜¯å¦å®‰è£…æˆåŠŸ</span><br></pre></td></tr></table></figure><p>è¿™äº›è½¯ä»¶éƒ½å°†ä¼šå®‰è£…åˆ°ubuntu_rootfs.ext4é•œåƒä¸­</p><p>9ã€è®¾ç½®å¯†ç ç­‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">update-initramfs -u</span><br><span class="line">echo root:root | chpasswd</span><br><span class="line">echo ttyS0 &gt; /etc/securetty</span><br><span class="line">systemctl enable serial-getty@ttyS0.service</span><br></pre></td></tr></table></figure><p>10ã€é€€å‡ºå¸è½½é•œåƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mount.sh -u rootfs/</span><br></pre></td></tr></table></figure><p>æ­¤åæˆ‘ä»¬ä½¿ç”¨qemuå¯åŠ¨è¿™ä¸ªé•œåƒæ–‡ä»¶</p><p>ç‰¹æ®Šè¯´æ˜ï¼šæˆ‘ä»¬ä½¿ç”¨qemuå¯åŠ¨å†…æ ¸å’Œä¹‹åï¼Œåœ¨é‡Œè¾¹æ˜¯æ— æ³•ä¸‹è½½å®‰è£…ä¸œè¥¿çš„ï¼Œå› ä¸ºæ²¡æœ‰é…ç½®ç½‘ç»œè¿™äº›ã€‚å› æ­¤æ¯”å¦‚å½“æˆ‘ä»¬éœ€è¦å®‰è£…<code>redis</code>æ—¶ï¼Œéœ€è¦æ‰§è¡Œ7ã€8ã€10å³å¯</p><p>è¾“å…¥<code>exit</code>é€€å‡º<code>chroot</code></p><h2 id="ä½¿ç”¨qemuå¯åŠ¨"><a href="#ä½¿ç”¨qemuå¯åŠ¨" class="headerlink" title="ä½¿ç”¨qemuå¯åŠ¨"></a>ä½¿ç”¨qemuå¯åŠ¨</h2><p>1ã€é…ç½®å¯åŠ¨qemuçš„è„šæœ¬</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ubuntuBaseImage=&quot;/home/wufang/download/ubuntu_rootfs.ext4&quot;  </span><br><span class="line">kernelDir=.</span><br><span class="line"></span><br><span class="line">sudo qemu-system-x86_64 \</span><br><span class="line">    -enable-kvm\</span><br><span class="line">    -machine pc,nvdimm=on -s\</span><br><span class="line">    -m 2G,slots=4,maxmem=32G \</span><br><span class="line">    -nographic -kernel $kernelDir/vmlinux \</span><br><span class="line">    -smp cores=4,threads=1,sockets=2 \</span><br><span class="line">    -hda $ubuntuBaseImage \</span><br><span class="line">    -object memory-backend-ram,id=mem0,size=1G  \</span><br><span class="line">    -object memory-backend-ram,id=mem1,size=1G  \</span><br><span class="line">    -numa node,memdev=mem0,cpus=0-3,nodeid=0 \</span><br><span class="line">    -numa node,memdev=mem1,cpus=4-7,nodeid=1 \</span><br><span class="line">    -numa node,nodeid=2 -numa node,nodeid=3 \</span><br><span class="line">    -object memory-backend-ram,id=nvdimm1,size=4G\</span><br><span class="line">    -device nvdimm,memdev=nvdimm1,id=nv1,unarmed=off,node=2 \</span><br><span class="line">    -object memory-backend-ram,id=nvdimm2,size=4G\</span><br><span class="line">    -device nvdimm,memdev=nvdimm2,id=nv2,unarmed=off,node=3 \</span><br><span class="line">    -append &quot;console=ttyS0 crashkernel=712M root=/dev/sda rootfstype=ext4 rw loglevel=8&quot;\</span><br><span class="line">    -net nic -net tap,ifname=tap0,script=no,downscript=no</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2ã€å¯åŠ¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./my_config.sh</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨redis-benchmarkæµ‹è¯•"><a href="#ä½¿ç”¨redis-benchmarkæµ‹è¯•" class="headerlink" title="ä½¿ç”¨redis-benchmarkæµ‹è¯•"></a>ä½¿ç”¨redis-benchmarkæµ‹è¯•</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-benchmark -h 127.0.0.1 -p 6379  -n 10000000 -r 1000000 -c 200 -d 32 -t ping,set,get</span><br></pre></td></tr></table></figure><ul><li>-nï¼šæµ‹è¯•åŒ…æ•°é‡</li><li>-rï¼šéšæœºkeyæ•°é‡</li><li>-cï¼šå®¢æˆ·ç«¯è¿æ¥æ•°</li><li>-tï¼šæ‰§è¡Œå…·ä½“çš„æµ‹è¯•å‘½ä»¤åˆé›†</li></ul><p>ç»Ÿè®¡æ•°æ®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/vmstat | grep numa</span><br></pre></td></tr></table></figure><p>æŒ‡ä»¤ç»“æœå«ä¹‰ä¸ºå¦‚ä¸‹ï¼š</p><ul><li>numa_hitï¼šæˆåŠŸçš„æœ¬åœ°å†…å­˜è®¿é—®æ¬¡æ•°</li><li>numa_missï¼šè¡¨ç¤ºæ— æ³•ä»æœ¬åœ°èŠ‚ç‚¹è·å–é¡µé¢çš„å¤±è´¥æ¬¡æ•°ï¼Œéœ€è¦ä»å…¶å®ƒèŠ‚ç‚¹è·å–</li><li>numa_foreignï¼šè¡¨ç¤ºé¡µé¢åˆ†é…ç»™ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½†æ˜¯è¢«ä»å…¶å®ƒèŠ‚ç‚¹è®¿é—®çš„æ¬¡æ•°</li><li>numa_interleaveï¼šé€šè¿‡å†…å­˜äº¤é”™çš„æ–¹å¼åˆ†é…çš„é¡µé¢æ•°é‡</li></ul><p>ç¼–å†™è„šæœ¬æµ‹è¯•</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">STRS=(</span><br><span class="line">  &quot;numa_hit&quot;</span><br><span class="line">  &quot;numa_miss&quot;</span><br><span class="line">  &quot;numa_foreign&quot;</span><br><span class="line">  &quot;numa_interleave&quot;</span><br><span class="line">  &quot;numa_local&quot;</span><br><span class="line">  &quot;numa_other&quot;</span><br><span class="line">  &quot;numa_pte_updates&quot;</span><br><span class="line">  &quot;numa_huge_pte_updates&quot;</span><br><span class="line">  &quot;numa_hint_faults&quot;</span><br><span class="line">  &quot;numa_hint_faults_local&quot;</span><br><span class="line">  &quot;numa_pages_migrated&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">output_file=&quot;output.txt&quot; </span><br><span class="line"></span><br><span class="line">for ((epooch=1; epooch&lt;50; epooch++))</span><br><span class="line">do</span><br><span class="line"></span><br><span class="line">        declare -a PRE_VALUES</span><br><span class="line">        declare -a END_VALUES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        PRE_TEST=$(cat /proc/vmstat | grep numa)</span><br><span class="line">        IFS=$&#x27;\n&#x27; read -rd &#x27;&#x27; -a PRE_TEST_ARRAY &lt;&lt;&lt;&quot;$PRE_TEST&quot;</span><br><span class="line">        for key in &quot;$&#123;PRE_TEST_ARRAY[@]&#125;&quot;;</span><br><span class="line">        do</span><br><span class="line">                value=$(echo &quot;$key&quot; | awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">                PRE_VALUES+=(&quot;$value&quot;)</span><br><span class="line">        done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        redis-benchmark -h 127.0.0.1 -p 6379 -n 1000000 -r 200000 -c 10000 -d 32 -t ping,set,get &amp;</span><br><span class="line">        pid=$!</span><br><span class="line">        wait &quot;$pid&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        END_TEST=$(cat /proc/vmstat | grep numa)</span><br><span class="line">        IFS=$&#x27;\n&#x27; read -rd &#x27;&#x27; -a END_TEST_ARRAY &lt;&lt;&lt;&quot;$END_TEST&quot;</span><br><span class="line"></span><br><span class="line">        for key in &quot;$&#123;END_TEST_ARRAY[@]&#125;&quot;;</span><br><span class="line">        do</span><br><span class="line">                value=$(echo &quot;$key&quot; | awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">                END_VALUES+=(&quot;$value&quot;)</span><br><span class="line">        done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        for ((i=0; i&lt;$&#123;#STRS[@]&#125;; i++))</span><br><span class="line">        do</span><br><span class="line">                diff=$((END_VALUES[i] - PRE_VALUES[i]))</span><br><span class="line">                echo -n &quot;$diff &quot; &gt;&gt; &quot;$output_file&quot;</span><br><span class="line">                echo &quot;$&#123;END_VALUES[i]&#125; $&#123;PRE_VALUES[i]&#125; $diff&quot;</span><br><span class="line">        done</span><br><span class="line"></span><br><span class="line">        echo &gt;&gt; &quot;$output_file&quot;</span><br><span class="line">        echo &quot;The $epooch epo is over&quot;</span><br><span class="line">        unset PRE_VALUES</span><br><span class="line">        unset END_VALUES</span><br><span class="line">        unset PRE_TEST_ARRAY</span><br><span class="line">        unset END_TEST_ARRAY</span><br><span class="line">        sleep 60</span><br><span class="line">done</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linuxå†…æ ¸ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç‰©ç†å†…å­˜åˆ†é…(æºç é˜…è¯»2)</title>
      <link href="/2023/12/31/Linux%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D(%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB2)/"/>
      <url>/2023/12/31/Linux%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D(%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB2)/</url>
      
        <content type="html"><![CDATA[<p>é¦–å…ˆï¼Œè¿˜æ˜¯ç»™å‡ºå‚è€ƒæ–‡çŒ®ï¼š<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&mid=2247487111&idx=1&sn=e57371f9c3e6910f4f4721aa0787e537&chksm=ce77c8c0f90041d67b2d344d413a2573f3662a1a64a802b41d4618982fcbff1617d9a5da9f7b&scene=178&cur_album_id=2559805446807928833&poc_token=HH42jmWjzYC8XLG-QvRoCInlL45ANFw7eWIJAKJo">å‚è€ƒåšå®¢</a></p><h2 id="æ¯CPUé¡µæ¡†é«˜é€Ÿç¼“å­˜"><a href="#æ¯CPUé¡µæ¡†é«˜é€Ÿç¼“å­˜" class="headerlink" title="æ¯CPUé¡µæ¡†é«˜é€Ÿç¼“å­˜"></a>æ¯CPUé¡µæ¡†é«˜é€Ÿç¼“å­˜</h2><p>å› ä¸ºå†…å­˜ç»å¸¸è¯·æ±‚å•ä¸ªé¡µæ¡†ï¼Œå› æ­¤ä¸ºäº†æå‡æ€§èƒ½ï¼Œåœ¨ä¼™ä¼´ç³»ç»Ÿä¹‹å¤–åˆå®šä¹‰äº†ä¸€ä¸ªper-CPUé«˜é€Ÿç¼“å­˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span>&#123;</span></span><br><span class="line">    <span class="comment">// å®ç°æ¯CPUé¡µæ¡†çš„é«˜é€Ÿç¼“å­˜ã€‚é‡Œé¢åŒ…å«æ¯ä¸ªCPUçš„å•é¡µæ¡†çš„é“¾è¡¨</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span>__<span class="title">percpu</span> *<span class="title">per_cpu_pageset</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span> &#123;</span></span><br><span class="line"><span class="type">int</span> count;</span><br><span class="line"><span class="type">int</span> high;</span><br><span class="line"><span class="comment">// å½“éœ€è¦å¢åŠ æˆ–è€…å‡å°‘é«˜é€Ÿç¼“å­˜é¡µæ¡†æ—¶ï¼Œæ“ä½œçš„é¡µæ¡†ä¸ªæ•°</span></span><br><span class="line"><span class="type">int</span> batch;</span><br><span class="line"><span class="comment">// ç©ºé—²æœŸé—´çš„æ‰¹é‡é‡Šæ”¾å› å­</span></span><br><span class="line"><span class="type">short</span> free_factor;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line"><span class="type">short</span> expire;<span class="comment">/* When 0, remote pagesets are drained */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¯ç§è¿ç§»ç±»å‹ä¸ºä¸€ä¸ªé“¾è¡¨</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lists</span>[<span class="title">NR_PCP_LISTS</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„<code>NR_PCP_LISTS</code>è¢«å®šä¹‰ä¸º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NR_PCP_LISTS (MIGRATE_PCPTYPES * (PAGE_ALLOC_COSTLY_ORDER + 1 + NR_PCP_THP))</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">MIGRATE_PCPTYPESä¸ºé¡µé¢è¿ç§»ç±»å‹ï¼ŒåŒ…æ‹¬MIGRATE_UNMOVABLE,MIGRATE_MOVABLE,MIGRATE_RECLAIMABLE,</span></span><br><span class="line"><span class="comment">PAGE_ALLOC_COSTLY_ORDER 3</span></span><br><span class="line"><span class="comment">NR_PCP_THP 0</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><h2 id="ä¼™ä¼´ç³»ç»Ÿ"><a href="#ä¼™ä¼´ç³»ç»Ÿ" class="headerlink" title="ä¼™ä¼´ç³»ç»Ÿ"></a>ä¼™ä¼´ç³»ç»Ÿ</h2><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202312311546874.png" alt="640"></p><p>æ¯ä¸ªç®¡ç†åŒº<code>zone</code>éƒ½æœ‰è‡ªå·±çš„ä¼™ä¼´ç³»ç»Ÿç®¡ç†å±äºè¿™ä¸ªç®¡ç†åŒºçš„é¡µæ¡†ã€‚åœ¨ä¸€ä¸ªç®¡ç†åŒºä¸­ï¼Œä¼™ä¼´ç³»ç»Ÿä¸€å…±ç»´æŠ¤ç€åŒ…å«1,2,4,8,16,â€¦,512,1024ä¸ªè¿ç»­é¡µæ¡†çš„é“¾è¡¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_ORDER 11</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span>&#123;</span></span><br><span class="line">    <span class="comment">// ç›¸åŒå¤§å°çš„è¿ç»­é¡µæ¡†è¿æ¥å½¢æˆä¸€ä¸ªé“¾è¡¨</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> <span class="title">free_area</span>[<span class="title">MAX_ORDER</span>];</span> <span class="comment">// 11ä¸ªfree_areaï¼Œåˆ†åˆ«å¯¹åº”1,2,4,16,...,1024</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">free_list</span>[<span class="title">MIGRATE_TYPES</span>];</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>nr_free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼™ä¼´ç³»ç»Ÿä¸­ï¼Œ<strong>ç›¸åŒå¤§å°çš„è¿ç»­é¡µæ¡†è¿æ¥å½¢æˆä¸€ä¸ªé“¾è¡¨ï¼Œåœ¨é“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹ä¸­ï¼Œåˆæœ‰ä»¥<code>MIGRATE_TYPES</code>åŒºåˆ†çš„å°é“¾è¡¨</strong>ï¼Œ</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202312291118186.png" alt="image-20231229111822073"></p><p>å…¶MIGRATE_TYPESä¸ºé¡µæ¡†ç±»å‹ï¼ŒåŸºæœ¬æœ‰å¦‚ä¸‹ï¼š</p><ul><li><strong>MIGRATE_UNMOVABLEï¼š</strong>é¡µæ¡†å†…å®¹ä¸å¯ç§»åŠ¨,åœ¨å†…å­˜ä¸­ä½ç½®å¿…é¡»å›ºå®šï¼Œæ— æ³•ç§»åŠ¨åˆ°å…¶ä»–åœ°æ–¹ï¼Œæ ¸å¿ƒå†…æ ¸åˆ†é…çš„å¤§éƒ¨åˆ†é¡µé¢éƒ½å±äºè¿™ä¸€ç±»ã€‚</li><li><strong>MIGRATE_RECLAIMABLEï¼š</strong>é¡µæ¡†å†…å®¹å¯å›æ”¶,ä¸èƒ½ç›´æ¥ç§»åŠ¨ï¼Œä½†æ˜¯å¯ä»¥å›æ”¶ï¼Œå› ä¸ºè¿˜å¯ä»¥ä»æŸäº›æºé‡å»ºé¡µé¢ï¼Œæ¯”å¦‚æ˜ å°„æ–‡ä»¶çš„æ•°æ®å±äºè¿™ç§ç±»åˆ«ï¼Œkswapdä¼šæŒ‰ç…§ä¸€å®šçš„è§„åˆ™ï¼Œå‘¨æœŸæ€§çš„å›æ”¶è¿™ç±»é¡µé¢ã€‚</li><li><strong>MIGRATE_MOVABLEï¼š</strong>é¡µæ¡†å†…å®¹å¯ç§»åŠ¨ï¼Œå±äºç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºçš„é¡µå±äºæ­¤ç±»é¡µé¢ï¼Œå®ƒä»¬æ˜¯é€šè¿‡é¡µè¡¨æ˜ å°„çš„ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦æ›´æ–°é¡µè¡¨é¡¹ï¼Œå¹¶æŠŠæ•°æ®å¤åˆ¶åˆ°æ–°ä½ç½®å°±å¯ä»¥äº†ï¼Œå½“ç„¶è¦æ³¨æ„ï¼Œä¸€ä¸ªé¡µé¢å¯èƒ½è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼Œå¯¹åº”ç€å¤šä¸ªé¡µè¡¨é¡¹ã€‚</li><li><strong>MIGRATE_PCPTYPESï¼š</strong>ç”¨æ¥è¡¨ç¤ºæ¯CPUé¡µæ¡†é«˜é€Ÿç¼“å­˜çš„æ•°æ®ç»“æ„ä¸­çš„é“¾è¡¨çš„è¿ç§»ç±»å‹æ•°ç›®ã€‚</li><li><strong>MIGRATE_CMAï¼š</strong> é¢„ç•™ä¸€æ®µçš„å†…å­˜ç»™é©±åŠ¨ä½¿ç”¨ï¼Œä½†å½“é©±åŠ¨ä¸ç”¨çš„æ—¶å€™ï¼Œä¼™ä¼´ç³»ç»Ÿå¯ä»¥åˆ†é…ç»™ç”¨æˆ·è¿›ç¨‹ç”¨ä½œåŒ¿åå†…å­˜æˆ–è€…é¡µç¼“å­˜ã€‚è€Œå½“é©±åŠ¨éœ€è¦ä½¿ç”¨æ—¶ï¼Œå°±å°†è¿›ç¨‹å ç”¨çš„å†…å­˜é€šè¿‡å›æ”¶æˆ–è€…è¿ç§»çš„æ–¹å¼å°†ä¹‹å‰å ç”¨çš„é¢„ç•™å†…å­˜è…¾å‡ºæ¥ï¼Œä¾›é©±åŠ¨ä½¿ç”¨ã€‚</li><li><strong>MIGRATE_ISOLATEï¼š</strong>ä¸èƒ½ä»è¿™ä¸ªé“¾è¡¨åˆ†é…é¡µæ¡†ï¼Œå› ä¸ºè¿™ä¸ªé“¾è¡¨ä¸“é—¨ç”¨äºNUMAç»“ç‚¹ç§»åŠ¨ç‰©ç†å†…å­˜é¡µï¼Œå°†ç‰©ç†å†…å­˜é¡µå†…å®¹ç§»åŠ¨åˆ°ä½¿ç”¨è¿™ä¸ªé¡µæœ€é¢‘ç¹çš„CPUã€‚</li></ul><p>åœ¨åˆ†é…æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°æŸç§ç±»å‹çš„é¡µé¢è¢«è€—å°½ä¸æ»¡è¶³è¦æ±‚ï¼Œå› æ­¤éœ€è¦å¦‚ä¸‹å¯¹ä¸åŒç±»å‹çš„é¡µæ¡†è¿›è¡Œä¼˜å…ˆçº§å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“æŸç§ç±»å‹çš„ç©ºé—²é¡µé¢è€—å°½ä¸æ»¡è¶³éœ€è¦æ•°ç›®æ—¶çš„ä¼˜å…ˆçº§åˆ—è¡¨</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> fallbacks[MIGRATE_TYPES][<span class="number">3</span>] = &#123;</span><br><span class="line">[MIGRATE_UNMOVABLE]   = &#123; MIGRATE_RECLAIMABLE, MIGRATE_MOVABLE,   MIGRATE_TYPES &#125;,</span><br><span class="line">[MIGRATE_MOVABLE]     = &#123; MIGRATE_RECLAIMABLE, MIGRATE_UNMOVABLE, MIGRATE_TYPES &#125;,</span><br><span class="line">[MIGRATE_RECLAIMABLE] = &#123; MIGRATE_UNMOVABLE,   MIGRATE_MOVABLE,   MIGRATE_TYPES &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMA</span></span><br><span class="line">[MIGRATE_CMA]         = &#123; MIGRATE_TYPES &#125;, <span class="comment">/* Never used */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span></span><br><span class="line">[MIGRATE_ISOLATE]     = &#123; MIGRATE_TYPES &#125;, <span class="comment">/* Never used */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»¥MIGRATE_RECLAIMABLEä¸ºä¾‹ï¼Œå¦‚æœæˆ‘éœ€è¦ç”³è¯·è¿™ç§é¡µæ¡†ï¼Œå½“ç„¶ä¼šä¼˜å…ˆä»è¿™ç±»é¡µæ¡†çš„é“¾è¡¨ä¸­è·å–ï¼Œå¦‚æœæ²¡æœ‰ï¼Œæˆ‘ä¼šä¾æ¬¡å°è¯•ä»MIGRATE_UNMOVABLE -&gt; MIGRATE_MOVABLE -&gt; MIGRATE_RESERVEé“¾è¿›è¡Œåˆ†é…ã€‚</p><h2 id="å†…æ ¸ç‰©ç†å†…å­˜åˆ†é…"><a href="#å†…æ ¸ç‰©ç†å†…å­˜åˆ†é…" class="headerlink" title="å†…æ ¸ç‰©ç†å†…å­˜åˆ†é…"></a>å†…æ ¸ç‰©ç†å†…å­˜åˆ†é…</h2><h3 id="å†…å­˜åˆ†é…"><a href="#å†…å­˜åˆ†é…" class="headerlink" title="å†…å­˜åˆ†é…"></a>å†…å­˜åˆ†é…</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">struct page *alloc_pages(gfp_t gfp, unsigned int order);</span><br><span class="line">#define alloc_page(gfp_mask) alloc_pages(gfp_mask, 0)</span><br></pre></td></tr></table></figure><p><code>alloc_pages</code> å‡½æ•°ç”¨äºå‘åº•å±‚ä¼™ä¼´ç³»ç»Ÿç”³è¯· 2 çš„ order æ¬¡å¹‚ä¸ªè¿ç»­ç‰©ç†å†…å­˜é¡µç»„æˆçš„å†…å­˜å—ï¼Œè¯¥å‡½æ•°è¿”å›å€¼æ˜¯ä¸€ä¸ª struct page ç±»å‹çš„æŒ‡é’ˆç”¨äºæŒ‡å‘ç”³è¯·çš„å†…å­˜å—ä¸­<strong>ç¬¬ä¸€ä¸ªç‰©ç†å†…å­˜é¡µ</strong>ã€‚è¿”å›å€¼æ˜¯<strong>é¡µçš„ç‰©ç†å†…å­˜åœ°å€</strong>ï¼Œ<code>alloc_page</code>ç”¨äºåˆ†é…å•ä¸ªé¡µï¼Œå…¶å®å°±æ˜¯æŠŠorderæŒ‡å®šä¸º0ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> __get_free_pages(<span class="type">gfp_t</span> gfp_mask, <span class="type">unsigned</span> <span class="type">int</span> order)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">page = alloc_pages(gfp_mask &amp; ~__GFP_HIGHMEM, order); <span class="comment">// ä¸èƒ½ä½¿ç”¨é«˜ç«¯å†…å­˜ï¼Œå› ä¸ºé«˜ç«¯å†…å­˜ä¸èƒ½ ç›´æ¥æ˜ å°„</span></span><br><span class="line"><span class="keyword">if</span> (!page)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">long</span>) page_address(page); <span class="comment">// page_addresså¯¹ç›´æ¥æ˜ å°„åŒºçš„ç‰©ç†å†…å­˜è½¬æ¢æˆè™šæ‹Ÿå†…å­˜</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>__get_free_pages</code>å‡½æ•°çš„åŠŸèƒ½å’Œ<code>alloc_pages</code>ä¸€æ ·ï¼Œåªæ˜¯è¿”å›çš„æ˜¯<strong>é¡µçš„è™šæ‹Ÿåœ°å€</strong>ã€‚åœ¨å…¶å‡½æ•°å†…éƒ¨å°±æ˜¯è°ƒç”¨çš„<code>alloc_pages</code>,å¹¶è°ƒç”¨<code>page_address</code>æŠŠé¡µçš„ç‰©ç†åœ°å€è½¬æ¢æˆé¡µçš„è™šæ‹Ÿåœ°å€ã€‚</p><p>æ— è®ºæ˜¯ <code>alloc_pages</code> ä¹Ÿå¥½è¿˜æ˜¯ &#96;__get_free_pages&#96;&#96; ä¹Ÿå¥½ï¼Œå®ƒä»¬ç”³è¯·åˆ°çš„å†…å­˜é¡µä¸­åŒ…å«çš„æ•°æ®åœ¨ä¸€å¼€å§‹éƒ½ä¸æ˜¯ç©ºç™½çš„ï¼Œè€Œæ˜¯å†…æ ¸<strong>éšæœºäº§ç”Ÿçš„ä¿¡æ¯</strong>ã€‚</p><p>å†…æ ¸åˆæä¾›äº†ä¸€ä¸ªå‡½æ•° get_zeroed_pageï¼Œè¿™ä¸ªå‡½æ•°ä¼šå°†ä»ä¼™ä¼´ç³»ç»Ÿä¸­ç”³è¯·åˆ°å†…å­˜é¡µ<strong>å…¨éƒ¨åˆå§‹åŒ–å¡«å……ä¸º 0</strong> ï¼Œè¿™åœ¨<strong>åˆ†é…ç‰©ç†å†…å­˜é¡µç»™ç”¨æˆ·ç©ºé—´ä½¿ç”¨</strong>çš„æ—¶å€™éå¸¸æœ‰ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">get_zeroed_page</span><span class="params">(<span class="type">gfp_t</span> gfp_mask)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> __get_free_pages(gfp_mask | __GFP_ZERO, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†…æ ¸è¿˜æä¾›äº†ä¸€ä¸ª __get_dma_pages å‡½æ•°ï¼Œä¸“é—¨ç”¨äºä» DMA å†…å­˜åŒºåŸŸåˆ†é…é€‚ç”¨äº DMA çš„ç‰©ç†å†…å­˜é¡µã€‚å…¶åº•å±‚ä¹Ÿæ˜¯ä¾èµ–äº __get_free_pages å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __get_dma_pages(gfp_mask, order)  __get_free_pages((gfp_mask) | GFP_DMA, (order))</span></span><br></pre></td></tr></table></figure><h3 id="å†…å­˜é‡Šæ”¾"><a href="#å†…å­˜é‡Šæ”¾" class="headerlink" title="å†…å­˜é‡Šæ”¾"></a>å†…å­˜é‡Šæ”¾</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __free_pages(<span class="keyword">struct</span> page *page, <span class="type">unsigned</span> <span class="type">int</span> order); <span class="comment">// ä½¿ç”¨é‡Šæ”¾åŒºåŸŸç¬¬ä¸€ä¸ªpageçš„ç‰©ç†åœ°å€</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_pages</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> addr, <span class="type">unsigned</span> <span class="type">int</span> order)</span>; <span class="comment">// ä½¿ç”¨è™šæ‹Ÿåœ°å€</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¯æ¬¡é‡Šæ”¾ä¸€ä¸ªé¡µ</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __free_page(page) __free_pages((page), 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> free_page(addr) free_pages((addr), 0)</span></span><br></pre></td></tr></table></figure><h2 id="è§„èŒƒç‰©ç†å†…å­˜åˆ†é…è¡Œä¸ºçš„æ©ç gfp-mask"><a href="#è§„èŒƒç‰©ç†å†…å­˜åˆ†é…è¡Œä¸ºçš„æ©ç gfp-mask" class="headerlink" title="è§„èŒƒç‰©ç†å†…å­˜åˆ†é…è¡Œä¸ºçš„æ©ç gfp_mask"></a>è§„èŒƒç‰©ç†å†…å­˜åˆ†é…è¡Œä¸ºçš„æ©ç gfp_mask</h2><p>åœ¨è¿›è¡Œç‰©ç†å†…å­˜åˆ†é…çš„æ—¶å€™ï¼Œéœ€è¦å¯¹åˆ†é…è¡Œä¸ºåšå‡ºå¾ˆå¤šçš„è®¾å®šä¸è§„èŒƒï¼Œä½¿ç”¨<code>gfp_mask</code>æ©ç æ¥è§„èŒƒã€‚</p><p>ä»¥ä¸‹æ˜¯å¯¹æ©ç çš„å®šä¹‰,åœ¨<code>include/linux/gfp.h</code>ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">___GFP_DMA ï¼š 0x01u = 00000001ï¼ˆäºŒè¿›åˆ¶ï¼‰</span></span><br><span class="line"><span class="comment">___GFP_HIGHMEM ï¼š 0x02u = 00000010ï¼ˆäºŒè¿›åˆ¶ï¼‰</span></span><br><span class="line"><span class="comment">___GFP_DMA32 ï¼š 0x04u = 00000100ï¼ˆäºŒè¿›åˆ¶ï¼‰</span></span><br><span class="line"><span class="comment">___GFP_MOVABLE ï¼š 0x08u = 00001000ï¼ˆäºŒè¿›åˆ¶ï¼‰</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// ä¸‹è¾¹å››ä¸ªæ˜¯é™åˆ¶å†…æ ¸çš„ç‰©ç†åˆ†é…åŒºåŸŸ</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_DMA0x01u   <span class="comment">// å¯ä»¥ä»DMAåŒºåŸŸè·å¾—å†…å­˜</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_HIGHMEM0x02u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_DMA320x04u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_MOVABLE0x08u</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é™åˆ¶åˆ†é…è¡Œä¸º</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_RECLAIMABLE0x10u    <span class="comment">// åˆ†é…çš„é¡µé¢æ˜¯å¯ä»¥å›æ”¶çš„</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_HIGH 0x20u  <span class="comment">// å†…å­˜åˆ†é…è¯·æ±‚çš„ä¼˜å…ˆçº§æ˜¯æœ€é«˜çš„ï¼Œå†…æ ¸è¿«åˆ‡éœ€è¦å†…å­˜ï¼Œä¸å…è®¸å¤±è´¥</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_IO0x40u  <span class="comment">//åˆ†é…æ—¶å¯ä»¥å‘èµ·ç£ç›˜IOæ“ä½œï¼Œå³å¯ä»¥å°†ä¸å¸¸ç”¨çš„å†…å­˜ä¹Ÿç½®æ¢åˆ°SWAPåˆ†åŒº</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_FS0x80u <span class="comment">// å…è®¸å†…æ ¸æ‰§è¡Œåº•å±‚æ–‡ä»¶ç³»ç»Ÿæ“ä½œ</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_ZERO0x100u <span class="comment">//åœ¨å†…æ ¸åˆ†é…å†…å­˜æˆåŠŸä¹‹åï¼Œå°†å†…å­˜é¡µåˆå§‹åŒ–å¡«å……å­—èŠ‚ 0 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_ATOMIC0x200u <span class="comment">// ä¸å…è®¸ç¡çœ ï¼Œå¿…é¡»åŸå­æ€§åœ°åˆ†é…</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_DIRECT_RECLAIM0x400u <span class="comment">// å†…æ ¸åœ¨è¿›è¡Œå†…å­˜åˆ†é…çš„æ—¶å€™ï¼Œå¯ä»¥è¿›è¡Œç›´æ¥å†…å­˜å›æ”¶</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">___GFP_KSWAPD_RECLAIMè¡¨ç¤ºå†…æ ¸åœ¨åˆ†é…å†…å­˜çš„æ—¶å€™ï¼Œå¦‚æœå‰©ä½™å†…å­˜å®¹é‡åœ¨ _watermark[WMARK_MIN] ä¸ _watermark[WMARK_LOW] ä¹‹é—´æ—¶ï¼Œå†…æ ¸å°±ä¼šå”¤é†’ kswapd è¿›ç¨‹å¼€å§‹å¼‚æ­¥å†…å­˜å›æ”¶</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_KSWAPD_RECLAIM0x800u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_WRITE0x1000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_NOWARN0x2000u <span class="comment">// åˆ†é…å¤±è´¥æ—¶ï¼ŒæŠ‘åˆ¶å†…æ ¸çš„åˆ†é…å¤±è´¥æŠ¥å‘Š</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_RETRY_MAYFAIL0x4000u <span class="comment">// å†…å­˜åˆ†é…å¤±è´¥æ—¶ï¼Œå…è®¸é‡è¯•</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_NOFAIL0x8000u  <span class="comment">// åˆ†é…ä¸å…è®¸å¤±è´¥ï¼Œåˆ†é…å¤±è´¥æ—¶ä¸€ç›´é‡è¯•ç›´åˆ°æˆåŠŸ</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_NORETRY0x10000u  <span class="comment">// å†…å­˜åˆ†é…å¤±è´¥æ—¶ï¼Œä¸å…è®¸é‡è¯•</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">___GFP_MEMALLOC å…è®¸å†…æ ¸åœ¨åˆ†é…å†…å­˜æ—¶å¯ä»¥ä»æ‰€æœ‰å†…å­˜åŒºåŸŸä¸­è·å–å†…å­˜ï¼ŒåŒ…æ‹¬ä»ç´§æ€¥é¢„ç•™å†…å­˜ä¸­è·å–ã€‚ä½†ä½¿ç”¨è¯¥æ ‡ç¤ºæ—¶éœ€è¦ä¿è¯è¿›ç¨‹åœ¨è·å¾—å†…å­˜ä¹‹åä¼šå¾ˆå¿«çš„é‡Šæ”¾æ‰å†…å­˜ä¸ä¼šè¿‡é•¿æ—¶é—´çš„å ç”¨ï¼Œå°¤å…¶è¦è­¦æƒ•é¿å…è¿‡å¤šçš„æ¶ˆè€—ç´§æ€¥é¢„ç•™å†…å­˜åŒºåŸŸä¸­çš„å†…å­˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_MEMALLOC0x20000u </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_COMP0x40000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_NOMEMALLOC  0x80000u <span class="comment">//ç¦æ­¢ä»ç´§æ€¥é¢„ç•™å†…å­˜è·å¾—å†…å­˜,ä¼˜å…ˆçº§é«˜äº___GFP_MEMALLOC</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> ___GFP_HARDWALL é™åˆ¶äº†å†…æ ¸åˆ†é…å†…å­˜çš„è¡Œä¸ºåªèƒ½åœ¨å½“å‰è¿›ç¨‹åˆ†é…åˆ°çš„CPUæ‰€å…³è”çš„NUMAèŠ‚ç‚¹ä¸Šè¿›è¡Œåˆ†é…ï¼Œå¦‚æœè¿›ç¨‹å¯ä»¥åœ¨æ‰€æœ‰çš„CPUä¸Šè¿è¡Œï¼Œï¼ˆé‚£å°±å¯ä»¥åœ¨æ‰€æœ‰çš„NUMAèŠ‚ç‚¹è¿è¡Œï¼Œè¿™ä¸ªè®¾ç½®å°±æ²¡æœ‰æ„ä¹‰ï¼‰</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_HARDWALL0x100000u</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">___GFP_THISNODE é™åˆ¶äº†å†…æ ¸åˆ†é…å†…å­˜çš„è¡Œä¸ºï¼Œåªèƒ½åœ¨å½“å‰ NUMA èŠ‚ç‚¹æˆ–è€…åœ¨æŒ‡å®š NUMA èŠ‚ç‚¹ä¸­åˆ†é…å†…å­˜ï¼Œå¦‚æœå†…å­˜åˆ†é…å¤±è´¥ä¸å…è®¸ä»å…¶ä»–å¤‡ç”¨ NUMA èŠ‚ç‚¹ä¸­åˆ†é…å†…å­˜ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_THISNODE0x200000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_ACCOUNT0x400000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_ZEROTAGS0x800000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_SKIP_KASAN_POISON0x1000000u</span></span><br></pre></td></tr></table></figure><p>å°†è¿™äº›å®å®šä¹‰çš„å€¼è½¬ä¸ºäºŒè¿›åˆ¶å°±çœ‹åˆ°ï¼Œæ¯ä¸€ç§å ä¸€ä¸ªbitä½ã€‚ä½¿ç”¨æ©ç çš„æ—¶å€™åšä½è¿ç®—å³å¯</p><p><strong>æ²¡æœ‰<code>zone_normal</code>æ˜¯å› ä¸ºé»˜è®¤çš„åˆ†é…å°±æ˜¯<code>zone_normal</code>ã€‚</strong></p><p>åŒæ ·åœ¨<code>/include/linux/gfp.h</code>ä¸­å®šä¹‰äº†<code>gfp_zone</code>å‡½æ•°<strong>ï¼Œå‡½æ•°è¿”å›æ­¤æ¬¡å†…å­˜åˆ†é…ä¸­çš„æœ€é«˜çš„ç‰©ç†å†…å­˜åŒºåŸŸ</strong>ã€‚è¾ƒä¸ºæ–°çš„5.14ç‰ˆæœ¬ä¸­ç›¸å…³ä»£ç å¯è¯»æ€§å¾ˆå·®ã€‚</p><p>åœ¨2.6.24ç‰ˆæœ¬ä¸­ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">enum</span> zone_type <span class="title function_">gfp_zone</span><span class="params">(<span class="type">gfp_t</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> base = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; __GFP_THISNODE)</span><br><span class="line"> base = MAX_NR_ZONES;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ZONE_DMA</span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; __GFP_DMA)   <span class="comment">// flagä¸­è®¾ç½®äº†__GFP_DMA,å°±åªèƒ½åœ¨åœ¨ZONE_DMAä¸­åˆ†é…å†…å­˜</span></span><br><span class="line"><span class="keyword">return</span> base + ZONE_DMA;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ZONE_DMA32</span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; __GFP_DMA32) <span class="comment">// åŒä¸Š</span></span><br><span class="line"><span class="keyword">return</span> base + ZONE_DMA32;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¦‚æœè¦ä½¿ç”¨MOVABLEåŒºåŸŸï¼Œé‚£ä¹ˆåœ¨è®¾ç½®flagæ—¶ï¼Œ__GFP_HIGHMEMå’Œ__GFP_MOVABLEéƒ½è¦è®¾ç½®ä¸Š</span></span><br><span class="line"><span class="keyword">if</span> ((flags &amp; (__GFP_HIGHMEM | __GFP_MOVABLE)) ==</span><br><span class="line">(__GFP_HIGHMEM | __GFP_MOVABLE)) </span><br><span class="line"><span class="keyword">return</span> base + ZONE_MOVABLE;</span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HIGHMEM</span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; __GFP_HIGHMEM) <span class="comment">// åªè®¾ç½®äº†__GFP_HIGHMEM</span></span><br><span class="line"><span class="keyword">return</span> base + ZONE_HIGHMEM;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// é»˜è®¤ä» normal åŒºåŸŸä¸­åˆ†é…å†…å­˜</span></span><br><span class="line"> <span class="keyword">return</span> base + ZONE_NORMAL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†…æ ¸å°†ä¸€äº›å¸¸ç”¨çš„gfp_tæ©ç ç»„åˆæå‰å‡†å¤‡å¥½äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_ATOMIC (__GFP_HIGH|__GFP_ATOMIC|__GFP_KSWAPD_RECLAIM)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_KERNEL (__GFP_RECLAIM | __GFP_IO | __GFP_FS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_NOWAIT (__GFP_KSWAPD_RECLAIM)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_NOIO (__GFP_RECLAIM)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_NOFS (__GFP_RECLAIM | __GFP_IO)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_USER (__GFP_RECLAIM | __GFP_IO | __GFP_FS | __GFP_HARDWALL)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_DMA  __GFP_DMA</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_DMA32 __GFP_DMA32</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_HIGHUSER (GFP_USER | __GFP_HIGHMEM)</span></span><br></pre></td></tr></table></figure><ul><li><code>GFP_ATOMIC</code>è¡¨ç¤ºåˆ†é…è¡Œä¸ºæ˜¯åŸå­çš„ï¼Œæ˜¯é«˜ä¼˜å…ˆçº§çš„ã€‚å¦‚æœå†…å­˜ç©ºé—´ä¸å¤Ÿï¼Œåˆ™ä¼šä»ç´§æ€¥é¢„ç•™å†…å­˜ä¸­åˆ†é…ã€‚</li><li><code>GFP_KERNEL</code>è®¾ç½®ä¹‹åå†…æ ¸çš„åˆ†é…å†…å­˜è¡Œä¸ºå¯èƒ½ä¼šé˜»å¡ç¡çœ ï¼Œå¯ä»¥å…è®¸å†…æ ¸ç½®æ¢å‡ºä¸€äº›ä¸æ´»è·ƒçš„å†…å­˜é¡µåˆ°ç£ç›˜ä¸­ã€‚</li><li><code>GFP_NOIO</code> å’Œ <code>GFP_NOFS</code> åˆ†åˆ«ç¦æ­¢å†…æ ¸åœ¨åˆ†é…å†…å­˜æ—¶è¿›è¡Œç£ç›˜ IO å’Œ æ–‡ä»¶ç³»ç»Ÿ IO æ“ä½œã€‚</li><li><code>GFP_HIGHUSER</code> ç”¨äºç»™ç”¨æˆ·ç©ºé—´åˆ†é…é«˜ç«¯å†…å­˜ã€‚å› ä¸ºåœ¨ç”¨æˆ·è™šæ‹Ÿç©ºé—´ä¸­ï¼Œéƒ½æ˜¯é€šè¿‡é¡µè¡¨æ¥è®¿é—®éç›´æ¥æ˜ å°„çš„é«˜ç«¯å†…å­˜åŒºåŸŸ</li></ul><h2 id="ç‰©ç†å†…å­˜åˆ†é…å†…æ ¸æºç å®ç°"><a href="#ç‰©ç†å†…å­˜åˆ†é…å†…æ ¸æºç å®ç°" class="headerlink" title="ç‰©ç†å†…å­˜åˆ†é…å†…æ ¸æºç å®ç°"></a>ç‰©ç†å†…å­˜åˆ†é…å†…æ ¸æºç å®ç°</h2><h3 id="å†…å­˜åˆ†é…è¡Œä¸ºæ ‡è¯†æ©ç "><a href="#å†…å­˜åˆ†é…è¡Œä¸ºæ ‡è¯†æ©ç " class="headerlink" title="å†…å­˜åˆ†é…è¡Œä¸ºæ ‡è¯†æ©ç "></a>å†…å­˜åˆ†é…è¡Œä¸ºæ ‡è¯†æ©ç </h3><p>åœ¨å†…æ ¸æ–‡ä»¶ <code>/mm/internal.h</code> ä¸­å®šä¹‰äº†å½±å“å†…æ ¸åˆ†é…è¡Œä¸ºçš„æ ‡è¯†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_WMARK_MIN     WMARK_MIN</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_WMARK_LOW     WMARK_LOW</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_WMARK_HIGH    WMARK_HIGH</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_NO_WATERMARKS 0x04 <span class="comment">/* don&#x27;t check watermarks at all */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_HARDER         0x10 <span class="comment">/* try to alloc harder */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_HIGH       0x20 <span class="comment">/* __GFP_HIGH set */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_CPUSET         0x40 <span class="comment">/* check for correct cpuset */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_KSWAPD        0x800 <span class="comment">/* allow waking of kswapd, __GFP_KSWAPD_RECLAIM set */</span></span></span><br></pre></td></tr></table></figure><ul><li><strong>ALLOC_NO_WATERMARKSï¼š</strong> è¡¨ç¤ºåœ¨å†…å­˜åˆ†é…è¿‡ç¨‹ä¸­å®Œå…¨ä¸ä¼šè€ƒè™‘minã€lowã€highä¸‰ä¸ªæ°´ä½çº¿çš„å½±å“ã€‚</li><li><strong>ALLOC_WMARK_HIGHï¼š</strong> è¡¨ç¤ºåœ¨å†…å­˜åˆ†é…çš„æ—¶å€™ï¼Œå½“å‰ç‰©ç†å†…å­˜åŒºåŸŸ zone ä¸­å‰©ä½™å†…å­˜é¡µçš„æ•°é‡è‡³å°‘è¦è¾¾åˆ° _watermark[WMARK_HIGH] æ°´ä½çº¿ï¼Œæ‰èƒ½è¿›è¡Œå†…å­˜çš„åˆ†é…ã€‚</li><li>ALLOC_WMARK_LOW å’Œ ALLOC_WMARK_MIN è¦è¡¨è¾¾çš„å†…å­˜åˆ†é…è¯­ä¹‰ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå½“å‰ç‰©ç†å†…å­˜åŒºåŸŸ zone ä¸­å‰©ä½™å†…å­˜é¡µçš„æ•°é‡è‡³å°‘è¦è¾¾åˆ°æ°´ä½çº¿ _watermark[WMARK_LOW]  æˆ–è€… _watermark[WMARK_MIN]ï¼Œæ‰èƒ½è¿›è¡Œå†…å­˜çš„åˆ†é…ã€‚</li><li><strong>ALLOC_HARDERï¼š</strong> è¡¨ç¤ºåœ¨å†…å­˜åˆ†é…çš„æ—¶å€™ï¼Œä¼šæ”¾å®½å†…å­˜åˆ†é…è§„åˆ™çš„é™åˆ¶ï¼Œæ‰€è°“çš„æ”¾å®½è§„åˆ™å°±æ˜¯é™ä½ _watermark[WMARK_MIN] æ°´ä½çº¿ï¼ŒåŠªåŠ›ä½¿å†…å­˜åˆ†é…æœ€å¤§å¯èƒ½æˆåŠŸã€‚</li><li><strong>ALLOC_HIGHï¼š</strong>å½“æˆ‘ä»¬åœ¨ gfp_t æ©ç ä¸­è®¾ç½®äº† ___GFP_HIGH æ—¶ï¼ŒALLOC_HIGH æ ‡è¯†æ‰èµ·ä½œç”¨ï¼Œè¯¥æ ‡è¯†è¡¨ç¤ºå½“å‰å†…å­˜åˆ†é…è¯·æ±‚æ˜¯é«˜ä¼˜å…ˆçº§çš„ï¼Œå†…æ ¸æ€¥åˆ‡çš„éœ€è¦å†…å­˜</li><li><strong>ALLOC_CPUSETï¼š</strong> è¡¨ç¤ºå†…å­˜åªèƒ½åœ¨å½“å‰è¿›ç¨‹æ‰€å…è®¸è¿è¡Œçš„ CPU æ‰€å…³è”çš„ NUMA èŠ‚ç‚¹ä¸­è¿›è¡Œåˆ†é…ã€‚</li><li><strong>ALLOC_KSWAPDï¼š</strong> è¡¨ç¤ºå…è®¸å”¤é†’ NUMA èŠ‚ç‚¹ä¸­çš„ KSWAPD è¿›ç¨‹ï¼Œå¼‚æ­¥è¿›è¡Œå†…å­˜å›æ”¶ã€‚</li></ul><h3 id="å†…å­˜åˆ†é…çš„å¿ƒè„-alloc-pages"><a href="#å†…å­˜åˆ†é…çš„å¿ƒè„-alloc-pages" class="headerlink" title="å†…å­˜åˆ†é…çš„å¿ƒè„ __alloc_pages"></a>å†…å­˜åˆ†é…çš„å¿ƒè„ __alloc_pages</h3><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202312311647985" alt="å›¾ç‰‡"></p><p>å†…å­˜åˆ†é…çš„ä»»åŠ¡æœ€ç»ˆä¼šè½åœ¨ <code>alloc_pages</code> è¿™ä¸ªæ¥å£å‡½æ•°ä¸­ï¼Œåœ¨ <code>alloc_pages</code> ä¸­ä¼šè°ƒç”¨ <code>alloc_pages_node</code> è¿›è€Œè°ƒç”¨ alloc_pages_node å‡½æ•°ï¼Œæœ€ç»ˆé€šè¿‡ <code>alloc_pages</code> å‡½æ•°æ­£å¼è¿›å…¥å†…æ ¸å†…å­˜åˆ†é…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">alloc_pages</span>(<span class="title">gfp_t</span> <span class="title">gfp</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>, <span class="title">int</span> <span class="title">preferred_nid</span>,</span></span><br><span class="line"><span class="class"><span class="title">nodemask_t</span> *<span class="title">nodemask</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="comment">// å†…å­˜åŒºåŸŸä¸­çš„å‰©ä½™å†…å­˜éœ€è¦åœ¨ WMARK_LOW æ°´ä½çº¿ä¹‹ä¸Šæ‰èƒ½è¿›è¡Œå†…å­˜åˆ†é…ï¼Œå¦åˆ™å¤±è´¥ï¼ˆåˆæ¬¡å°è¯•å¿«é€Ÿå†…å­˜åˆ†é…ï¼‰</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> alloc_flags = ALLOC_WMARK_LOW;</span><br><span class="line"><span class="type">gfp_t</span> alloc_gfp; <span class="comment">/* The gfp_t that was actually used for allocation */</span></span><br><span class="line"><span class="comment">// alloc_contextç”¨äºä¿å­˜åœ¨åˆ†é…è¿‡ç¨‹ä¸­çš„ä¸€äº›ä¸å¯å˜çš„å‚æ•°ï¼Œæ¯”å¦‚nodemaskã€é¡µé¢è¿ç§»ç±»å‹ã€æœ€é«˜å¯åˆ†é…çš„å†…å­˜åŒºåŸŸï¼Œè¿™äº›</span></span><br><span class="line"><span class="comment">//åœ¨åˆ†é…è¿‡ç¨‹ä¸­åªç”¨åˆå§‹åŒ–ä¸€æ¬¡ï¼ˆä¸ä¼šå˜çš„ï¼‰ï¼Œè€Œåƒzonelistã€prefer_zoneç­‰åœ¨åˆå§‹åŒ–ä¹‹åï¼Œå¯èƒ½ä¼šåœ¨__alloc_pages_slowpath()ä¸­æ”¹å˜</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_context</span> <span class="title">ac</span> =</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// orderåªèƒ½ä»0-10,unlikelyå‘Šè¯‰ç¼–è¯‘å™¨è¿™ä¸ªåˆ¤æ–­ä¸ç»å¸¸å‘ç”Ÿï¼Œç”¨äºç¼–è¯‘ä¼˜åŒ–</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(order &gt;= MAX_ORDER)) &#123; </span><br><span class="line">WARN_ON_ONCE(!(gfp &amp; __GFP_NOWARN));</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¡¨ç¤ºåœ¨å†…å­˜åˆ†é…æœŸé—´è¿›ç¨‹å¯ä»¥ä¼‘çœ é˜»å¡</span></span><br><span class="line">gfp &amp;= gfp_allowed_mask;</span><br><span class="line"><span class="comment">// ä½¿ç”¨å‡½æ•°ï¼Œè®¾ç½®å†…å­˜åˆ†é…æ—¶å…ä¸å…è®¸è¿›è¡Œioæ“ä½œã€å…ä¸å…è®¸è¿›è¡Œæ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œã€å…ä¸å…è®¸ä½¿ç”¨å¯ç§»åŠ¨å†…å­˜</span></span><br><span class="line"><span class="comment">// å¹¶ä¿®æ”¹gfpä¸­å¯¹åº”çš„æ ‡å¿—ä½</span></span><br><span class="line">gfp = current_gfp_context(gfp);</span><br><span class="line">alloc_gfp = gfp;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ– alloc_contextï¼Œå¹¶ä¸ºæ¥ä¸‹æ¥çš„å¿«é€Ÿå†…å­˜åˆ†é…è®¾ç½®ç›¸å…³ gfp</span></span><br><span class="line"><span class="keyword">if</span> (!prepare_alloc_pages(gfp, order, preferred_nid, nodemask, &amp;ac,</span><br><span class="line">&amp;alloc_gfp, &amp;alloc_flags))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">alloc_flags |= alloc_flags_nofragment(ac.preferred_zoneref-&gt;zone, gfp);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†…å­˜åˆ†é…å¿«é€Ÿè·¯å¾„ï¼šç¬¬ä¸€æ¬¡å°è¯•ä»åº•å±‚ä¼™ä¼´ç³»ç»Ÿåˆ†é…å†…å­˜ï¼Œæ³¨æ„æ­¤æ—¶æ˜¯åœ¨ WMARK_LOW æ°´ä½çº¿ä¹‹ä¸Šåˆ†é…å†…å­˜</span></span><br><span class="line">page = get_page_from_freelist(alloc_gfp, order, alloc_flags, &amp;ac);</span><br><span class="line"><span class="keyword">if</span> (likely(page))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">alloc_gfp = gfp;</span><br><span class="line">ac.spread_dirty_pages = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">ac.nodemask = nodemask;</span><br><span class="line"></span><br><span class="line">page = __alloc_pages_slowpath(alloc_gfp, order, &amp;ac);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line"><span class="keyword">if</span> (memcg_kmem_enabled() &amp;&amp; (gfp &amp; __GFP_ACCOUNT) &amp;&amp; page &amp;&amp;</span><br><span class="line">    unlikely(__memcg_kmem_charge_page(page, gfp, order) != <span class="number">0</span>)) &#123;</span><br><span class="line">__free_pages(page, order);</span><br><span class="line">page = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">trace_mm_page_alloc(page, order, alloc_gfp, ac.migratetype);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__alloc_pages);</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç çš„æ•´ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li><p>é¦–å…ˆå°è¯•åœ¨å†…å­˜æ°´ä½çº¿VMARK_LOWä¹‹ä¸Šè¿›è¡Œä¸€æ¬¡å†…å­˜åˆ†é…ï¼Œå¯¹åº”<code>unsigned int alloc_flags = ALLOC_WMARK_LOW</code></p></li><li><p>æ ¡éªŒæœ¬æ¬¡å†…å­˜åˆ†é…æŒ‡å®šä¼™ä¼´ç³»ç»Ÿçš„åˆ†é…é˜¶ order çš„æœ‰æ•ˆæ€§,å¯¹åº”<code>if (unlikely(order &gt;= MAX_ORDER))</code></p></li><li><p>è°ƒç”¨ prepare_alloc_pages åˆå§‹åŒ– alloc_context ï¼Œç”¨äºåœ¨ä¸åŒå†…å­˜åˆ†é…è¾…åŠ©å‡½æ•°ä¸­ä¼ é€’å†…å­˜åˆ†é…å‚æ•°ã€‚ä¸ºæ¥ä¸‹æ¥å³å°†è¿›è¡Œçš„å¿«é€Ÿå†…å­˜åˆ†é…åšå‡†å¤‡ã€‚</p></li><li><p>è°ƒç”¨ get_page_from_freelist æ–¹æ³•é¦–æ¬¡å°è¯•åœ¨ä¼™ä¼´ç³»ç»Ÿä¸­è¿›è¡Œå†…å­˜åˆ†é…</p></li><li><p>å½“å¿«é€Ÿå†…å­˜åˆ†é…å¤±è´¥ä¹‹åï¼Œæƒ…å†µå°±ä¼šå˜å¾—éå¸¸å¤æ‚ï¼Œå†…æ ¸å°†ä¸å¾—ä¸åšæ›´å¤šçš„å·¥ä½œï¼Œæ¯”å¦‚å¼€å¯ kswapd è¿›ç¨‹å¼‚æ­¥å†…å­˜å›æ”¶ï¼Œæ›´æç«¯çš„æƒ…å†µåˆ™éœ€è¦è¿›è¡Œç›´æ¥å†…å­˜å›æ”¶ï¼Œæˆ–è€…ç›´æ¥å†…å­˜æ•´ç†ä»¥è·å–æ›´å¤šçš„ç©ºé—²è¿ç»­å†…å­˜ã€‚è¿™ä¸€åˆ‡çš„å¤æ‚é€»è¾‘å…¨éƒ¨å°è£…åœ¨ __alloc_pages_slowpath å‡½æ•°ä¸­ã€‚</p></li></ul><p>æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸‰ä¸ªé‡è¦å‡½æ•°ï¼š</p><p><code>prepare_alloc_pages</code>å‡½æ•°ç”¨äºåˆå§‹åŒ–å†…å­˜åˆ†é…ç­–ç•¥ã€‚</p><p><code>alloc_pages_slowpath</code>å‡½æ•°åœ¨åˆæ¬¡å¿«é€Ÿåˆ†é…å¤±è´¥åï¼Œè¿›è¡Œæ…¢é€Ÿåˆ†é…</p><p><code>get_page_from_freelist</code>å‡½æ•°ç”¨äºåœ¨ä¼™ä¼´ç³»ç»Ÿä¸­è¿›è¡Œå†…å­˜åˆ†é…ã€‚</p><p>æœ¬æ¬¡åšå®¢å…ˆä»‹ç»å‰ä¸¤ä¸ªå‡½æ•°</p><h3 id="prepare-alloc-pageså‡½æ•°"><a href="#prepare-alloc-pageså‡½æ•°" class="headerlink" title="prepare_alloc_pageså‡½æ•°"></a>prepare_alloc_pageså‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> <span class="title function_">prepare_alloc_pages</span><span class="params">(<span class="type">gfp_t</span> gfp_mask, <span class="type">unsigned</span> <span class="type">int</span> order,</span></span><br><span class="line"><span class="params"><span class="type">int</span> preferred_nid, <span class="type">nodemask_t</span> *nodemask,</span></span><br><span class="line"><span class="params"><span class="keyword">struct</span> alloc_context *ac, <span class="type">gfp_t</span> *alloc_gfp,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">int</span> *alloc_flags)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// ä»gfp_maskä¸­è·å–å†…å­˜åˆ†é…æœ€é«˜ä¼˜å…ˆçº§çš„åŒºåŸŸzone</span></span><br><span class="line">ac-&gt;highest_zoneidx = gfp_zone(gfp_mask);  </span><br><span class="line"><span class="comment">// ä» NUMA èŠ‚ç‚¹çš„å¤‡ç”¨èŠ‚ç‚¹é“¾è¡¨ä¸­ä¸€æ¬¡æ€§è·å–å…è®¸è¿›è¡Œå†…å­˜åˆ†é…çš„æ‰€æœ‰å†…å­˜åŒºåŸŸ</span></span><br><span class="line">ac-&gt;zonelist = node_zonelist(preferred_nid, gfp_mask);</span><br><span class="line">ac-&gt;nodemask = nodemask;</span><br><span class="line">ac-&gt;migratetype = gfp_migratetype(gfp_mask);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cpusets_enabled()) &#123;</span><br><span class="line">*alloc_gfp |= __GFP_HARDWALL;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * When we are in the interrupt context, it is irrelevant</span></span><br><span class="line"><span class="comment"> * to the current task context. It means that any node ok.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (in_task() &amp;&amp; !ac-&gt;nodemask)</span><br><span class="line">ac-&gt;nodemask = &amp;cpuset_current_mems_allowed;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">*alloc_flags |= ALLOC_CPUSET;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fs_reclaim_acquire(gfp_mask);</span><br><span class="line">fs_reclaim_release(gfp_mask);</span><br><span class="line"><span class="comment">// å¦‚æœè®¾ç½®äº†å…è®¸ç›´æ¥å†…å­˜å›æ”¶ï¼Œé‚£ä¹ˆå†…å­˜åˆ†é…è¿›ç¨‹åˆ™å¯èƒ½ä¼šå¯¼è‡´ä¼‘çœ è¢«é‡æ–°è°ƒåº¦ </span></span><br><span class="line">might_sleep_if(gfp_mask &amp; __GFP_DIRECT_RECLAIM);</span><br><span class="line"><span class="comment">// æå‰åˆ¤æ–­æœ¬æ¬¡å†…å­˜åˆ†é…æ˜¯å¦èƒ½å¤ŸæˆåŠŸï¼Œå¦‚æœä¸èƒ½åˆ™å°½æ—©å¤±è´¥</span></span><br><span class="line"><span class="keyword">if</span> (should_fail_alloc_page(gfp_mask, order))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">*alloc_flags = gfp_to_alloc_flags_cma(gfp_mask, *alloc_flags);</span><br><span class="line"></span><br><span class="line">ac-&gt;spread_dirty_pages = (gfp_mask &amp; __GFP_WRITE);</span><br><span class="line"></span><br><span class="line">ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,</span><br><span class="line">ac-&gt;highest_zoneidx, ac-&gt;nodemask);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>prepare_alloc_pages ä¸»è¦çš„ä»»åŠ¡å°±æ˜¯åœ¨å¿«é€Ÿå†…å­˜åˆ†é…å¼€å§‹ä¹‹å‰ï¼Œåšä¸€äº›å‡†å¤‡åˆå§‹åŒ–çš„å·¥ä½œï¼Œå…¶ä¸­æœ€æ ¸å¿ƒçš„å°±æ˜¯ä»æŒ‡å®š NUMA èŠ‚ç‚¹ä¸­ï¼Œæ ¹æ®  gfp_mask æ©ç ä¸­çš„å†…å­˜åŒºåŸŸä¿®é¥°ç¬¦è·å–å¯ä»¥è¿›è¡Œå†…å­˜åˆ†é…çš„æ‰€æœ‰å†…å­˜åŒºåŸŸ zone ï¼ˆåŒ…æ‹¬å…¶ä»–å¤‡ç”¨ NUMA èŠ‚ç‚¹ä¸­åŒ…å«çš„å†…å­˜åŒºåŸŸï¼‰ã€‚</p><h3 id="alloc-pages-slowpathå‡½æ•°"><a href="#alloc-pages-slowpathå‡½æ•°" class="headerlink" title="alloc_pages_slowpathå‡½æ•°"></a>alloc_pages_slowpathå‡½æ•°</h3><p><code>alloc_pages_slowpath</code> å‡½æ•°éå¸¸çš„å¤æ‚ï¼Œå…¶ä¸­åŒ…å«äº†å†…å­˜åˆ†é…çš„å„ç§å¼‚å¸¸æƒ…å†µçš„å¤„ç†ï¼Œå¹¶ä¸”ä¼šæ ¹æ®å‰è¾¹ä»‹ç»çš„ <code>GFP_</code>ï¼Œ<code>ALLOC</code> ç­‰å„ç§å†…å­˜åˆ†é…ç­–ç•¥æ©ç è¿›è¡Œä¸åŒåˆ†æ”¯çš„å¤„ç†ï¼Œè¿™æ ·å°±å˜å¾—éå¸¸çš„åºå¤§è€Œç¹æ‚ã€‚</p><p>å…¶åŸºæœ¬é€»è¾‘å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *</span></span><br><span class="line"><span class="class">__<span class="title">alloc_pages_slowpath</span>(<span class="title">gfp_t</span> <span class="title">gfp_mask</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>,</span></span><br><span class="line"><span class="class">                        <span class="keyword">struct</span> <span class="title">alloc_context</span> *<span class="title">ac</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        ......... åˆå§‹åŒ–æ…¢é€Ÿå†…å­˜åˆ†é…è·¯å¾„ä¸‹çš„ç›¸å…³å‚æ•° .......</span><br><span class="line"></span><br><span class="line">retry_cpuset:</span><br><span class="line"></span><br><span class="line">        ......... è°ƒæ•´å†…å­˜åˆ†é…ç­–ç•¥ alloc_flags é‡‡ç”¨æ›´åŠ æ¿€è¿›æ–¹å¼è·å–å†…å­˜ ......</span><br><span class="line">        ......... æ­¤æ—¶å†…å­˜åˆ†é…ä¸»è¦æ˜¯åœ¨è¿›ç¨‹æ‰€å…è®¸è¿è¡Œçš„ CPU ç›¸å…³è”çš„ NUMA èŠ‚ç‚¹ä¸Š ......</span><br><span class="line">        ......... å†…å­˜æ°´ä½çº¿ä¸‹è°ƒè‡³ WMARK_MIN ...........</span><br><span class="line">        ......... å”¤é†’æ‰€æœ‰ kswapd è¿›ç¨‹è¿›è¡Œå¼‚æ­¥å†…å­˜å›æ”¶  ...........</span><br><span class="line">        ......... è§¦å‘ç›´æ¥å†…å­˜æ•´ç† direct_compact æ¥è·å–æ›´å¤šçš„è¿ç»­ç©ºé—²å†…å­˜ ......</span><br><span class="line"></span><br><span class="line">retry:</span><br><span class="line"></span><br><span class="line">        ......... è¿›ä¸€æ­¥è°ƒæ•´å†…å­˜åˆ†é…ç­–ç•¥ alloc_flags ä½¿ç”¨æ›´åŠ æ¿€è¿›çš„éå¸¸æ‰‹æ®µè¿›è¡Œå†…å­˜åˆ†é… ...........</span><br><span class="line">        ......... åœ¨å†…å­˜åˆ†é…æ—¶å¿½ç•¥å†…å­˜æ°´ä½çº¿ ...........</span><br><span class="line">        ......... è§¦å‘ç›´æ¥å†…å­˜å›æ”¶ direct_reclaim ...........</span><br><span class="line">        ......... å†æ¬¡è§¦å‘ç›´æ¥å†…å­˜æ•´ç† direct_compact ...........</span><br><span class="line">        ......... æœ€åçš„æ€æ‰‹é”è§¦å‘ OOM æœºåˆ¶  ...........</span><br><span class="line"></span><br><span class="line">nopage:</span><br><span class="line">        ......... ç»è¿‡ä»¥ä¸Šæ¿€è¿›çš„å†…å­˜åˆ†é…æ‰‹æ®µä»ç„¶æ— æ³•æ»¡è¶³å†…å­˜åˆ†é…å°±ä¼šæ¥åˆ°è¿™é‡Œ ......</span><br><span class="line">        ......... å¦‚æœè®¾ç½®äº† __GFP_NOFAIL ä¸å…è®¸å†…å­˜åˆ†é…å¤±è´¥ï¼Œåˆ™ä¸åœé‡è¯•ä¸Šè¿°å†…å­˜åˆ†é…è¿‡ç¨‹ ......</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">        ......... å†…å­˜åˆ†é…å¤±è´¥ï¼Œè¾“å‡ºå‘Šè­¦ä¿¡æ¯ ........</span><br><span class="line"></span><br><span class="line">      warn_alloc(gfp_mask, ac-&gt;nodemask,</span><br><span class="line">            <span class="string">&quot;page allocation failure: order:%u&quot;</span>, order);</span><br><span class="line">got_pg:</span><br><span class="line">        ......... å†…å­˜åˆ†é…æˆåŠŸï¼Œè¿”å›æ–°ç”³è¯·çš„å†…å­˜å— ........</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æºä»£ç åˆ†æ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *</span></span><br><span class="line"><span class="class">__<span class="title">alloc_pages_slowpath</span>(<span class="title">gfp_t</span> <span class="title">gfp_mask</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>,</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_context</span> *<span class="title">ac</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">åˆå§‹åŒ–æ…¢é€Ÿå†…å­˜åˆ†é…è·¯å¾„ä¸‹çš„ç›¸å…³å‚æ•°</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">bool</span> can_direct_reclaim = gfp_mask &amp; __GFP_DIRECT_RECLAIM;</span><br><span class="line"><span class="comment">//orderå¤§äº3æ—¶ï¼Œå³åˆ†é…8ä¸ªé¡µé¢æ—¶ï¼Œè®¤ä¸ºè¿™ä¸ªåˆ†é…æ˜¯costlyçš„ï¼Œåç»­ä¼šæ ¹æ® costly_orderå†³å®šæ˜¯å¦è§¦å‘ OOM </span></span><br><span class="line"><span class="type">const</span> <span class="type">bool</span> costly_order = order &gt; PAGE_ALLOC_COSTLY_ORDER;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// å†…å­˜åˆ†é…æ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> alloc_flags;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">å½“å†…å­˜ä¸¥é‡ä¸è¶³çš„æ—¶å€™ï¼Œå†…æ ¸ä¼šå¼€å¯ç›´æ¥å†…å­˜å›æ”¶ direct_reclaimï¼Œ</span></span><br><span class="line"><span class="comment">å‚æ•° did_some_progress è¡¨ç¤ºç»è¿‡ä¸€æ¬¡ç›´æ¥å†…å­˜å›æ”¶ä¹‹åï¼Œå†…æ ¸å›æ”¶äº†å¤šå°‘ä¸ªå†…å­˜é¡µ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> did_some_progress;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">compact_priority</span> <span class="title">compact_priority</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">compact_result</span> <span class="title">compact_result</span>;</span></span><br><span class="line"><span class="type">int</span> compaction_retries;</span><br><span class="line">    <span class="comment">// è®°å½•é‡è¯•çš„æ¬¡æ•°ï¼Œè¶…è¿‡16æ¬¡å°±å†…å­˜åˆ†é…å¤±è´¥</span></span><br><span class="line"><span class="type">int</span> no_progress_loops;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> cpuset_mems_cookie;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> zonelist_iter_cookie;</span><br><span class="line">    <span class="comment">// ä¸´æ—¶ä¿å­˜è°ƒæ•´åçš„å†…å­˜åˆ†é…ç­–ç•¥</span></span><br><span class="line"><span class="type">int</span> reserve_flags;</span><br><span class="line">    <span class="comment">/* å½“ATOMICå’ŒDIRECT_RECLAIMåŒæ—¶è®¾ç½®æ—¶ï¼Œå–æ¶ˆå¯¹ATOMICçš„è®¾ç½®</span></span><br><span class="line"><span class="comment">    å› ä¸ºæ¥ä¸‹æ¥çš„ç›´æ¥å†…å­˜å›æ”¶éå¸¸è€—æ—¶å¯èƒ½ä¼šå¯¼è‡´è¿›ç¨‹é˜»å¡ç¡çœ ï¼Œä¸é€‚ç”¨åŸå­__GFP_ATOMIC</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">if</span> (WARN_ON_ONCE((gfp_mask &amp; (__GFP_ATOMIC|__GFP_DIRECT_RECLAIM)) ==</span><br><span class="line">(__GFP_ATOMIC|__GFP_DIRECT_RECLAIM)))</span><br><span class="line">gfp_mask &amp;= ~__GFP_ATOMIC;</span><br><span class="line"></span><br><span class="line">restart:</span><br><span class="line">compaction_retries = <span class="number">0</span>;</span><br><span class="line">no_progress_loops = <span class="number">0</span>;</span><br><span class="line">compact_priority = DEF_COMPACT_PRIORITY;</span><br><span class="line">cpuset_mems_cookie = read_mems_allowed_begin();</span><br><span class="line">zonelist_iter_cookie = zonelist_iter_begin();</span><br><span class="line"><span class="comment">// åœ¨æ…¢é€Ÿå†…å­˜åˆ†é…è·¯å¾„ä¸‹éœ€è¦é‡æ–°è®¾ç½®æ›´åŠ æ¿€è¿›çš„å†…å­˜åˆ†é…ç­–ç•¥ï¼Œé‡‡ç”¨æ›´å¤§çš„ä»£ä»·æ¥åˆ†é…å†…å­˜</span></span><br><span class="line">alloc_flags = gfp_to_alloc_flags(gfp_mask);</span><br><span class="line"><span class="comment">// é‡æ–°æŒ‰ç…§æ–°çš„è®¾ç½®æŒ‰ç…§å†…å­˜åŒºåŸŸä¼˜å…ˆçº§è®¡ç®— zonelist çš„è¿­ä»£èµ·ç‚¹ï¼ˆæœ€é«˜ä¼˜å…ˆçº§çš„ zoneï¼‰</span></span><br><span class="line">ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,</span><br><span class="line">ac-&gt;highest_zoneidx, ac-&gt;nodemask);</span><br><span class="line"><span class="keyword">if</span> (!ac-&gt;preferred_zoneref-&gt;zone)</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"><span class="comment">// å”¤é†’æ‰€æœ‰çš„ kswapd è¿›ç¨‹å¼‚æ­¥å›æ”¶å†…å­˜</span></span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_KSWAPD) </span><br><span class="line">wake_all_kswapds(order, gfp_mask, ac);</span><br><span class="line"><span class="comment">// åœ¨å¯¹alloc_flagsè°ƒæ•´åï¼Œé‡æ–°å°è¯•é¡µé¢åˆ†é…</span></span><br><span class="line">page = get_page_from_freelist(gfp_mask, order, alloc_flags, ac);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*é…å¤§å†…å­˜æ¥è¯´ costly_order = true (è¶…è¿‡ 8 ä¸ªå†…å­˜é¡µ)ï¼Œéœ€è¦é¦–å…ˆè¿›è¡Œå†…å­˜æ•´ç†ï¼Œè¿™æ ·å†…æ ¸å¯ä»¥é¿å…ç›´æ¥å†…å­˜å›æ”¶ä»è€Œè·å–æ›´å¤šçš„è¿ç»­ç©ºé—²å†…å­˜é¡µï¼›</span></span><br><span class="line"><span class="comment">    å¯¹äºéœ€è¦åˆ†é…ä¸å¯ç§»åŠ¨çš„é«˜é˜¶å†…å­˜çš„æƒ…å†µï¼Œä¹Ÿéœ€è¦å…ˆè¿›è¡Œå†…å­˜æ•´ç†ï¼Œé˜²æ­¢æ°¸ä¹…å†…å­˜ç¢ç‰‡*/</span></span><br><span class="line"><span class="keyword">if</span> (can_direct_reclaim &amp;&amp;</span><br><span class="line">(costly_order ||</span><br><span class="line">   (order &gt; <span class="number">0</span> &amp;&amp; ac-&gt;migratetype != MIGRATE_MOVABLE))</span><br><span class="line">&amp;&amp; !gfp_pfmemalloc_allowed(gfp_mask)) &#123;</span><br><span class="line">        <span class="comment">// è¿›è¡Œç›´æ¥å†…å­˜æ•´ç†ï¼Œè·å–æ›´å¤šçš„è¿ç»­ç©ºé—´å†…å­˜é˜²æ­¢å†…å­˜ç¢ç‰‡</span></span><br><span class="line">page = __alloc_pages_direct_compact(gfp_mask, order,</span><br><span class="line">alloc_flags, ac,</span><br><span class="line">INIT_COMPACT_PRIORITY,</span><br><span class="line">&amp;compact_result);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (costly_order &amp;&amp; (gfp_mask &amp; __GFP_NORETRY)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (compact_result == COMPACT_SKIPPED ||</span><br><span class="line">    compact_result == COMPACT_DEFERRED)</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line">compact_priority = INIT_COMPACT_PRIORITY;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">retry:</span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_KSWAPD)  <span class="comment">// ç¡®ä¿æ‰€æœ‰ kswapd è¿›ç¨‹ä¸è¦æ„å¤–è¿›å…¥ç¡çœ çŠ¶æ€</span></span><br><span class="line">wake_all_kswapds(order, gfp_mask, ac);</span><br><span class="line"><span class="comment">// å¿½ç•¥æ‰å†…å­˜æ°´ä½çº¿ï¼Œç»§ç»­ä¿®æ”¹ alloc_flags ä¿å­˜åœ¨ reserve_flags ä¸­</span></span><br><span class="line">reserve_flags = __gfp_pfmemalloc_flags(gfp_mask);</span><br><span class="line"><span class="keyword">if</span> (reserve_flags)</span><br><span class="line">alloc_flags = gfp_to_alloc_flags_cma(gfp_mask, reserve_flags);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(alloc_flags &amp; ALLOC_CPUSET) || reserve_flags) &#123;</span><br><span class="line">ac-&gt;nodemask = <span class="literal">NULL</span>;</span><br><span class="line">ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,</span><br><span class="line">ac-&gt;highest_zoneidx, ac-&gt;nodemask);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Attempt with potentially adjusted zonelist and alloc_flags */</span></span><br><span class="line">page = get_page_from_freelist(gfp_mask, order, alloc_flags, ac);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­å…ä¸å…è®¸ç›´æ¥å›æ”¶</span></span><br><span class="line"><span class="keyword">if</span> (!can_direct_reclaim)</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¿å…ç›´æ¥å›æ”¶çš„é€’å½’</span></span><br><span class="line"><span class="keyword">if</span> (current-&gt;flags &amp; PF_MEMALLOC)</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°è¯•ç›´æ¥å†…å­˜å›æ”¶</span></span><br><span class="line">page = __alloc_pages_direct_reclaim(gfp_mask, order, alloc_flags, ac,</span><br><span class="line">&amp;did_some_progress);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœè¿˜æ˜¯æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å¯ä¾›åˆ†é…çš„è¯ï¼Œé‚£ä¹ˆå†…æ ¸ä¼šå†æ¬¡è¿›è¡Œç›´æ¥å†…å­˜æ•´ç† direct_compact</span></span><br><span class="line">page = __alloc_pages_direct_compact(gfp_mask, order, alloc_flags, ac,</span><br><span class="line">compact_priority, &amp;compact_result);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Do not loop if specifically requested */</span></span><br><span class="line"><span class="keyword">if</span> (gfp_mask &amp; __GFP_NORETRY) <span class="comment">// å†…å­˜åˆ†é…å¤±è´¥æ—¶ï¼Œä¸å…è®¸é‡è¯•</span></span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// å½“æ­¤æ¬¡åˆ†é…è¶…è¿‡8ä¸ªé¡µæ—¶ï¼Œå°±ä¸ä¼šè§¦å‘OOMï¼Œé™¤éæ²¡æœ‰è®¾ç½®__GFP_RETRY_MAYFAIL</span></span><br><span class="line"><span class="keyword">if</span> (costly_order &amp;&amp; !(gfp_mask &amp; __GFP_RETRY_MAYFAIL))</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">å¦‚æœå†…æ ¸å·²ç»é‡è¯•äº†MAX_RECLAIM_RETRIES(16)æ¬¡ä»ç„¶å¤±è´¥ï¼Œåˆ™æ”¾å¼ƒé‡è¯•ï¼Œæ‰§è¡Œåç»­OOM</span></span><br><span class="line"><span class="comment">å¦‚æœå†…æ ¸å°†æ‰€æœ‰å¯é€‰å†…å­˜åŒºåŸŸä¸­çš„æ‰€æœ‰å¯å›æ”¶é¡µé¢å…¨éƒ¨å›æ”¶ä¹‹åï¼Œä»ç„¶æ— æ³•æ»¡è¶³å†…å­˜åˆ†é…ï¼Œé‚£ä¹ˆæ”¾å¼ƒé‡è¯•ï¼Œæ‰§è¡Œåç»­OOM</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">if</span> (should_reclaim_retry(gfp_mask, order, ac, alloc_flags,</span><br><span class="line"> did_some_progress &gt; <span class="number">0</span>, &amp;no_progress_loops))</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœç»è¿‡å›æ”¶åï¼Œdid_some_progress = 0,åˆ™æ²¡æœ‰å¿…è¦è¿›è¡Œå†…å­˜æ•´ç†çš„é‡è¯•äº†</span></span><br><span class="line"><span class="keyword">if</span> (did_some_progress &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">should_compact_retry(ac, order, alloc_flags,</span><br><span class="line">compact_result, &amp;compact_priority,</span><br><span class="line">&amp;compaction_retries))</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Deal with possible cpuset update races or zonelist updates to avoid</span></span><br><span class="line"><span class="comment"> * a unnecessary OOM kill.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (check_retry_cpuset(cpuset_mems_cookie, ac) ||</span><br><span class="line">    check_retry_zonelist(zonelist_iter_cookie))</span><br><span class="line"><span class="keyword">goto</span> restart;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿›è¡Œ OOMï¼Œé€‰æ‹©ä¸€ä¸ªå¾—åˆ†æœ€é«˜çš„è¿›ç¨‹ï¼Œé‡Šæ”¾å…¶å ç”¨çš„å†…å­˜ </span></span><br><span class="line">page = __alloc_pages_may_oom(gfp_mask, order, ac, &amp;did_some_progress);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Avoid allocations with no watermarks from looping endlessly */</span></span><br><span class="line"><span class="keyword">if</span> (tsk_is_oom_victim(current) &amp;&amp;</span><br><span class="line">    (alloc_flags &amp; ALLOC_OOM ||</span><br><span class="line">     (gfp_mask &amp; __GFP_NOMEMALLOC)))</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åªè¦ oom äº§ç”Ÿäº†ä½œç”¨å¹¶é‡Šæ”¾äº†å†…å­˜ did_some_progress &gt; 0 å°±ä¸æ–­çš„è¿›è¡Œé‡è¯•</span></span><br><span class="line"><span class="keyword">if</span> (did_some_progress) &#123;</span><br><span class="line">no_progress_loops = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nopage:</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Deal with possible cpuset update races or zonelist updates to avoid</span></span><br><span class="line"><span class="comment"> * a unnecessary OOM kill.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (check_retry_cpuset(cpuset_mems_cookie, ac) ||</span><br><span class="line">    check_retry_zonelist(zonelist_iter_cookie))</span><br><span class="line"><span class="keyword">goto</span> restart;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Make sure that __GFP_NOFAIL request doesn&#x27;t leak out and make sure</span></span><br><span class="line"><span class="comment"> * we always retry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//æµç¨‹èµ°åˆ°è¿™é‡Œè¡¨æ˜å†…æ ¸å·²ç»å°è¯•äº†åŒ…æ‹¬ OOM åœ¨å†…çš„æ‰€æœ‰å›æ”¶å†…å­˜çš„åŠ¨ä½œã€‚</span></span><br><span class="line"><span class="comment">// ä½†æ˜¯è¿™äº›æªæ–½ä¾ç„¶æ— æ³•æ»¡è¶³å†…å­˜åˆ†é…çš„éœ€æ±‚ï¼Œçœ‹ä¸Šå»å†…å­˜åˆ†é…åˆ°è¿™é‡Œå°±åº”è¯¥å¤±è´¥äº†ã€‚</span></span><br><span class="line"><span class="comment">// ä½†æ˜¯å¦‚æœè®¾ç½®äº† __GFP_NOFAIL è¡¨ç¤ºä¸å…è®¸å†…å­˜åˆ†é…å¤±è´¥ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±ä¼šè¿›å…¥ if åˆ†æ”¯è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="keyword">if</span> (gfp_mask &amp; __GFP_NOFAIL) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * All existing users of the __GFP_NOFAIL are blockable, so warn</span></span><br><span class="line"><span class="comment"> * of any new users that actually require GFP_NOWAIT</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (WARN_ON_ONCE(!can_direct_reclaim))</span><br><span class="line"><span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * PF_MEMALLOC request from this context is rather bizarre</span></span><br><span class="line"><span class="comment"> * because we cannot reclaim anything and only can loop waiting</span></span><br><span class="line"><span class="comment"> * for somebody to do a work for us</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">WARN_ON_ONCE(current-&gt;flags &amp; PF_MEMALLOC);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * non failing costly orders are a hard requirement which we</span></span><br><span class="line"><span class="comment"> * are not prepared for much so let&#x27;s warn about these users</span></span><br><span class="line"><span class="comment"> * so that we can identify them and convert them to something</span></span><br><span class="line"><span class="comment"> * else.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">WARN_ON_ONCE(order &gt; PAGE_ALLOC_COSTLY_ORDER);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Help non-failing allocations by giving them access to memory</span></span><br><span class="line"><span class="comment"> * reserves but do not use ALLOC_NO_WATERMARKS because this</span></span><br><span class="line"><span class="comment"> * could deplete whole memory reserves which would just make</span></span><br><span class="line"><span class="comment"> * the situation worse</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// å°è¯•è¿›è¡Œè·¨NUMAèŠ‚ç‚¹çš„å†…å­˜åˆ†é…</span></span><br><span class="line">page = __alloc_pages_cpuset_fallback(gfp_mask, order, ALLOC_HARDER, ac);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"> <span class="comment">/* </span></span><br><span class="line"><span class="comment">åœ¨è¿›è¡Œå†…å­˜åˆ†é…é‡è¯•æµç¨‹ä¹‹å‰ï¼Œä½¿ç”¨cond_resched()è®© CPU é‡æ–°è°ƒåº¦åˆ°å…¶ä»–è¿›ç¨‹ä¸Š</span></span><br><span class="line"><span class="comment">        è¿è¡Œä¸€ä¼šå…¶ä»–è¿›ç¨‹ï¼Œå› ä¸ºæ¯•ç«Ÿæ­¤æ—¶å†…å­˜å·²ç»ä¸¥é‡ä¸è¶³</span></span><br><span class="line"><span class="comment">        ç«‹é©¬é‡è¯•çš„è¯åªèƒ½æµªè´¹è¿‡å¤šæ—¶é—´åœ¨æœç´¢ç©ºé—²å†…å­˜ä¸Šï¼Œå¯¼è‡´å…¶ä»–è¿›ç¨‹å¤„äºé¥¥é¥¿çŠ¶æ€ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">cond_resched();</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line">fail:</span><br><span class="line">warn_alloc(gfp_mask, ac-&gt;nodemask,</span><br><span class="line"><span class="string">&quot;page allocation failure: order:%u&quot;</span>, order);</span><br><span class="line">got_pg:</span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> <span class="title function_">prepare_alloc_pages</span><span class="params">(<span class="type">gfp_t</span> gfp_mask, <span class="type">unsigned</span> <span class="type">int</span> order,</span></span><br><span class="line"><span class="params"><span class="type">int</span> preferred_nid, <span class="type">nodemask_t</span> *nodemask,</span></span><br><span class="line"><span class="params"><span class="keyword">struct</span> alloc_context *ac, <span class="type">gfp_t</span> *alloc_gfp,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">int</span> *alloc_flags)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// ä»gfp_maskä¸­è·å–å†…å­˜åˆ†é…æœ€é«˜ä¼˜å…ˆçº§çš„åŒºåŸŸzone</span></span><br><span class="line">ac-&gt;highest_zoneidx = gfp_zone(gfp_mask);  </span><br><span class="line"><span class="comment">// ä» NUMA èŠ‚ç‚¹çš„å¤‡ç”¨èŠ‚ç‚¹é“¾è¡¨ä¸­ä¸€æ¬¡æ€§è·å–å…è®¸è¿›è¡Œå†…å­˜åˆ†é…çš„æ‰€æœ‰å†…å­˜åŒºåŸŸ</span></span><br><span class="line">ac-&gt;zonelist = node_zonelist(preferred_nid, gfp_mask);</span><br><span class="line">ac-&gt;nodemask = nodemask;</span><br><span class="line">ac-&gt;migratetype = gfp_migratetype(gfp_mask);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cpusets_enabled()) &#123;</span><br><span class="line">*alloc_gfp |= __GFP_HARDWALL;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * When we are in the interrupt context, it is irrelevant</span></span><br><span class="line"><span class="comment"> * to the current task context. It means that any node ok.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (in_task() &amp;&amp; !ac-&gt;nodemask)</span><br><span class="line">ac-&gt;nodemask = &amp;cpuset_current_mems_allowed;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">*alloc_flags |= ALLOC_CPUSET;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fs_reclaim_acquire(gfp_mask);</span><br><span class="line">fs_reclaim_release(gfp_mask);</span><br><span class="line"><span class="comment">// å¦‚æœè®¾ç½®äº†å…è®¸ç›´æ¥å†…å­˜å›æ”¶ï¼Œé‚£ä¹ˆå†…å­˜åˆ†é…è¿›ç¨‹åˆ™å¯èƒ½ä¼šå¯¼è‡´ä¼‘çœ è¢«é‡æ–°è°ƒåº¦ </span></span><br><span class="line">might_sleep_if(gfp_mask &amp; __GFP_DIRECT_RECLAIM);</span><br><span class="line"><span class="comment">// æå‰åˆ¤æ–­æœ¬æ¬¡å†…å­˜åˆ†é…æ˜¯å¦èƒ½å¤ŸæˆåŠŸï¼Œå¦‚æœä¸èƒ½åˆ™å°½æ—©å¤±è´¥</span></span><br><span class="line"><span class="keyword">if</span> (should_fail_alloc_page(gfp_mask, order))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">*alloc_flags = gfp_to_alloc_flags_cma(gfp_mask, *alloc_flags);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Dirty zone balancing only done in the fast path */</span></span><br><span class="line">ac-&gt;spread_dirty_pages = (gfp_mask &amp; __GFP_WRITE);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The preferred zone is used for statistics but crucially it is</span></span><br><span class="line"><span class="comment"> * also used as the starting point for the zonelist iterator. It</span></span><br><span class="line"><span class="comment"> * may get reset for allocations that ignore memory policies.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,</span><br><span class="line">ac-&gt;highest_zoneidx, ac-&gt;nodemask);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ç›¸å…³çš„å‡ ä¸ªå‡½æ•°ï¼š</p><p><strong><code>gfp_to_alloc_flags</code>å‡½æ•°æ›´æ”¹åˆ†é…ç­–ç•¥</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">unsigned</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">gfp_to_alloc_flags</span><span class="params">(<span class="type">gfp_t</span> gfp_mask)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> alloc_flags = ALLOC_WMARK_MIN | ALLOC_CPUSET;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * __GFP_HIGH is assumed to be the same as ALLOC_HIGH</span></span><br><span class="line"><span class="comment"> * and __GFP_KSWAPD_RECLAIM is assumed to be the same as ALLOC_KSWAPD</span></span><br><span class="line"><span class="comment"> * to save two branches.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BUILD_BUG_ON(__GFP_HIGH != (__force <span class="type">gfp_t</span>) ALLOC_HIGH);</span><br><span class="line">BUILD_BUG_ON(__GFP_KSWAPD_RECLAIM != (__force <span class="type">gfp_t</span>) ALLOC_KSWAPD);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The caller may dip into page reserves a bit more if the caller</span></span><br><span class="line"><span class="comment"> * cannot run direct reclaim, or if the caller has realtime scheduling</span></span><br><span class="line"><span class="comment"> * policy or is asking for __GFP_HIGH memory.  GFP_ATOMIC requests will</span></span><br><span class="line"><span class="comment"> * set both ALLOC_HARDER (__GFP_ATOMIC) and ALLOC_HIGH (__GFP_HIGH).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">alloc_flags |= (__force <span class="type">int</span>)</span><br><span class="line">(gfp_mask &amp; (__GFP_HIGH | __GFP_KSWAPD_RECLAIM));</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœå†…å­˜åˆ†é…æ˜¯åŸå­çš„è¯ï¼Œåˆ™åœ¨å†…å­˜ä¸å¤Ÿçš„æ—¶å€™ï¼Œå¯ä»¥ä»ç´§æ€¥é¢„ç•™å†…å­˜ä¸­åˆ†é…</span></span><br><span class="line"><span class="keyword">if</span> (gfp_mask &amp; __GFP_ATOMIC) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">__GFP_NOMEMALLOCè¡¨ç¤ºç¦æ­¢ä»ç´§æ€¥é¢„ç•™çš„å†…å­˜ä¸­åˆ†é…ï¼Œä¼˜å…ˆçº§æ¯”__GFP_MEMALLOCé«˜ï¼Œ</span></span><br><span class="line"><span class="comment"> å› æ­¤è¿™é‡Œæ˜¯ä¸__GFP_NOMEMALLOCåšä¸æ“ä½œ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">if</span> (!(gfp_mask &amp; __GFP_NOMEMALLOC))</span><br><span class="line">alloc_flags |= ALLOC_HARDER; <span class="comment">//åç»­æ ¹æ® ALLOC_HARDER æ ‡è¯†ä¼šé™ä½ WMARK_LOW æ°´ä½çº¿</span></span><br><span class="line"> <span class="comment">// è¿™ç§æƒ…å†µä¸‹ä¸ºäº†å†…å­˜åˆ†é…çš„æˆåŠŸï¼Œä¼šå»é™¤æ‰ CPUSET çš„é™åˆ¶ï¼Œå¯ä»¥åœ¨æ‰€æœ‰ NUMA èŠ‚ç‚¹ä¸Šåˆ†é…å†…å­˜</span></span><br><span class="line">alloc_flags &amp;= ~ALLOC_CPUSET;</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">// å¦‚æœå½“å‰è¿›ç¨‹æ˜¯å®æ—¶ä»»åŠ¡ï¼ˆå¯èƒ½ä¸å¤ªå¯èƒ½å‘ç”Ÿçš„æƒ…å†µï¼‰ï¼Œå¹¶ä¸”åœ¨ä»»åŠ¡çš„ä¸Šä¸‹æ–‡ä¸­,è®¾ç½®header</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (unlikely(rt_task(current)) &amp;&amp; in_task())</span><br><span class="line">alloc_flags |= ALLOC_HARDER;</span><br><span class="line"></span><br><span class="line">alloc_flags = gfp_to_alloc_flags_cma(gfp_mask, alloc_flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> alloc_flags;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>__gfp_pfmemalloc_flags</code>å‡½æ•°</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> __gfp_pfmemalloc_flags(<span class="type">gfp_t</span> gfp_mask)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// å¦‚æœä¸å…è®¸ä»ç´§æ€¥é¢„ç•™å†…å­˜ä¸­åˆ†é…ï¼Œå°±ä¸æ”¹å˜alloc_flag</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(gfp_mask &amp; __GFP_NOMEMALLOC)) </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">// å¦‚æœå…è®¸ä»ç´§æ€¥é¢„ç•™å†…å­˜ä¸­åˆ†é…ï¼Œåˆ™åé¢çš„å†…å­˜åˆ†é…ä¼šå¿½ç•¥å†…å­˜æ°´ä½çº¿çš„é™åˆ¶</span></span><br><span class="line"><span class="keyword">if</span> (gfp_mask &amp; __GFP_MEMALLOC)</span><br><span class="line"><span class="keyword">return</span> ALLOC_NO_WATERMARKS;</span><br><span class="line"><span class="comment">// å½“å‰è¿›ç¨‹å¤„äºè½¯ä¸­æ–­ä¸Šä¸‹æ–‡å¹¶ä¸”è¿›ç¨‹è®¾ç½®äº† PF_MEMALLOC æ ‡è¯†</span></span><br><span class="line"><span class="keyword">if</span> (in_serving_softirq() &amp;&amp; (current-&gt;flags &amp; PF_MEMALLOC))</span><br><span class="line"><span class="keyword">return</span> ALLOC_NO_WATERMARKS;</span><br><span class="line"><span class="comment">// å½“å‰è¿›ç¨‹ä¸åœ¨ä»»ä½•ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­</span></span><br><span class="line"><span class="keyword">if</span> (!in_interrupt()) &#123;</span><br><span class="line"><span class="keyword">if</span> (current-&gt;flags &amp; PF_MEMALLOC)</span><br><span class="line"><span class="keyword">return</span> ALLOC_NO_WATERMARKS;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (oom_reserves_allowed(current)) <span class="comment">// å½“å‰è¿›ç¨‹å…è®¸è¿›è¡Œ OOM</span></span><br><span class="line"><span class="keyword">return</span> ALLOC_OOM;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†…å­˜åˆ†é…æµç¨‹å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202312311639085.png" alt="640 (2)"></p>]]></content>
      
      
      <categories>
          
          <category> Linuxå†…æ ¸ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Linuxè™šæ‹Ÿå†…å­˜ç®¡ç†(æºç é˜…è¯»1)</title>
      <link href="/2023/12/25/Linux%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86(%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB1)/"/>
      <url>/2023/12/25/Linux%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86(%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB1)/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨è™šæ‹Ÿå†…å­˜"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨è™šæ‹Ÿå†…å­˜" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨è™šæ‹Ÿå†…å­˜"></a>ä¸ºä»€ä¹ˆä½¿ç”¨è™šæ‹Ÿå†…å­˜</h2><p>ä¸€å¥è¯ï¼šå¼•å…¥è™šæ‹Ÿå†…å­˜åï¼Œè¿›ç¨‹ä¸è¿›ç¨‹ä¹‹é—´çš„è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´æ˜¯ç›¸äº’éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°çš„ã€‚</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202312251453156.png" alt="640"></p><h2 id="è™šæ‹Ÿå†…å­˜åœ°å€æ ¼å¼"><a href="#è™šæ‹Ÿå†…å­˜åœ°å€æ ¼å¼" class="headerlink" title="è™šæ‹Ÿå†…å­˜åœ°å€æ ¼å¼"></a>è™šæ‹Ÿå†…å­˜åœ°å€æ ¼å¼</h2><p>éƒ½ä»¥4Kä¸ºåŸºæœ¬é¡µæ¡†å¤§å°</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202312251455900.png" alt="image-20231225145536867"></p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202312251455383.png" alt="image-20231225145517347"></p><h2 id="è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´"><a href="#è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´" class="headerlink" title="è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´"></a>è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´</h2><h3 id="ç”¨æˆ·ç©ºé—´"><a href="#ç”¨æˆ·ç©ºé—´" class="headerlink" title="ç”¨æˆ·ç©ºé—´"></a>ç”¨æˆ·ç©ºé—´</h3><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202312251458277.png" alt="640 (1)"></p><ul><li>ç”¨äºå­˜æ”¾è¿›ç¨‹ç¨‹åºäºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„æœºå™¨æŒ‡ä»¤çš„ä»£ç æ®µ</li><li>ç”¨äºå­˜æ”¾ç¨‹åºäºŒè¿›åˆ¶æ–‡ä»¶ä¸­å®šä¹‰çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡çš„æ•°æ®æ®µå’Œ BSS æ®µã€‚å…¶ä¸­æ•°æ®æ®µä¸­ä¸ºæŒ‡å®šäº†åˆå§‹å€¼çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼›BSSæ®µä¸­ä¸ºä¸ºæŒ‡å®šåˆå§‹å€¼çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼ˆåˆå§‹åŒ–ä¸º0ï¼‰</li><li>ç”¨äºåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€ç”³è¯·å†…å­˜çš„å †ã€‚å †ç©ºé—´ä¸­åœ°å€çš„å¢é•¿æ–¹å‘æ˜¯ä»ä½åœ°å€åˆ°é«˜åœ°å€å¢é•¿ã€‚</li><li>ç”¨äºå­˜æ”¾åŠ¨æ€é“¾æ¥åº“ä»¥åŠå†…å­˜æ˜ å°„åŒºåŸŸçš„æ–‡ä»¶æ˜ å°„ä¸åŒ¿åæ˜ å°„åŒºã€‚</li><li>ç”¨äºå­˜æ”¾å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­çš„å±€éƒ¨å˜é‡å’Œå‡½æ•°å‚æ•°çš„æ ˆã€‚</li></ul><h3 id="è™šæ‹Ÿå†…å­˜ç©ºé—´åˆ†å¸ƒ"><a href="#è™šæ‹Ÿå†…å­˜ç©ºé—´åˆ†å¸ƒ" class="headerlink" title="è™šæ‹Ÿå†…å­˜ç©ºé—´åˆ†å¸ƒ"></a>è™šæ‹Ÿå†…å­˜ç©ºé—´åˆ†å¸ƒ</h3><p>è™šæ‹Ÿå†…å­˜ç©ºé—´åŒ…æ‹¬ç”¨æˆ·æ€å’Œå†…æ ¸æ€ã€‚</p><h4 id="32ä½æœºå™¨"><a href="#32ä½æœºå™¨" class="headerlink" title="32ä½æœºå™¨"></a>32ä½æœºå™¨</h4><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202312251503730.png" alt="640 (2)"></p><p>ç”¨æˆ·æ€è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­çš„ä»£ç æ®µå¹¶ä¸æ˜¯ä» 0x0000 0000 åœ°å€å¼€å§‹çš„ï¼Œè€Œæ˜¯ä» 0x0804 8000 åœ°å€å¼€å§‹ã€‚</p><p>0x0000 0000 åˆ° 0x0804 8000 è¿™æ®µè™šæ‹Ÿå†…å­˜åœ°å€æ˜¯ä¸€æ®µä¸å¯è®¿é—®çš„ä¿ç•™åŒºï¼Œå› ä¸ºåœ¨å¤§å¤šæ•°æ“ä½œç³»ç»Ÿä¸­ï¼Œæ•°å€¼æ¯”è¾ƒå°çš„åœ°å€é€šå¸¸è¢«è®¤ä¸ºä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„åœ°å€ï¼Œè¿™å—å°åœ°å€æ˜¯ä¸å…è®¸è®¿é—®çš„ã€‚æ¯”å¦‚åœ¨ C è¯­è¨€ä¸­æˆ‘ä»¬é€šå¸¸ä¼šå°†ä¸€äº›æ— æ•ˆçš„æŒ‡é’ˆè®¾ç½®ä¸º NULLï¼ŒæŒ‡å‘è¿™å—ä¸å…è®¸è®¿é—®çš„åœ°å€ã€‚</p><p>BSS æ®µçš„ä¸Šè¾¹å°±æ˜¯æˆ‘ä»¬ç»å¸¸ä½¿ç”¨åˆ°çš„å †ç©ºé—´ï¼Œä»å›¾ä¸­çš„çº¢è‰²ç®­å¤´æˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨<strong>å †ç©ºé—´ä¸­åœ°å€çš„å¢é•¿æ–¹å‘æ˜¯ä»ä½åœ°å€åˆ°é«˜åœ°å€å¢é•¿</strong>ã€‚</p><p>å†…æ ¸ä¸­ä½¿ç”¨ start_brk æ ‡è¯†å †çš„èµ·å§‹ä½ç½®ï¼Œbrk æ ‡è¯†å †å½“å‰çš„ç»“æŸä½ç½®ã€‚å½“å †ç”³è¯·æ–°çš„å†…å­˜ç©ºé—´æ—¶ï¼Œåªéœ€è¦å°† brk æŒ‡é’ˆå¢åŠ å¯¹åº”çš„å¤§å°ï¼Œå›æ”¶åœ°å€æ—¶å‡å°‘å¯¹åº”çš„å¤§å°å³å¯ã€‚æ¯”å¦‚å½“æˆ‘ä»¬é€šè¿‡ malloc å‘å†…æ ¸ç”³è¯·å¾ˆå°çš„ä¸€å—å†…å­˜æ—¶ï¼ˆ128K ä¹‹å†…ï¼‰ï¼Œå°±æ˜¯é€šè¿‡æ”¹å˜ brk ä½ç½®å®ç°çš„ã€‚</p><p>å †ç©ºé—´çš„ä¸Šè¾¹æ˜¯ä¸€æ®µå¾…åˆ†é…åŒºåŸŸï¼Œç”¨äºæ‰©å±•å †ç©ºé—´çš„ä½¿ç”¨ã€‚</p><p>æ¥ä¸‹æ¥å°±æ¥åˆ°äº†æ–‡ä»¶æ˜ å°„ä¸åŒ¿åæ˜ å°„åŒºåŸŸã€‚<strong>åœ¨æ–‡ä»¶æ˜ å°„ä¸åŒ¿åæ˜ å°„åŒºçš„åœ°å€å¢é•¿æ–¹å‘æ˜¯ä»é«˜åœ°å€å‘ä½åœ°å€å¢é•¿</strong>ã€‚</p><p>æ¥ä¸‹æ¥ç”¨æˆ·æ€è™šæ‹Ÿå†…å­˜ç©ºé—´çš„æœ€åä¸€å—åŒºåŸŸå°±æ˜¯æ ˆç©ºé—´äº†ï¼Œåœ¨è¿™é‡Œä¼šä¿å­˜å‡½æ•°è¿è¡Œè¿‡ç¨‹æ‰€éœ€è¦çš„å±€éƒ¨å˜é‡ä»¥åŠå‡½æ•°å‚æ•°ç­‰å‡½æ•°è°ƒç”¨ä¿¡æ¯ã€‚<strong>æ ˆç©ºé—´ä¸­çš„åœ°å€å¢é•¿æ–¹å‘æ˜¯ä»é«˜åœ°å€å‘ä½åœ°å€å¢é•¿</strong>ã€‚</p><p>åœ¨å†…æ ¸ä¸­ä½¿ç”¨ start_stack æ ‡è¯†æ ˆçš„èµ·å§‹ä½ç½®ï¼ŒRSP å¯„å­˜å™¨ä¸­ä¿å­˜æ ˆé¡¶æŒ‡é’ˆ stack pointerï¼ŒRBP å¯„å­˜å™¨ä¸­ä¿å­˜çš„æ˜¯æ ˆåŸºåœ°å€ã€‚åœ¨æ ˆç©ºé—´çš„ä¸‹è¾¹ä¹Ÿæœ‰ä¸€æ®µå¾…åˆ†é…åŒºåŸŸç”¨äºæ‰©å±•æ ˆç©ºé—´ã€‚</p><h4 id="64ä½æœºå™¨"><a href="#64ä½æœºå™¨" class="headerlink" title="64ä½æœºå™¨"></a>64ä½æœºå™¨</h4><p>è™½ç„¶64ä½æœºå™¨çš„æŒ‡é’ˆå¯»å€èŒƒå›´æ˜¯2^64,ä½†æ˜¯åœ¨ç›®å‰çš„ 64 ä½ç³»ç»Ÿä¸‹åªä½¿ç”¨äº† <strong>48 ä½æ¥æè¿°è™šæ‹Ÿå†…å­˜ç©ºé—´</strong>ï¼Œå¯»å€èŒƒå›´ä¸º  2^48 ï¼Œæ‰€èƒ½è¡¨è¾¾çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸º 256TBã€‚</p><p>å…¶ä¸­ä½ 128 T è¡¨ç¤ºç”¨æˆ·æ€è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œè™šæ‹Ÿå†…å­˜åœ°å€èŒƒå›´ä¸ºï¼š0x0000 0000 0000 0000  - 0x0000 7FFF FFFF F000 ã€‚</p><p>é«˜ 128 T è¡¨ç¤ºå†…æ ¸æ€è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œè™šæ‹Ÿå†…å­˜åœ°å€èŒƒå›´ä¸ºï¼š0xFFFF 8000 0000 0000  - 0xFFFF FFFF FFFF FFFF ã€‚</p><p>è¿™æ ·ä¸€æ¥å°±åœ¨ç”¨æˆ·æ€è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸å†…æ ¸æ€è™šæ‹Ÿå†…å­˜ç©ºé—´ä¹‹é—´å½¢æˆäº†ä¸€æ®µ 0x0000 7FFF FFFF F000  -  0xFFFF 8000 0000 0000  çš„åœ°å€ç©ºæ´ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªç©ºæ´å«åš canonical address ç©ºæ´</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202312251733199.png" alt="640 (4)"></p><p>å¦‚ä¸Šå›¾ï¼Œè¿˜å¯ä»¥çœ‹åˆ°ï¼šåœ¨ä»£ç æ®µè·Ÿæ•°æ®æ®µçš„ä¸­é—´è¿˜æœ‰ä¸€æ®µä¸å¯ä»¥è¯»å†™çš„ä¿æŠ¤æ®µï¼Œå®ƒçš„ä½œç”¨æ˜¯é˜²æ­¢ç¨‹åºåœ¨è¯»å†™æ•°æ®æ®µçš„æ—¶å€™è¶Šç•Œè®¿é—®åˆ°ä»£ç æ®µï¼Œè¿™ä¸ªä¿æŠ¤æ®µå¯ä»¥è®©è¶Šç•Œè®¿é—®è¡Œä¸ºç›´æ¥å´©æºƒï¼Œé˜²æ­¢å®ƒç»§ç»­å¾€ä¸‹è¿è¡Œã€‚</p><h3 id="å†…æ ¸ç©ºé—´"><a href="#å†…æ ¸ç©ºé—´" class="headerlink" title="å†…æ ¸ç©ºé—´"></a>å†…æ ¸ç©ºé—´</h3><p>å†…æ ¸æ€è™šæ‹Ÿå†…å­˜ç©ºé—´æ˜¯æ‰€æœ‰è¿›ç¨‹å…±äº«çš„ï¼Œä¸åŒè¿›ç¨‹è¿›å…¥å†…æ ¸æ€ä¹‹åçœ‹åˆ°çš„è™šæ‹Ÿå†…å­˜ç©ºé—´å…¨éƒ¨æ˜¯ä¸€æ ·çš„ã€‚</p><p>ç›´æ¥çœ‹å‚è€ƒæ–‡çŒ®ç¬¬7èŠ‚å§ï¼š<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&mid=2247486732&idx=1&sn=435d5e834e9751036c96384f6965b328&chksm=ce77cb4bf900425d33d2adfa632a4684cf7a63beece166c1ffedc4fdacb807c9413e8c73f298&token=1468822011&lang=zh_CN&scene=21#wechat_redirect">å‚è€ƒæ–‡çŒ®</a></p><h2 id="è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´çš„ç®¡ç†"><a href="#è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´çš„ç®¡ç†" class="headerlink" title="è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´çš„ç®¡ç†"></a>è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´çš„ç®¡ç†</h2><p>å†…æ ¸ä¸­çš„è¿›ç¨‹æè¿°ç¬¦<code>task_struct</code>ç»“æ„</p><p>åœ¨  <code>include/linux/sched.h</code>ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line"><span class="comment">// è¿›ç¨‹id</span></span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="comment">// è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ä¿¡æ¯</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span>  *<span class="title">files</span>;</span></span><br><span class="line">    <span class="comment">// è¯¥è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ç»“æ„ä½“æŒ‡é’ˆ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span>;</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>include/linux/mm_types.h</code>ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> task_size;  <span class="comment">// ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ†ç•Œçº¿</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨å¦‚ä¸‹å±æ€§å®šä¹‰è™šæ‹Ÿå†…å­˜ä¸­çš„ä¸åŒåŒºåŸŸ</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> start_code, end_code, start_data, end_data;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> start_brk, brk, start_stack;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> arg_start, arg_end, env_start, env_end;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> mmap_base;  <span class="comment">/* base of mmap area */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> total_vm;    <span class="comment">/* Total pages mapped */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> locked_vm;  <span class="comment">/* Pages that have PG_mlocked set */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> pinned_vm;  <span class="comment">/* Refcount permanently increased */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> data_vm;    <span class="comment">/* VM_WRITE &amp; ~VM_SHARED &amp; ~VM_STACK */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> exec_vm;    <span class="comment">/* VM_EXEC &amp; ~VM_WRITE &amp; ~VM_STACK */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> stack_vm;    <span class="comment">/* VM_STACK */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>task_sizeå®šä¹‰äº†ç”¨æˆ·æ€åœ°å€ç©ºé—´ä¸å†…æ ¸æ€åœ°å€ç©ºé—´ä¹‹é—´çš„åˆ†ç•Œçº¿ã€‚32 ä½ç³»ç»Ÿä¸­ç”¨æˆ·æ€è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸º 3 GBï¼Œè™šæ‹Ÿå†…å­˜åœ°å€èŒƒå›´ä¸ºï¼š0x0000 0000 - 0xC000 000 ã€‚å†…æ ¸æ€è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸º 1 GBï¼Œè™šæ‹Ÿå†…å­˜åœ°å€èŒƒå›´ä¸ºï¼š0xC000 000 - 0xFFFF FFFFã€‚32 ä½ç³»ç»Ÿä¸­task_size ä¸º 0xC000 000ã€‚åŒç†ï¼Œ64 ä½ç³»ç»Ÿä¸­ç”¨æˆ·åœ°å€ç©ºé—´å’Œå†…æ ¸åœ°å€ç©ºé—´çš„åˆ†ç•Œçº¿åœ¨  0x0000 7FFF FFFF F000 åœ°å€å¤„ï¼Œé‚£ä¹ˆè‡ªç„¶è¿›ç¨‹çš„ mm_struct ç»“æ„ä¸­çš„ task_size ä¸º 0x0000 7FFF FFFF F000 ã€‚</p><p>start_code å’Œ end_code å®šä¹‰ä»£ç æ®µçš„èµ·å§‹å’Œç»“æŸä½ç½®ï¼Œstart_data å’Œ end_data å®šä¹‰æ•°æ®æ®µçš„èµ·å§‹å’Œç»“æŸä½ç½®ï¼›start_brk å®šä¹‰å †çš„èµ·å§‹ä½ç½®ï¼Œbrk å®šä¹‰å †å½“å‰çš„ç»“æŸä½ç½®ï¼Œstart_stack æ˜¯æ ˆçš„èµ·å§‹ä½ç½®åœ¨RBPå¯„å­˜å™¨ä¸­ï¼Œæ ˆçš„ç»“æŸä½ç½®ä¹Ÿå°±æ˜¯æ ˆé¡¶æŒ‡é’ˆ stack pointer åœ¨ RSP å¯„å­˜å™¨ä¸­å­˜å‚¨ï¼›arg_start å’Œ arg_end æ˜¯å‚æ•°åˆ—è¡¨çš„ä½ç½®ï¼Œ env_start å’Œ env_end æ˜¯ç¯å¢ƒå˜é‡çš„ä½ç½®ã€‚å®ƒä»¬éƒ½ä½äºæ ˆä¸­çš„æœ€é«˜åœ°å€å¤„ï¼›mmap_base å®šä¹‰å†…å­˜æ˜ å°„åŒºçš„èµ·å§‹åœ°å€</p><p>è¿˜å®šä¹‰äº†ä¸€äº›è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜æ˜ å°„å†…å®¹ç›¸å…³çš„ç»Ÿè®¡å˜é‡ã€‚</p><p>mm_struct ç»“æ„ä½“ä¸­çš„ total_vm è¡¨ç¤ºåœ¨è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­æ€»å…±ä¸ç‰©ç†å†…å­˜æ˜ å°„çš„é¡µçš„æ€»æ•°ã€‚</p><p>å½“å†…å­˜åƒç´§çš„æ—¶å€™ï¼Œæœ‰äº›é¡µå¯ä»¥æ¢å‡ºåˆ°ç¡¬ç›˜ä¸Šï¼Œè€Œæœ‰äº›é¡µå› ä¸ºæ¯”è¾ƒé‡è¦ï¼Œä¸èƒ½æ¢å‡ºã€‚locked_vm å°±æ˜¯è¢«é”å®šä¸èƒ½æ¢å‡ºçš„å†…å­˜é¡µæ€»æ•°ï¼Œpinned_vm  è¡¨ç¤ºæ—¢ä¸èƒ½æ¢å‡ºï¼Œä¹Ÿä¸èƒ½ç§»åŠ¨çš„å†…å­˜é¡µæ€»æ•°ã€‚</p><p>data_vm è¡¨ç¤ºæ•°æ®æ®µä¸­æ˜ å°„çš„å†…å­˜é¡µæ•°ç›®ï¼Œexec_vm æ˜¯ä»£ç æ®µä¸­å­˜æ”¾å¯æ‰§è¡Œæ–‡ä»¶çš„å†…å­˜é¡µæ•°ç›®ï¼Œstack_vm æ˜¯æ ˆä¸­æ‰€æ˜ å°„çš„å†…å­˜é¡µæ•°ç›®ï¼Œè¿™äº›å˜é‡å‡æ˜¯è¡¨ç¤ºè¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­çš„è™šæ‹Ÿå†…å­˜ä½¿ç”¨æƒ…å†µã€‚</p><p>ä¸‹å›¾ä¸ºä¸€ä¸ªæ€»è§ˆå›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202312251733977.png" alt="640 (5)"></p><h3 id="è™šæ‹Ÿå†…å­˜åŒºåŸŸ"><a href="#è™šæ‹Ÿå†…å­˜åŒºåŸŸ" class="headerlink" title="è™šæ‹Ÿå†…å­˜åŒºåŸŸ"></a>è™šæ‹Ÿå†…å­˜åŒºåŸŸ</h3><p>å†…æ ¸ä¸­ä½¿ç”¨ç»“æ„ä½“ <code>vm_area_struct</code>ï¼Œæ¥ç®¡ç†åƒä»£ç æ®µã€æ•°æ®æ®µç­‰ä¸åŒçš„è™šæ‹Ÿå†…å­˜åŒºåŸŸVMA</p><p>åŒæ ·åœ¨<code>include/linux/mm_types.h</code>ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/*å®šä¹‰è™šæ‹Ÿå†…å­˜åŒºåŸŸèµ·å§‹åœ°å€*/</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> vm_start;<span class="comment">/* Our start address within vm_mm. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> vm_end;<span class="comment">/* The first byte after our end address</span></span><br><span class="line"><span class="comment">    /*çœç•¥*/</span></span><br><span class="line">    <span class="comment">/*å®šä¹‰è®¿é—®æƒé™*/</span></span><br><span class="line">    <span class="type">pgprot_t</span> vm_page_prot;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> vm_flags;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">anon_vma</span> *<span class="title">anon_vma</span>;</span> <span class="comment">/* Serialized by page_table_lock */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> * <span class="title">vm_file</span>;</span>  <span class="comment">/* File we map to (can be NULL). */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> vm_pgoff;  <span class="comment">/* Offset (within vm_file) in PAGE_SIZE</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure><p>vm_start æŒ‡å‘äº†è¿™å—è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„èµ·å§‹åœ°å€ï¼ˆæœ€ä½åœ°å€ï¼‰ï¼Œvm_start æœ¬èº«åŒ…å«åœ¨è¿™å—è™šæ‹Ÿå†…å­˜åŒºåŸŸå†…ã€‚vm_end æŒ‡å‘äº†è¿™å—è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„ç»“æŸåœ°å€ï¼ˆæœ€é«˜åœ°å€ï¼‰ï¼Œè€Œ vm_end æœ¬èº«åŒ…å«åœ¨è¿™å—è™šæ‹Ÿå†…å­˜åŒºåŸŸä¹‹å¤–ï¼Œæ‰€ä»¥ vm_area_struct ç»“æ„æè¿°çš„æ˜¯ [vm_startï¼Œvm_end) è¿™æ ·ä¸€æ®µå·¦é—­å³å¼€çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸã€‚</p><p>vm_page_prot å’Œ vm_flags éƒ½æ˜¯ç”¨æ¥æ ‡è®° vm_area_struct ç»“æ„è¡¨ç¤ºçš„è¿™å—è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„è®¿é—®æƒé™å’Œè¡Œä¸ºè§„èŒƒã€‚</p><p>æ¥ä¸‹æ¥çš„ä¸‰ä¸ªå±æ€§ anon_vmaï¼Œvm_fileï¼Œvm_pgoff åˆ†åˆ«å’Œè™šæ‹Ÿå†…å­˜æ˜ å°„ç›¸å…³ï¼Œè™šæ‹Ÿå†…å­˜åŒºåŸŸå¯ä»¥æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸Šï¼Œä¹Ÿå¯ä»¥æ˜ å°„åˆ°æ–‡ä»¶ä¸­ï¼Œæ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸Šæˆ‘ä»¬ç§°ä¹‹ä¸ºåŒ¿åæ˜ å°„ï¼Œæ˜ å°„åˆ°æ–‡ä»¶ä¸­æˆ‘ä»¬ç§°ä¹‹ä¸ºæ–‡ä»¶æ˜ å°„ã€‚</p><p>å½“æˆ‘ä»¬è°ƒç”¨ malloc ç”³è¯·å†…å­˜æ—¶ï¼Œå¦‚æœç”³è¯·çš„æ˜¯å°å—å†…å­˜ï¼ˆä½äº 128Kï¼‰åˆ™ä¼šä½¿ç”¨ do_brk() ç³»ç»Ÿè°ƒç”¨é€šè¿‡è°ƒæ•´å †ä¸­çš„ brk æŒ‡é’ˆå¤§å°æ¥å¢åŠ æˆ–è€…å›æ”¶å †å†…å­˜ã€‚</p><p>å¦‚æœç”³è¯·çš„æ˜¯æ¯”è¾ƒå¤§å—çš„å†…å­˜ï¼ˆè¶…è¿‡ 128Kï¼‰æ—¶ï¼Œåˆ™ä¼šè°ƒç”¨ mmap åœ¨ä¸Šå›¾è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­çš„æ–‡ä»¶æ˜ å°„ä¸åŒ¿åæ˜ å°„åŒºåˆ›å»ºå‡ºä¸€å— VMA å†…å­˜åŒºåŸŸï¼Œå¦‚æœè¿›è¡ŒåŒ¿åæ˜ å°„ï¼Œå…¶åŒ¿åæ˜ å°„åŒºåŸŸå°±ç”¨ struct anon_vma ç»“æ„è¡¨ç¤ºï¼›å¦‚æœè¿›è¡Œæ–‡ä»¶æ˜ å°„ï¼Œvm_file å±æ€§å°±ç”¨æ¥å…³è”è¢«æ˜ å°„çš„æ–‡ä»¶ï¼Œvm_pgoff åˆ™è¡¨ç¤ºæ˜ å°„è¿›è™šæ‹Ÿå†…å­˜ä¸­çš„æ–‡ä»¶å†…å®¹ï¼Œåœ¨æ–‡ä»¶ä¸­çš„åç§»ã€‚</p><h3 id="å°†è™šæ‹Ÿå†…å­˜åŒºåŸŸç»„ç»‡è¿›è™šæ‹Ÿå†…å­˜ä¸­"><a href="#å°†è™šæ‹Ÿå†…å­˜åŒºåŸŸç»„ç»‡è¿›è™šæ‹Ÿå†…å­˜ä¸­" class="headerlink" title="å°†è™šæ‹Ÿå†…å­˜åŒºåŸŸç»„ç»‡è¿›è™šæ‹Ÿå†…å­˜ä¸­"></a>å°†è™šæ‹Ÿå†…å­˜åŒºåŸŸç»„ç»‡è¿›è™šæ‹Ÿå†…å­˜ä¸­</h3><p><strong>åŒä¸€ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´çš„ä¸åŒè™šæ‹Ÿå†…å­˜åŒºåŸŸæ˜¯å¦‚ä½•ç»„ç»‡èµ·æ¥çš„å‘¢ï¼Ÿ</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vm_next</span>, *<span class="title">vm_prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">vm_rb</span>;</span>  <span class="comment">//çº¢é»‘æ ‘èŠ‚ç‚¹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å†…æ ¸ä¸­ä½¿ç”¨ä¸¤ç§æ–¹å¼å¯¹è™šæ‹Ÿå†…å­˜åŒºåŸŸè¿›è¡Œç»„ç»‡</p><p>ä¸€æ˜¯é€šè¿‡ä¸€ä¸ª struct vm_area_struct ç»“æ„çš„<strong>åŒå‘é“¾è¡¨</strong>å°†è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­çš„è¿™äº›è™šæ‹Ÿå†…å­˜åŒºåŸŸ VMA ä¸²è”èµ·æ¥çš„ã€‚</p><p>vm_area_struct ç»“æ„ä¸­çš„ vm_next ï¼Œvm_prev æŒ‡é’ˆåˆ†åˆ«æŒ‡å‘ VMA èŠ‚ç‚¹æ‰€åœ¨åŒå‘é“¾è¡¨ä¸­çš„åç»§èŠ‚ç‚¹å’Œå‰é©±èŠ‚ç‚¹ï¼Œå†…æ ¸ä¸­çš„è¿™ä¸ª VMA åŒå‘é“¾è¡¨æ˜¯æœ‰é¡ºåºçš„ï¼Œæ‰€æœ‰ VMA èŠ‚ç‚¹æŒ‰ç…§ä½åœ°å€åˆ°é«˜åœ°å€çš„å¢é•¿æ–¹å‘æ’åºã€‚åŒå‘é“¾è¡¨ä¸­çš„æœ€åä¸€ä¸ª VMA èŠ‚ç‚¹çš„ vm_next æŒ‡é’ˆæŒ‡å‘ NULLï¼ŒåŒå‘é“¾è¡¨çš„å¤´æŒ‡é’ˆå­˜å‚¨åœ¨å†…å­˜æè¿°ç¬¦ struct mm_struct ç»“æ„ä¸­çš„ <strong>mmap</strong> ä¸­ï¼Œæ­£æ˜¯è¿™ä¸ª mmap ä¸²è”èµ·äº†æ•´ä¸ªè™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸã€‚</p><p>äºŒæ˜¯ä¸ºäº†é«˜æ•ˆæŸ¥è¯¢ï¼Œå°†VMAä½œä¸ºçº¢é»‘æ•°çš„èŠ‚ç‚¹ï¼Œä»¥çº¢é»‘æ ‘æ¥ç»„ç»‡ã€‚</p><p>æ¯ä¸ª VMA åŒºåŸŸéƒ½æ˜¯çº¢é»‘æ ‘ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé€šè¿‡ struct vm_area_struct ç»“æ„ä¸­çš„ vm_rb å°†è‡ªå·±è¿æ¥åˆ°çº¢é»‘æ ‘ä¸­ã€‚è€Œçº¢é»‘æ ‘ä¸­çš„æ ¹èŠ‚ç‚¹å­˜å‚¨åœ¨å†…å­˜æè¿°ç¬¦ struct mm_struct ä¸­çš„ <strong>mm_rb</strong> ä¸­</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202312251734943.png" alt="640 (6)"></p><p>å‚è€ƒæ–‡çŒ®ï¼š<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&mid=2247486732&idx=1&sn=435d5e834e9751036c96384f6965b328&chksm=ce77cb4bf900425d33d2adfa632a4684cf7a63beece166c1ffedc4fdacb807c9413e8c73f298&token=1468822011&lang=zh_CN&scene=21#wechat_redirect">å‚è€ƒæ–‡çŒ®</a></p>]]></content>
      
      
      <categories>
          
          <category> Linuxå†…æ ¸ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>IOå¤šè·¯å¤ç”¨</title>
      <link href="/2023/12/14/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/"/>
      <url>/2023/12/14/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="IOå¤šè·¯å¤ç”¨"><a href="#IOå¤šè·¯å¤ç”¨" class="headerlink" title="IOå¤šè·¯å¤ç”¨"></a>IOå¤šè·¯å¤ç”¨</h1><h2 id="select"><a href="#select" class="headerlink" title="select"></a>select</h2><p><a href="https://www.cnblogs.com/alantu2018/p/8612722.html">å†…å®¹ä»‹ç»</a></p><p>ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">sockfd = socket(AF_INEF,SOCK_STREAM,<span class="number">0</span>);  <span class="comment">//æœåŠ¡å™¨ç«¯ç›‘å¬å¥—æ¥å­—</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(addr)); <span class="comment">//åˆå§‹åŒ–addr_inç±»å‹</span></span><br><span class="line">addr.sin_family = AF_INET; <span class="comment">//IPV4</span></span><br><span class="line">addr.sin_port = hton(<span class="number">2000</span>);<span class="comment">//ç«¯å£2000</span></span><br><span class="line">addr_sin_addr.s_addr = INADDR_ANY; <span class="comment">// </span></span><br><span class="line"></span><br><span class="line">bind(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;addr, <span class="keyword">sizeof</span>(addr)); <span class="comment">//ç»‘å®šé™¶å¥—æ¥å­—å’Œå¥—æ¥å£åœ°å€</span></span><br><span class="line">listen(socfd, <span class="number">5</span>);<span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;client,<span class="number">0</span>,<span class="keyword">sizeof</span>(client)); <span class="comment">//åˆå§‹åŒ–å®¢æˆ·ç«¯å¥—æ¥å­—</span></span><br><span class="line">    addrlen = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    fds[i] = accept(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;client, &amp;addrlen);</span><br><span class="line">    <span class="keyword">if</span>(fds[i] &gt; max)</span><br><span class="line">        max = fds[i];<span class="comment">//è®°å½•æœ€å¤§çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    fd_set rset;</span><br><span class="line">    FD_ZERO(&amp;rest); <span class="comment">//å…¨éƒ¨ç½®ä¸º0</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">        FD_SET(fds[i],&amp;rset); <span class="comment">//å°†æˆ‘ä»¬å…³å¿ƒçš„æ–‡ä»¶æè¿°ç¬¦è®¾ä¸º1</span></span><br><span class="line">    </span><br><span class="line">    select(max+<span class="number">1</span>, &amp;rest, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// selectå‡½æ•°ä¼šå°†æ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦ä¸­ï¼Œæœ‰æ•°æ®åˆ°æ¥çš„é‚£äº›æè¿°ç¬¦çš„å¯¹åº”ä½ç½®ç½®ä½1ï¼Œå…¶ä½™ä½ç½®ç½®ä½0ï¼Œ</span></span><br><span class="line">    <span class="comment">//é€šè¿‡forå¾ªç¯åˆ¤æ–­å“ªäº›æ–‡ä»¶æè¿°ç¬¦è¢«ç½®ä½ï¼Œä»è€Œè¯»å–å…¶ä¸­çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(FD_ISSET(fds[i], &amp;rset))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">memset</span>(buffer,<span class="number">0</span>,MAXBUF);</span><br><span class="line">            read(fds[i],buffer,MAXBUF); <span class="comment">//è¯»æ“ä½œ</span></span><br><span class="line">            <span class="built_in">puts</span>(buffer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å†…æ ¸æ€æ¥åˆ¤æ–­é‚£ä¸ªå¥—æ¥å­—æè¿°ç¬¦æœ‰æ•°æ®</p><p>ç¼ºç‚¹ï¼šæœ‰1024ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„é™åˆ¶ï¼›fd_setä¸å¯ä»¥é‡ç”¨ï¼Œæ¯æ¬¡å¾ªç¯éœ€è¦é‡æ–°ç½®ä½0ï¼›å†…æ ¸æ€å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦å¯¼è‡´æ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨è¶Šé•¿éœ€è¦å¤åˆ¶çš„æ¬¡æ•°è¶Šå¤šï¼›O(n)éå†åˆ¤æ–­å“ªä¸ªä½ç½®çš„æè¿°ç¬¦è¢«ç½®ä½</p><h2 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h2><p>pollå‡½æ•°æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">poll</span> <span class="params">(<span class="keyword">struct</span> pollfd * fds, <span class="type">unsigned</span> <span class="type">int</span> nfds, <span class="type">int</span> timeout)</span>;</span><br></pre></td></tr></table></figure><p>å‚æ•°ï¼šæŒ‡å‘pollfdç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆï¼Œæ•°ç»„æŒ‡é’ˆ</p><p>â€‹            å…³æ³¨çš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°</p><p>â€‹             æ—¶é—´</p><p>poolfdç»“æ„ä½“å®šä¹‰å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> fd;         <span class="comment">/* æ–‡ä»¶æè¿°ç¬¦ */</span></span><br><span class="line">    <span class="type">short</span> events;         <span class="comment">/* ç­‰å¾…çš„äº‹ä»¶ */</span></span><br><span class="line">    <span class="type">short</span> revents;       <span class="comment">/* å®é™…å‘ç”Ÿäº†çš„äº‹ä»¶ */</span></span><br><span class="line">&#125; ; </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;client,<span class="number">0</span>, <span class="keyword">sizeof</span>(client));</span><br><span class="line">    addrlen = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    pollfds[i].fd = accept(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;client, &amp;addrlen);<span class="comment">//pollfdsæ˜¯pollfdç±»å‹çš„ç»“æ„ä½“æ•°ç»„</span></span><br><span class="line">    pollfds[i].events = POLLIN;<span class="comment">//å…³æ³¨çš„æ˜¯æœ‰æ•°æ®å¯è¯»äº‹ä»¶</span></span><br><span class="line">&#125;</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    poll(pollfds, <span class="number">5</span>, <span class="number">50000</span>); <span class="comment">//è°ƒç”¨pollå‡½æ•°ï¼Œpollfds[i]å‘ç”Ÿäº†POLLINäº‹ä»¶ï¼Œ                                                  //æŠŠpollfds[i].reventså¯¹åº”äºPOLLINç½®ä½ä¸º1</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(pollfds[i].revents &amp; POLLIN)  <span class="comment">//å¯èƒ½æœ‰å¤šä¸ªå…³æ³¨äº‹ä»¶ï¼Œè¦ä¸å¯¹åº”çš„äº‹ä»¶åšä¸æ“ä½œ</span></span><br><span class="line">        &#123;</span><br><span class="line">            pollfds[i].revents = <span class="number">0</span>;<span class="comment">//å¤ä½</span></span><br><span class="line">            <span class="comment">//å¤„ç†æ•°æ®</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h2><p><a href="https://zhuanlan.zhihu.com/p/406175793">epollå‡½æ•°åŸç†è¯¦è§£</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">struct epoll_event events[5];</span><br><span class="line">int c = epoll_create1(10);</span><br><span class="line">int epfd = epoll_create(10);//åˆ›å»ºä¸€ä¸ªepollå¯¹è±¡ï¼Œè¿”å›æ–‡ä»¶æè¿°ç¬¦,å‚æ•°åªè¦å¤§äº0å³å¯</span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line">for(int i=0;i&lt;5;i++)</span><br><span class="line">&#123;</span><br><span class="line">    static struct epoll_event ev;  //ä¸´æ—¶å˜é‡</span><br><span class="line">    memset(&amp;client, 0, sizeof(client));</span><br><span class="line">    addrlen = sizeof(client);</span><br><span class="line">    ev.data.fd = accept(sockfd, (struct sockaddr*)&amp;client, &amp;addrlen); //ç›‘å¬çš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦</span><br><span class="line">    ev.events = EPOLLIN; //ç›‘å¬äº‹ä»¶æ˜¯è¯»äº‹ä»¶</span><br><span class="line">    epoll_ctl(epfd, EPOLL_CTL_ADD, ev.data.fd, &amp;ev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">while(1)</span><br><span class="line">&#123;</span><br><span class="line">    nfds = epoll_wait(epfd, events, 5, 10000);</span><br><span class="line">    for(i=0;i&lt;ndfs;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        //å¤„ç†æ•°æ®</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ç½‘ç»œç¼–ç¨‹ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ç½‘ç»œç¼–ç¨‹-Linuxç³»ç»Ÿç¼–ç¨‹3</title>
      <link href="/2023/12/06/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B3/"/>
      <url>/2023/12/06/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B3/</url>
      
        <content type="html"><![CDATA[<h1 id="Linuxç³»ç»Ÿç¼–ç¨‹3"><a href="#Linuxç³»ç»Ÿç¼–ç¨‹3" class="headerlink" title="Linuxç³»ç»Ÿç¼–ç¨‹3"></a>Linuxç³»ç»Ÿç¼–ç¨‹3</h1><h2 id="dentryå’Œinode"><a href="#dentryå’Œinode" class="headerlink" title="dentryå’Œinode"></a>dentryå’Œinode</h2><p>å‚è€ƒï¼š<a href="https://bean-li.github.io/vfs-inode-dentry/">https://bean-li.github.io/vfs-inode-dentry/</a></p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202312031438241.png" alt="image-20231203143825104"></p><p><strong>innodeï¼š</strong></p><p>æœ¬è´¨æ˜¯ç»“æ„ä½“ï¼Œ<strong>å­˜å‚¨æ–‡ä»¶çš„å±æ€§ä¿¡æ¯</strong>ã€‚å¦‚æƒé™ã€ç±»å‹ã€å¤§å°ã€æ—¶é—´ã€ç”¨æˆ·ã€ç›˜å—ä½ç½®ç­‰ã€‚å¤§å¤šæ•°çš„inodeéƒ½å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œå°‘é‡å¸¸ç”¨</p><p><strong>dentryï¼š</strong></p><p>ç›®å½•é¡¹ï¼Œæœ¬è´¨æ˜¯ç»“æ„ä½“ï¼Œå­˜æœ‰<strong>æ–‡ä»¶å</strong>å’Œ<strong>inodeæŒ‡é’ˆ</strong>ã€‚å› æ­¤ä¸€ä¸ªæ–‡ä»¶å¯ä»¥æœ‰å¤šä¸ªdentryé¡¹</p><h2 id="statå‡½æ•°"><a href="#statå‡½æ•°" class="headerlink" title="statå‡½æ•°"></a>statå‡½æ•°</h2><p>statå‡½æ•°ï¼Œç”¨äºè·å–æ–‡ä»¶å±æ€§ï¼Œå³<strong>è·å–çš„å°±æ˜¯inodeçš„å†…å®¹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">int stat(const char *pathname, struct stat *statbuf);</span><br></pre></td></tr></table></figure><p><strong>å‚æ•°</strong></p><p>pathï¼šæ–‡ä»¶è·¯å¾„</p><p>bufï¼šä¼ å‡ºå‚æ•°ï¼Œå­˜æ”¾<strong>æ–‡ä»¶å±æ€§</strong></p><p><strong>è¿”å›å€¼</strong></p><p>æˆåŠŸï¼š0ï¼Œå¤±è´¥ï¼š-1</p><p><strong>statç»“æ„ä½“å¦‚ä¸‹</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> &#123;</span></span><br><span class="line">   <span class="type">dev_t</span>     st_dev;         <span class="comment">/* è®¾å¤‡å·ç  */</span></span><br><span class="line">   <span class="type">ino_t</span>     st_ino;         <span class="comment">/* Inode number */</span></span><br><span class="line">   <span class="type">mode_t</span>    st_mode;        <span class="comment">/* æ–‡ä»¶æ¨¡å¼ï¼Œæ–‡ä»¶ã€ç›®å½• */</span></span><br><span class="line">   <span class="type">nlink_t</span>   st_nlink;       <span class="comment">/* Number of hard links */</span></span><br><span class="line">   <span class="type">uid_t</span>     st_uid;         <span class="comment">/* User ID of owner */</span></span><br><span class="line">   <span class="type">gid_t</span>     st_gid;         <span class="comment">/* Group ID of owner */</span></span><br><span class="line">   <span class="type">dev_t</span>     st_rdev;        <span class="comment">/* Device ID (if special file) */</span></span><br><span class="line">   <span class="type">off_t</span>     st_size;        <span class="comment">/* Total size, in bytes */</span></span><br><span class="line">   <span class="type">blksize_t</span> st_blksize;     <span class="comment">/* Block size for filesystem I/O */</span></span><br><span class="line">   <span class="type">blkcnt_t</span>  st_blocks;      <span class="comment">/* Number of 512B blocks allocated */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>åˆ¤æ–­æ–‡ä»¶ç±»å‹</strong>ï¼Œä½¿ç”¨å¯¹åº”å‡½æ•°ï¼Œä¼ å…¥statç»“æ„ä½“ä¸­çš„st_mode</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">sb</span>;</span></span><br><span class="line">    <span class="type">int</span> ret = stat(argy[<span class="number">1</span>], &amp;sb);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">perror(<span class="string">&quot;stat eror&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (S_ISREG(sb.st_mode)) <span class="comment">//å¸¸è§„æ–‡ä»¶</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;It&#x27;s a regular(n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s ISDIR(sb.st mode) <span class="comment">//ç›®å½•</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;It&#x27;s a dirln&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (S_ISFIFO(sb.st_mode)) <span class="comment">//ç®¡é“</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;It&#x27;s a pipe n&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (S_ISLNK(sb.st_mode)) </span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;it&#x27;s a sym link n&quot;</span>); <span class="comment">//é“¾æ¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="linkå’Œunlinkå‡½æ•°"><a href="#linkå’Œunlinkå‡½æ•°" class="headerlink" title="linkå’Œunlinkå‡½æ•°"></a>linkå’Œunlinkå‡½æ•°</h2><p>Linuxå…è®¸å¤šä¸ªç›®å½•é¡¹å…±äº«ä¸€ä¸ªinodeï¼Œå³å…±äº«ç›˜å—ï¼Œä»è€Œä½¿åŒä¸€ä¸ªæ–‡ä»¶æœ‰å¤šä¸ªæ–‡ä»¶åã€‚ä½¿ç”¨linkå‡½æ•°ï¼Œå¯ä»¥ä¸ºå·²ç»å­˜åœ¨çš„ç›®å½•åˆ›å»ºç›®å½•é¡¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int link(const char *oldname, const char *newname);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨unlinkå¯ä»¥åˆ é™¤ä¸€ä¸ªæ–‡ä»¶çš„ç›®å½•é¡¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int unlink(const char* pathname);</span><br></pre></td></tr></table></figure><p>åŠŸèƒ½è¯¦è§£ï¼šunlinkä»æ–‡ä»¶ç³»ç»Ÿä¸­ä¸­åˆ é™¤ä¸€ä¸ªdentryï¼Œè‹¥è¿™ä¸ªdentryæ˜¯æŒ‡å‘è¿™ä¸ªæ–‡ä»¶çš„æœ€åä¸€ä¸ªé“¾æ¥ï¼Œå¹¶ä¸”æ²¡æœ‰è¿›ç¨‹å¤„äºæ‰“å¼€è¿™ä¸ªæ–‡ä»¶çš„çŠ¶æ€ï¼Œåˆ™åˆ é™¤è¿™ä¸ªæ–‡ä»¶ï¼Œé‡Šæ”¾è¿™ä¸ªæ–‡ä»¶å ç”¨çš„ç©ºé—´ã€‚è‹¥è¿™ä¸ªdentryæ˜¯æŒ‡å‘è¿™ä¸ªæ–‡ä»¶çš„æœ€åä¸€ä¸ªé“¾æ¥ï¼Œä½†æ˜¯æœ‰è¿›ç¨‹å¤„äºæ‰“å¼€è¿™ä¸ªæ–‡ä»¶çš„çŠ¶æ€ï¼Œåˆ™æš‚æ—¶ä¸åˆ é™¤æ–‡ä»¶ï¼Œç­‰åˆ°æ‰“å¼€è¿™ä¸ªæ–‡ä»¶çš„è¿›ç¨‹å…³é—­è¿™ä¸ªæ–‡ä»¶åï¼Œç³»ç»Ÿæ‰æ‹©æœºåˆ é™¤è¿™ä¸ªæ–‡ä»¶ã€‚</p><h2 id="opendirã€readdirå‡½æ•°"><a href="#opendirã€readdirå‡½æ•°" class="headerlink" title="opendirã€readdirå‡½æ•°"></a>opendirã€readdirå‡½æ•°</h2><p>opendiræ‰“å¼€ä¸€ä¸ªç›®å½•æ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line">DIR *<span class="title function_">opendir</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*name)</span>;</span><br></pre></td></tr></table></figure><p>DIRè¡¨ç¤ºç›®å½•æµç±»å‹ã€‚</p><p>opendir()ç”¨æ¥æ‰“å¼€å‚æ•°name æŒ‡å®šçš„ç›®å½•, å¹¶<strong>è¿”å›ç›®å½•æµæŒ‡é’ˆ</strong>,ï¼ˆç›¸å½“äºæ–‡ä»¶æè¿°ç¬¦fdï¼‰</p><p>å¯¹åº”çš„å…³é—­æ—¶<code>closedir(DIR *name)</code></p><p>readdirå‡½æ•°è¿”å›å‚æ•°dir ç›®å½•æµçš„ä¸‹ä¸ªç›®å½•è¿›å…¥ç‚¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">struct dirent *readdir(DIR *dirp);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struct dirent</span><br><span class="line">&#123;</span><br><span class="line">    ino_t d_ino; //d_ino æ­¤ç›®å½•é¡¹çš„inode</span><br><span class="line">    ff_t d_off; //d_off  ç›®å½•æ–‡ä»¶å¼€å¤´è‡³æ­¤ç›®å½•è¿›å…¥ç‚¹çš„ä½ç§»</span><br><span class="line">    signed short int d_reclen; //d_reclen _name çš„é•¿åº¦, ä¸åŒ…å«NULL å­—ç¬¦</span><br><span class="line">    unsigned char d_type; //d_type d_name æ‰€æŒ‡çš„æ–‡ä»¶ç±»å‹ d_name æ–‡ä»¶å</span><br><span class="line">    har d_name[256];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>è¿”å›å€¼</strong>ï¼šæˆåŠŸåˆ™è¿”å›<strong>ä¸‹ä¸ªç›®å½•é¡¹æŒ‡é’ˆ</strong>ã€‚è¯»å–åˆ°ç›®å½•æ–‡ä»¶å°¾åˆ™è¿”å›NULL,errorä¸å˜ï¼Œè¯»å–é”™è¯¯çš„è¯è¿”å›NULLï¼Œå¹¶ä¸”errorè¢«è®¾ç½®</p><p><strong>æ¯æ¬¡è¯»ä¸€ä¸ªé¡¹ï¼Œå°±ä¼šæœ‰ç›®å½•æµè¯»å–ä½ç½®å°±ä¼šå¾€ååç§»ä¸€é¡¹ï¼Œä½¿ä¸‹æ¬¡ä½¿ç”¨readdirå¯ä»¥è¯»ä¸‹ä¸€ä¸ªç›®å½•é¡¹æŒ‡é’ˆ</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    DIR * dp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">sdp</span>;</span></span><br><span class="line">    dp = opendir(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span>(dp==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;opendir error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>((sdp = readdir(dp))!=<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(sdp-&gt;d_name,<span class="string">&quot;.&quot;</span>)==<span class="number">0</span>||<span class="built_in">strcmp</span>(sdp-&gt;d_name,<span class="string">&quot;..&quot;</span>)==<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\t&quot;</span>,sdp-&gt;d_name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    closedir(dp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>rewinddirå‡½æ•°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void rewinddir(DIR *dir)</span><br></pre></td></tr></table></figure><p>rewinddir()ç”¨æ¥è®¾ç½®å‚æ•°dir ç›®å½•æµç›®å‰çš„è¯»å–ä½ç½®ä¸ºåŸæ¥å¼€å¤´çš„è¯»å–ä½ç½®.</p><p><strong>telldirå‡½æ•°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">off_t telldir(DIR *dir);</span><br></pre></td></tr></table></figure><p>telldir()è¿”å›å‚æ•°dir ç›®å½•æµç›®å‰çš„è¯»å–ä½ç½®ã€‚æ­¤è¿”å›å€¼ä»£è¡¨è·ç¦»ç›®å½•æ–‡ä»¶å¼€å¤´çš„åç§»é‡ï¼Œè¿”å›å€¼è¿”å›ä¸‹ä¸ªè¯»å–ä½ç½®ã€‚</p><p><strong>seekdirå‡½æ•°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void seekdir(DIR * dir, off_t offset);</span><br></pre></td></tr></table></figure><p>seekdir()ç”¨æ¥è®¾ç½®å‚æ•°dir ç›®å½•æµç›®å‰çš„è¯»å–ä½ç½®, åœ¨è°ƒç”¨readdir()æ—¶ä¾¿ä»æ­¤æ–°ä½ç½®å¼€å§‹è¯»å–. å‚æ•°offset ä»£è¡¨è·ç¦»ç›®å½•æ–‡ä»¶å¼€å¤´çš„åç§»é‡ã€‚</p><h2 id="æ€»ç»“ï¼šå®ç°lsåŠŸèƒ½"><a href="#æ€»ç»“ï¼šå®ç°lsåŠŸèƒ½" class="headerlink" title="æ€»ç»“ï¼šå®ç°lsåŠŸèƒ½"></a>æ€»ç»“ï¼šå®ç°lsåŠŸèƒ½</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Read_file</span><span class="params">(<span class="type">char</span> *, <span class="type">const</span> <span class="type">int</span> )</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">is_file</span><span class="params">(<span class="type">char</span> *,<span class="type">const</span> <span class="type">int</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Read_file</span><span class="params">(<span class="type">char</span> *name, <span class="type">const</span> <span class="type">int</span> depth)</span> <span class="comment">//ç›®å½•</span></span><br><span class="line">&#123;</span><br><span class="line">    DIR *dp;<span class="comment">//ç›®å½•æµæŒ‡é’ˆ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">sdp</span>;</span> <span class="comment">//ç›®å½•é¡¹æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">if</span>((dp = opendir(name)) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;opendir error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>((sdp = readdir(dp)) != <span class="literal">NULL</span>) <span class="comment">//å¯¹äºç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå…¶æ‰“å¼€è·¯å¾„éƒ½æ˜¯ï¼šç›®å½•è·¯å¾„+æ–‡ä»¶å</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(sdp-&gt;d_name,<span class="string">&quot;.&quot;</span>)==<span class="number">0</span>||<span class="built_in">strcmp</span>(sdp-&gt;d_name,<span class="string">&quot;..&quot;</span>)==<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="type">char</span> file_true_path[<span class="number">1000</span>];</span><br><span class="line">        <span class="type">char</span> lastChar =  name[<span class="built_in">strlen</span>(name)<span class="number">-1</span>];</span><br><span class="line">        <span class="keyword">if</span>(lastChar==<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">            <span class="built_in">sprintf</span>(file_true_path,<span class="string">&quot;%s%s&quot;</span>,name,sdp-&gt;d_name);<span class="comment">//æ‹¼æ¥</span></span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            <span class="built_in">sprintf</span>(file_true_path,<span class="string">&quot;%s/%s&quot;</span>,name,sdp-&gt;d_name);<span class="comment">//æ‹¼æ¥</span></span><br><span class="line">        is_file(file_true_path,depth);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">is_file</span><span class="params">(<span class="type">char</span> *path, <span class="type">const</span> <span class="type">int</span> depth)</span> <span class="comment">//depthä¸ºæ–‡ä»¶å±‚æ¬¡</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">sb</span>;</span></span><br><span class="line">    <span class="keyword">if</span>(stat(path, &amp;sb)==<span class="number">-1</span>) <span class="comment">//è¯»æ–‡ä»¶å±æ€§ï¼Œåˆ¤æ–­æ˜¯å¦å‡ºé”™</span></span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;stat error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(S_ISDIR(sb.st_mode))<span class="comment">//ç›®å½•æ–‡ä»¶,æ‰“å°ç›®å½•</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">3</span>*depth;i++)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>); <span class="comment">//æŒ‰æ·±åº¦æ‰“å°ç©ºæ ¼</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,path);</span><br><span class="line">        Read_file(path,depth+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">3</span>*depth;i++)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>); <span class="comment">//æŒ‰æ·±åº¦æ‰“å°ç©ºæ ¼</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s %8ld\n&quot;</span>,path, sb.st_size);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> *argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc == <span class="number">1</span>)</span><br><span class="line">        is_file(<span class="string">&quot;.&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    is_file(argv[<span class="number">1</span>],<span class="number">1</span>); <span class="comment">//ç›®å½•æ ¹è·¯å¾„</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é‡å®šå‘ï¼ˆdupå’Œdup2ï¼‰"><a href="#é‡å®šå‘ï¼ˆdupå’Œdup2ï¼‰" class="headerlink" title="é‡å®šå‘ï¼ˆdupå’Œdup2ï¼‰"></a>é‡å®šå‘ï¼ˆdupå’Œdup2ï¼‰</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">dup</span><span class="params">(<span class="type">int</span> oldfd)</span>;  <span class="comment">//oldfdæ˜¯å·²æœ‰çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br></pre></td></tr></table></figure><p>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›æ–°çš„æ–‡ä»¶æè¿°ç¬¦</p><p>dupå‡½æ•°ä¸ºoldfdæŒ‡å‘çš„æ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦å‰¯æœ¬ï¼Œå®ƒä»¬æŒ‡å‘ç›¸åŒçš„æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦ï¼ˆå‚è§ open(2)ï¼‰ï¼Œå› æ­¤å…±äº«æ–‡ä»¶åç§»é‡å’Œæ–‡ä»¶çŠ¶æ€æ ‡å¿—</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;sys/stat.h&gt;</span><br><span class="line">#include &lt;pthread.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    int fd;</span><br><span class="line">    if((fd = open(argv[1],O_RDWR|O_APPEND))==-1)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(&quot;open error&quot;);</span><br><span class="line">        exit(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int newfd = dup(fd);  //ä¸ºä¸€ä¸ªç›¸åŒæ–‡ä»¶è¿”å›æ–°çš„æ–‡ä»¶æè¿°ç¬¦</span><br><span class="line">    printf(&quot;newfd = %d\n&quot;,newfd);</span><br><span class="line">    </span><br><span class="line">    if (write(newfd, &quot;1234567&quot;, 7) == -1) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(&quot;write error&quot;);</span><br><span class="line">        exit(1);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">int dup(int oldfd, int newfd);  //oldfdæ˜¯å·²æœ‰çš„æ–‡ä»¶æè¿°ç¬¦,newfdæ˜¯æ–°çš„æ–‡ä»¶æè¿°ç¬¦</span><br></pre></td></tr></table></figure><p><code>dup2()</code> ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œä¸ <code>dup()</code> ç±»ä¼¼çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä¸ä½¿ç”¨æœªä½¿ç”¨çš„æœ€ä½æ–‡ä»¶æè¿°ç¬¦å·ï¼Œè€Œæ˜¯ä½¿ç”¨åœ¨ <code>newfd</code> ä¸­æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦å·ã€‚å¦‚æœæ–‡ä»¶æè¿°ç¬¦ <code>newfd</code> ä¹‹å‰å·²ç»æ‰“å¼€ï¼Œåˆ™åœ¨è¢«é‡ç”¨ä¹‹å‰ä¼šè¢«é™é»˜å…³é—­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="keyword">if</span>((fd = open(argv[<span class="number">1</span>],O_RDWR|O_APPEND))==<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> newfd = dup2(fd,STDOUT_FILENO); <span class="comment">//æ ‡å‡†è¾“å‡ºçš„æ–‡ä»¶æè¿°ç¬¦æ‰€æŒ‡å‘å¾—çš„æ–‡ä»¶ï¼Œé‡å®šå‘åˆ°fdæ‰€æŒ‡çš„æ–‡ä»¶</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;------------------\n&quot;</span>); <span class="comment">//å‘æ ‡å‡†è¾“å‡ºå†™çš„æ•°æ®ä¼šå†™å…¥txtæ–‡ä»¶ä¸­</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ç½‘ç»œç¼–ç¨‹ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ç½‘ç»œç¼–ç¨‹-Linuxç³»ç»Ÿç¼–ç¨‹2</title>
      <link href="/2023/12/03/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B2/"/>
      <url>/2023/12/03/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B2/</url>
      
        <content type="html"><![CDATA[<h1 id="Linuxç³»ç»Ÿç¼–ç¨‹2"><a href="#Linuxç³»ç»Ÿç¼–ç¨‹2" class="headerlink" title="Linuxç³»ç»Ÿç¼–ç¨‹2"></a>Linuxç³»ç»Ÿç¼–ç¨‹2</h1><h2 id="umask"><a href="#umask" class="headerlink" title="umask"></a>umask</h2><p>umaskå¯ç”¨æ¥è®¾å®š[æƒé™æ©ç ]ã€‚[æƒé™æ©ç ]æ˜¯ç”±3ä¸ªå…«è¿›åˆ¶çš„æ•°å­—æ‰€ç»„æˆï¼Œå°†<strong>ç°æœ‰çš„å­˜å–æƒé™å‡æ‰æƒé™æ©ç å</strong>ï¼Œå³å¯äº§ç”Ÿå»ºç«‹æ–‡ä»¶æ—¶é¢„è®¾çš„æƒé™ã€‚</p><p>linuxåˆ›å»ºæ–‡ä»¶æ–‡ä»¶é»˜è®¤æƒé™ä¸º644ï¼Œç›®å½•é»˜è®¤æƒé™ä¸º755ï¼Œé»˜è®¤æƒé™æ©ç ä¸º022ã€‚</p><h2 id="openå‡½æ•°"><a href="#openå‡½æ•°" class="headerlink" title="openå‡½æ•°"></a>openå‡½æ•°</h2><p><strong>å®šä¹‰</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int open(const char *pathname, int flags);</span><br><span class="line">int open(const char *pathname, int flags, mode_t mode);</span><br></pre></td></tr></table></figure><p>å¤´æ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br></pre></td></tr></table></figure><p><strong>å‚æ•°</strong></p><p><strong>1ã€pathnameï¼š</strong></p><p>ç›¸å¯¹è¯¥æ–‡ä»¶çš„ç»å¯¹è·¯å¾„</p><p><strong>2ã€flags</strong>ï¼š</p><p>flagså‚æ•°è¡¨ç¤ºæ‰“å¼€æ–‡ä»¶æ‰€é‡‡ç”¨çš„æ“ä½œ</p><ul><li>O_RDONLYï¼šåªè¯»æ¨¡å¼</li><li>O_WRONLYï¼šåªå†™æ¨¡å¼</li><li>O_RDWRï¼šå¯è¯»å¯å†™</li></ul><p>ä»¥ä¸Šä¸‰ä¸ªå‚æ•°æ˜¯<strong>å¿…é¡»çš„</strong>ï¼Œä¸‹è¾¹çš„é€‰é¡¹æ˜¯é€‰ç”¨çš„ï¼Œä½¿ç”¨æ—¶éœ€è¦ä¸å¿…é€‰å‚æ•°<code>|</code>èµ·æ¥ï¼Œå¦‚<code>O_RDONLY|O_CREAT</code></p><ul><li><p>O_APPEND è¡¨ç¤ºè¿½åŠ ï¼Œå¦‚æœåŸæ¥æ–‡ä»¶é‡Œé¢æœ‰å†…å®¹ï¼Œåˆ™è¿™æ¬¡å†™å…¥ä¼šå†™åœ¨æ–‡ä»¶çš„æœ€æœ«å°¾ã€‚</p></li><li><p>O_CREAT å¦‚æœæŒ‡å®šæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºè¿™ä¸ªæ–‡ä»¶  <code>fd = open(&quot;./2.txt&quot;,O_RDONLY|O_CREAT,0644);</code></p></li><li><p>O_EXCL è¡¨ç¤ºå¦‚æœè¦åˆ›å»ºçš„æ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ™å‡ºé”™ï¼ŒåŒæ—¶è¿”å› -1ï¼Œå¹¶ä¸”ä¿®æ”¹ errno çš„å€¼ã€‚</p></li><li><p>O_TRUNC è¡¨ç¤ºæˆªæ–­ï¼Œå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œå¹¶ä¸”ä»¥<strong>åªå†™ã€è¯»å†™</strong>æ–¹å¼æ‰“å¼€ï¼Œåˆ™å°†å…¶é•¿åº¦æˆªæ–­ä¸º0ã€‚</p></li><li><p>O_NOCTTY å¦‚æœè·¯å¾„åæŒ‡å‘ç»ˆç«¯è®¾å¤‡ï¼Œä¸è¦æŠŠè¿™ä¸ªè®¾å¤‡ç”¨ä½œæ§åˆ¶ç»ˆç«¯ã€‚</p></li><li><p>O_NONBLOCK å¦‚æœè·¯å¾„åæŒ‡å‘ FIFO&#x2F;å—æ–‡ä»¶&#x2F;å­—ç¬¦æ–‡ä»¶ï¼Œåˆ™æŠŠæ–‡ä»¶çš„æ‰“å¼€å’Œåç»§ I&#x2F;Oè®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼ˆnonblocking modeï¼‰</p></li></ul><p><strong>3ã€mode:</strong></p><p>modeå‚æ•°è¡¨ç¤ºè®¾ç½®æ–‡ä»¶è®¿é—®æƒé™çš„åˆå§‹å€¼ï¼Œå’Œç”¨æˆ·æ©ç umaskæœ‰å…³,ç”¨äºåˆ›å»ºæ–‡ä»¶æ—¶ä½¿ç”¨ï¼Œå³ç¬¬äºŒä¸ªå‚æ•°flagsä¸º<code>O_CREAT</code>æ—¶æ‰æœ‰ç”¨</p><p><strong>è¿”å›å€¼</strong></p><p>æ­£å¸¸åˆ™è¿”å›ä¸€ä¸ªæ•´æ•°ï¼Œå³æ–‡ä»¶æè¿°ç¬¦ï¼ˆintå‹ï¼‰ï¼Œå‡ºç°é”™è¯¯è¿”å›-1ï¼Œå¹¶ä¸”<code>errno</code>è¢«è®¾ç½®æˆå¯¹åº”çš„å€¼</p><p><strong>å¸¸è§é”™è¯¯ï¼š</strong></p><ul><li>æ‰“å¼€æ–‡ä»¶ä¸å­˜åœ¨</li><li>ä»¥å†™æ–¹å¼æ‰“å¼€åªè¯»æ–‡ä»¶</li><li>ä»¥åªå†™æˆ–è¯»å†™æ–¹å¼æ‰“å¼€ç›®å½•ï¼Œåªèƒ½ç”¨åªè¯»æ–¹å¼æ‰“å¼€ç›®å½•</li></ul><h2 id="readå’Œwriteå‡½æ•°"><a href="#readå’Œwriteå‡½æ•°" class="headerlink" title="readå’Œwriteå‡½æ•°"></a>readå’Œwriteå‡½æ•°</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span>;</span><br><span class="line"><span class="comment">// å‚æ•°ï¼šæ–‡ä»¶æè¿°ç¬¦ï¼Œç¼“å†²åŒºæŒ‡é’ˆï¼Œç¼“å†²åŒºå¤§å°</span></span><br></pre></td></tr></table></figure><p>æˆåŠŸï¼šè¿”å›è¯»åˆ°çš„å­—èŠ‚æ•°</p><p>é”™è¯¯ï¼Œè¿”å›-1ï¼Œè®¾ç½®<code>errno</code>ä¸ºå¯¹åº”å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// write() å°†ä» buf å¼€å§‹çš„ç¼“å†²åŒºä¸­å†™å…¥ count ä¸ªå­—èŠ‚åˆ°æ–‡ä»¶æè¿°ç¬¦ fd å¼•ç”¨çš„æ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span>;</span><br><span class="line"><span class="comment">// countä¸ºè¦å†™å…¥çš„å­—èŠ‚æ•°</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨readå’Œwriteå®ç°cpæ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line"><span class="type">int</span> n;  <span class="comment">//æ¯æ¬¡è¯»åˆ°çš„å­—èŠ‚æ•°</span></span><br><span class="line"><span class="type">int</span> fd_rd = open(<span class="string">&quot;./1.txt&quot;</span>,O_RDONLY);</span><br><span class="line"><span class="type">int</span> fd_wr = open(<span class="string">&quot;./2.txt&quot;</span>,O_WRONLY|O_CREAT|O_TRUNC,<span class="number">0644</span>);</span><br><span class="line"><span class="keyword">if</span>(fd_rd == <span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">perror(<span class="string">&quot;open read_txt error&quot;</span>);<span class="comment">//è¾“å‡ºé”™è¯¯æç¤ºï¼Œå¹¶è¾“å‡ºstrerror(errno)çš„ç³»ç»Ÿé”™è¯¯ä¿¡æ¯</span></span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(fd_wr == <span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">perror(<span class="string">&quot;open write_txt error&quot;</span>); </span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å…ˆæŠŠæ•°æ®è¯»å…¥ç¼“å†²åŒº</span></span><br><span class="line"><span class="keyword">while</span>( (n = read(fd_rd,&amp;buf,<span class="keyword">sizeof</span>(buf))) != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span>(n&lt;<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">&quot;read error&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">write(fd_wr, buf, n); <span class="comment">//è¿™é‡Œæ˜¯n</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">close(fd_rd);</span><br><span class="line">close(fd_wr);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–‡ä»¶æè¿°ç¬¦"><a href="#æ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="æ–‡ä»¶æè¿°ç¬¦"></a>æ–‡ä»¶æè¿°ç¬¦</h2><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202312012042842.png" alt="image-20231201204236724"></p><p>PCBè¿›ç¨‹æ§åˆ¶å—ï¼Œæœ¬è´¨æ˜¯ç»“æ„ä½“ã€‚å…¶ä¸­æœ‰ä¸ªæŒ‡é’ˆå˜é‡ï¼ŒæŒ‡å‘æ–‡ä»¶æè¿°ç¬¦è¡¨ã€‚</p><p>æ–‡ä»¶æè¿°ç¬¦è¡¨æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­çš„ä¸‹æ ‡0ã€1ã€2ã€â€¦.1023å°±æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œæ•°ç»„ä¸­å­˜çš„æ˜¯æ¯ä¸ªæ–‡ä»¶çš„æ¯ä¸ªæ–‡ä»¶ç»“æ„ä½“fileçš„æŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">æ–‡ä»¶çš„åç§»é‡</span><br><span class="line">æ–‡ä»¶çš„è®¿é—®æƒé™</span><br><span class="line">æ–‡ä»¶çš„æ‰“å¼€æ ‡å¿—</span><br><span class="line">    æ–‡ä»¶åœ¨å†…æ ¸ç¼“å†²åŒºçš„é¦–åœ°å€</span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­</p><p>0-STDIN_FILENO</p><p>1-STDOUT_FILENO</p><p>2-STDERR_FILENO</p><h2 id="é˜»å¡å’Œéé˜»å¡"><a href="#é˜»å¡å’Œéé˜»å¡" class="headerlink" title="é˜»å¡å’Œéé˜»å¡"></a>é˜»å¡å’Œéé˜»å¡</h2><p>è¯»å¸¸è§„æ–‡ä»¶æ˜¯ä¸ä¼šé˜»å¡çš„ï¼Œä¸ç®¡è¯»å¤šå°‘å­—èŠ‚ï¼Œread ä¸€å®šä¼šåœ¨æœ‰é™çš„æ—¶é—´å†…è¿”å›ã€‚ä»ç»ˆç«¯è®¾å¤‡æˆ–ç½‘ç»œè¯»åˆ™ä¸ä¸€å®šï¼Œå¦‚æœä»ç»ˆç«¯è¾“å…¥çš„æ•°æ®æ²¡æœ‰æ¢è¡Œç¬¦ï¼Œè°ƒç”¨ read è¯»ç»ˆç«¯è®¾å¤‡å°±ä¼šé˜»å¡ï¼Œå¦‚æœç½‘ç»œä¸Šæ²¡æœ‰æ¥æ”¶åˆ°æ•°æ®åŒ…ï¼Œè°ƒç”¨ read ä»ç½‘ç»œè¯»å°±ä¼šé˜»å¡ï¼Œè‡³äºä¼šé˜»å¡å¤šé•¿æ—¶é—´ä¹Ÿæ˜¯ä¸ç¡®å®šçš„ï¼Œå¦‚æœä¸€ç›´æ²¡æœ‰æ•°æ®åˆ°è¾¾å°±ä¸€ç›´é˜»å¡åœ¨é‚£é‡Œã€‚åŒæ ·ï¼Œå†™å¸¸è§„æ–‡ä»¶æ˜¯ä¸ä¼šé˜»å¡çš„ï¼Œè€Œå‘ç»ˆç«¯è®¾å¤‡æˆ–ç½‘ç»œå†™åˆ™ä¸ä¸€å®šã€‚<br>äº§ç”Ÿé˜»å¡çš„åœºæ™¯ã€‚è®¾å¤‡æ–‡ä»¶ã€è¯»ç½‘ç»œæ–‡ä»¶</p><p>&#x2F;dev&#x2F;tty â€”â€“ç»ˆç«¯æ–‡ä»¶ <code>open(&quot;/dev/tty,O_RDWR|O_NONBLOCK&quot;)</code></p><h2 id="fcntlå‡½æ•°"><a href="#fcntlå‡½æ•°" class="headerlink" title="fcntlå‡½æ•°"></a>fcntlå‡½æ•°</h2><p>è·å–æ–‡ä»¶çŠ¶æ€ï¼šF_GETFL <code>int flags = fctl(0,F_GETFL)</code></p><p>è®¾ç½®æ–‡ä»¶çŠ¶æ€ï¼šF_SETFL  <code>fcntl(STDIN_FILENO,F_SETFL,flags)</code></p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202312021229678.png" alt="image-20231202122934603"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> buf[<span class="number">10</span>];</span><br><span class="line"><span class="type">int</span> flags,n;</span><br><span class="line"><span class="keyword">if</span>((flags = fcntl(STDIN_FILENO,F_GETFL))==<span class="number">-1</span>) <span class="comment">//è·å–stdinå±æ€§ä¿¡æ¯</span></span><br><span class="line">&#123;</span><br><span class="line">perror(<span class="string">&quot;fcntl error&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">flags |= O_NONBLOCK;  <span class="comment">//å¢åŠ O_NONBLOCKä½ä¿¡æ¯</span></span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="keyword">if</span>((ret = fcntl(STDIN_FILENO,F_SETFL,flags))==<span class="number">-1</span>)  <span class="comment">//è®¾ç½®æ ‡å‡†è¾“å…¥æ–‡ä»¶ä¸ºéé˜»å¡çŠ¶æ€</span></span><br><span class="line">&#123;</span><br><span class="line">perror(<span class="string">&quot;fcntl set error&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tryagain:</span><br><span class="line">n = read(STDIN_FILENO,buf,<span class="number">10</span>);</span><br><span class="line"><span class="keyword">if</span>(n&lt;<span class="number">0</span>) <span class="comment">//å½“ä»¥éé˜»å¡çŠ¶æ€è¯»æ–‡ä»¶æ—¶ï¼Œå¦‚æœç¼“å†²åŒºä¸­æ²¡æœ‰æ•°æ®ï¼Œåˆ™è¿”å›-1ï¼ŒåŒæ—¶è®¾ç½®errnoä¸ºEGAINï¼Œå› æ­¤è¿™æ ·åˆ¤æ–­</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>(errno != EAGAIN)&#123;</span><br><span class="line">perror(<span class="string">&quot;read /dev/tty&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">sleep(<span class="number">3</span>);</span><br><span class="line">write(STDOUT_FILENO, <span class="string">&quot;try again\n&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;try again\n&quot;</span>)); <span class="comment">//å‘æ ‡å‡†è¾“å‡ºä¸­å†™å…¥try againï¼Œè¡¨ç¤ºä¸€æ¬¡å°è¯•</span></span><br><span class="line"><span class="keyword">goto</span> tryagain;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¦‚æœä»ç¼“å†²åŒºä¸­è¯»åˆ°æ•°æ®ï¼Œå°±å†™å…¥æ ‡å‡†è¾“å‡ºæ–‡ä»¶ä¸­</span></span><br><span class="line">write(STDOUT_FILENO,buf,n);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="lseekå‡½æ•°"><a href="#lseekå‡½æ•°" class="headerlink" title="lseekå‡½æ•°"></a>lseekå‡½æ•°</h2><p>Linuxç³»ç»Ÿä¸­ä½¿ç”¨ç³»ç»Ÿå‡½æ•°æ¥ä¿®æ”¹æ–‡ä»¶åç§»é‡ï¼ˆè¯»å†™ä½ç½®ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">off_t</span> <span class="title function_">lseek</span><span class="params">(<span class="type">int</span> fd, <span class="type">off_t</span> offset, <span class="type">int</span> whence)</span>;</span><br></pre></td></tr></table></figure><p>å‚æ•°<code>whence</code></p><blockquote><p>SEEK_SET:  ã€€ã€€ä»æ–‡ä»¶å¤´éƒ¨å¼€å§‹åç§»offsetä¸ªå­—èŠ‚ã€‚  </p><p>SEEK_CURï¼š  ã€€ä»æ–‡ä»¶å½“å‰è¯»å†™çš„æŒ‡é’ˆä½ç½®å¼€å§‹ï¼Œå¢åŠ offsetä¸ªå­—èŠ‚çš„åç§»é‡ã€‚  </p><p>SEEK_ENDï¼š  ã€€æ–‡ä»¶åç§»é‡è®¾ç½®ä¸ºæ–‡ä»¶çš„å¤§å°åŠ ä¸Šåç§»é‡å­—èŠ‚ã€‚</p></blockquote><p>è¿”å›å€¼</p><blockquote><p>æˆåŠŸï¼šè¿”å›å€¼æ˜¯è¾ƒæ–‡ä»¶èµ·å§‹ä½ç½®å‘åçš„åç§»é‡</p><p>å¤±è´¥ï¼šè¿”å›-1</p></blockquote><p>æ³¨æ„ï¼šæ‰“å¼€æ–‡ä»¶åï¼Œæ–‡ä»¶çš„è¯»å’Œå†™ä½¿ç”¨åŒä¸€ä¸ªåç§»ä½ç½®</p><p>åº”ç”¨åœºæ™¯ï¼š</p><ul><li><p>æ–‡ä»¶æ‰“å¼€åï¼Œæ–‡ä»¶çš„è¯»å’Œå†™ä½¿ç”¨åŒä¸€ä¸ªåç§»ä½ç½®</p></li><li><p>ä½¿ç”¨lseekè·å–æ–‡ä»¶å¤§å°</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> agrc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> fd = open(argv[<span class="number">1</span>],O_RDWR);</span><br><span class="line"><span class="keyword">if</span>(fd==<span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> len = lseek(fd, <span class="number">0</span>, SEEK_END);  <span class="comment">//è·å–æ–‡ä»¶å¤§å°ï¼Œå•ä½ï¼šå­—èŠ‚</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;length=%d\n&quot;</span>,len);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨lseekæ‹“å±•æ–‡ä»¶å¤§å°ï¼›è¦æƒ³ä½¿æ–‡ä»¶å¤§å°çœŸæ­£æ”¹å˜ï¼Œå¿…é¡»ä½¿ç”¨IOæ“ä½œ</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> agrc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> fd = open(argv[<span class="number">1</span>],O_RDWR);</span><br><span class="line"><span class="keyword">if</span>(fd==<span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> len = lseek(fd, <span class="number">100</span>, SEEK_END); <span class="comment">//lenå¢åŠ 100,æ­¤æ—¶ls -l Read.txtå…¶å¤§å°æ²¡å˜</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;length=%d\n&quot;</span>,len);</span><br><span class="line">write(fd,<span class="string">&quot;\0&quot;</span>,<span class="number">1</span>);   <span class="comment">// è°ƒç”¨IOæ“ä½œï¼Œå†™å…¥ç£ç›˜ã€‚æ­¤æ—¶æ‰å‘ç”Ÿå˜åŒ–</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>act -A Read.txt</code>æŸ¥çœ‹æ–‡ä»¶ï¼ŒåŒ…æ‹¬ç‰¹æ®Šå­—ç¬¦</p><p>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>truncate</code>å‡½æ•°ç›´æ¥æ‹“å±•ï¼Œ<code>truncate(char *path,  off_t length)</code></p><blockquote><p>å¦‚æœæ–‡ä»¶ä»¥å‰å¤§äºæ­¤å¤§å°ï¼Œåˆ™å¤šä½™çš„æ•°æ®å°†ä¸¢å¤±ã€‚ å¦‚æœä¹‹å‰çš„æ–‡ä»¶è¾ƒçŸ­ï¼Œåˆ™ä¼šæ‰©å±•å®ƒï¼Œæ‰©å±•éƒ¨åˆ†è¯»å–ä¸ºç©ºå­—èŠ‚ï¼ˆâ€™\0â€™ï¼‰ã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ç½‘ç»œç¼–ç¨‹ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ç½‘ç»œç¼–ç¨‹-Linuxç³»ç»Ÿç¼–ç¨‹1</title>
      <link href="/2023/11/28/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B1/"/>
      <url>/2023/11/28/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B1/</url>
      
        <content type="html"><![CDATA[<h1 id="Linuxç³»ç»Ÿç¼–ç¨‹1"><a href="#Linuxç³»ç»Ÿç¼–ç¨‹1" class="headerlink" title="Linuxç³»ç»Ÿç¼–ç¨‹1"></a>Linuxç³»ç»Ÿç¼–ç¨‹1</h1><h2 id="å¿«æ·é”®"><a href="#å¿«æ·é”®" class="headerlink" title="å¿«æ·é”®"></a>å¿«æ·é”®</h2><p><code>ctrl+a</code>:å…‰æ ‡ç§»åˆ°å‘½ä»¤è¡Œæœ€å‰é¢</p><p><code>ctrl+e</code>:å…‰æ ‡ç§»åˆ°å‘½ä»¤è¡Œæœ€åé¢</p><p><code>ctrl+u</code>:åˆ é™¤æ•´è¡Œ</p><h2 id="gccç¼–è¯‘çš„å››ä¸ªé˜¶æ®µ"><a href="#gccç¼–è¯‘çš„å››ä¸ªé˜¶æ®µ" class="headerlink" title="gccç¼–è¯‘çš„å››ä¸ªé˜¶æ®µ"></a>gccç¼–è¯‘çš„å››ä¸ªé˜¶æ®µ</h2><ul><li><p>é¢„å¤„ç†ï¼š<code>gcc -E helloworld.c -o helloworld.i</code></p></li><li><p>ç¼–è¯‘ï¼š<code>gcc -S helloworld.i -o helloworld.s</code>           <strong>ç¼–è¯‘é˜¶æ®µå‡ºé”™ï¼Œä¼šç»™å‡ºè¡Œå·</strong></p></li><li><p>æ±‡ç¼–ï¼š<code>gcc -c helloworld.s -o helloworld.o</code></p></li><li><p>é“¾æ¥ï¼š<code>gcc helloworld.o -o helloworld</code>                    <strong>é“¾æ¥é˜¶æ®µå‡ºé”™ï¼Œä¼šæœ‰<code>collect: error: ld</code></strong></p></li></ul><h2 id="gccç¼–è¯‘å¸¸ç”¨å‘½ä»¤"><a href="#gccç¼–è¯‘å¸¸ç”¨å‘½ä»¤" class="headerlink" title="gccç¼–è¯‘å¸¸ç”¨å‘½ä»¤"></a>gccç¼–è¯‘å¸¸ç”¨å‘½ä»¤</h2><ul><li><code>-o</code>ï¼šæŒ‡å®šç”Ÿæˆçš„æ–‡ä»¶</li><li><code>-I </code>ï¼šæŒ‡å®šå¤´æ–‡ä»¶çš„è·¯å¾„</li><li><code>-g</code>ï¼šç¼–è¯‘æ—¶æ·»åŠ è°ƒè¯•è¯­å¥ï¼ˆè¦ä½¿ç”¨gdbè°ƒè¯•æ—¶å¿…é¡»åŠ è¿™ä¸ªå‚æ•°ï¼‰</li><li><code>-Wall</code>ï¼šæ˜¾ç¤ºæ‰€æœ‰è­¦å‘Šä¿¡æ¯</li><li><code>-D</code>ï¼šå‘å½“å‰ç¨‹åºä¸­æ³¨å†Œä¸€ä¸ªå®ï¼Œå¦‚<code>gcc hello.c -D HELLO</code>å°±æ˜¯æ³¨å†Œäº†ä¸€ä¸ªHELLOçš„å®ç”¨ä½œå¼€å…³æ¥è¾“å‡ºè°ƒè¯•ä¿¡æ¯</li></ul><h2 id="é™æ€åº“å’ŒåŠ¨æ€åº“"><a href="#é™æ€åº“å’ŒåŠ¨æ€åº“" class="headerlink" title="é™æ€åº“å’ŒåŠ¨æ€åº“"></a>é™æ€åº“å’ŒåŠ¨æ€åº“</h2><p>é™æ€åº“ä¼šåœ¨é“¾æ¥çš„æ—¶å€™ç›´æ¥æŠŠåº“æ–‡ä»¶å¤åˆ¶åˆ°ç¨‹åºä¸­ï¼Œè¿è¡Œçš„æ—¶å€™ä¸å†ä¾èµ–åº“æ–‡ä»¶ã€‚ä»¥<code>.a</code>ä¸ºåç¼€</p><p>åŠ¨æ€åº“æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½ã€‚ä»¥<code>.so</code>ä¸ºåç¼€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello ç¼–ç¨‹ç ç‘\n&quot;</span>);</span><br><span class="line">    <span class="type">int</span> b = <span class="number">2</span>;</span><br><span class="line">    <span class="type">double</span> a = <span class="built_in">exp</span>(b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lf\n&quot;</span>,a);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯¹äºè¿™ä¸ªå‡½æ•°ï¼Œä½¿ç”¨äº†math.hä¸­çš„expå‡½æ•°</p><p>é™æ€é“¾æ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -<span class="type">static</span> main.c -o main -lm</span><br></pre></td></tr></table></figure><p>åŠ¨æ€é“¾æ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc main.c -o main -lm</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨äº†<code>-l</code>å‚æ•°ï¼Œåè¾¹çš„<code>m</code>æ˜¯<code>math.h</code>çš„åŸºæœ¬åç§°</p><p>å¯ä»¥ä½¿ç”¨<code>ldd main</code>æŸ¥çœ‹åŠ¨æ€é“¾æ¥æ–‡ä»¶çš„éƒ½é“¾æ¥äº†å“ªäº›åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wufang@wufang:~/C++_base_learning$ ldd test1</span><br><span class="line">linux-vdso.so.1 (0x00007ffca1fc5000)</span><br><span class="line">libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f2cb480f000)</span><br><span class="line">libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f2cb4400000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007f2cb490b000)</span><br></pre></td></tr></table></figure><p>å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå‡½æ•°æ˜¯å¦éœ€è¦é“¾æ¥å‘¢ï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man <span class="number">3</span> å‡½æ•°å</span><br></pre></td></tr></table></figure><h2 id="é™æ€åº“åˆ¶ä½œ"><a href="#é™æ€åº“åˆ¶ä½œ" class="headerlink" title="é™æ€åº“åˆ¶ä½œ"></a>é™æ€åº“åˆ¶ä½œ</h2><ol><li>å°†.cæ–‡ä»¶ç¼–è¯‘ç”Ÿæˆ.oæ–‡ä»¶  <code>gcc -c add.c -o add</code></li><li>ä½¿ç”¨arå·¥å…·åˆ¶ä½œé™æ€åº“ <code>ar rcs libåº“å.a add.o sub.o</code></li><li>ç¼–è¯‘é™æ€åº“åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­<code>gcc main.c libåº“å.a -o main </code></li></ol><p>æŒ‰è¿™æ ·ä¸‰éƒ¨ç¼–è¯‘å‡ºå¯æ‰§è¡Œæ–‡ä»¶åï¼Œä¼šå‡ºç°å¦‚ä¸‹è­¦å‘Š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">test.c:<span class="number">8</span>:<span class="number">33</span>: warning: implicit declaration of function â€˜addâ€™ [-Wimplicit-function-declaration]</span><br><span class="line">    <span class="number">8</span> |         <span class="built_in">printf</span>(<span class="string">&quot;%d+%d=%d\n&quot;</span>,a,b,add(a,b));</span><br><span class="line">      |                                 ^~~</span><br><span class="line">test.c:<span class="number">9</span>:<span class="number">33</span>: warning: implicit declaration of function â€˜subâ€™ [-Wimplicit-function-declaration]</span><br><span class="line">    <span class="number">9</span> |         <span class="built_in">printf</span>(<span class="string">&quot;%d-%d=%d\n&quot;</span>,a,b,sub(a,b));</span><br><span class="line">      |                                 ^~~</span><br><span class="line">wufang@wufang:~/C++_base_learning$ ./test</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè­¦å‘Šå‘Šè¯‰ï¼š<strong>å¯¹addçš„éšå¼å£°æ˜</strong>ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–å¯¹ä½¿ç”¨çš„åº“å‡½æ•°è¿›è¡Œå£°æ˜ï¼Œå†™åœ¨ä¸€ä¸ª<code>åº“å.h</code>æ–‡ä»¶ä¸­ï¼Œæ–‡ä»¶æ ¼å¼å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _MYMATH_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _MMYMATH_H_</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span>,<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sub</span><span class="params">(<span class="type">int</span>,<span class="type">int</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>è¿™ä½¿ç”¨äº†å¤´æ–‡ä»¶é¦–ä½ï¼Œç›®çš„æ˜¯ï¼šé˜²æ­¢é‡å¤å¼•å…¥å’Œé‡å¤å®šä¹‰ã€‚<a href="https://www.cnblogs.com/flowingwind/p/8304668.html">https://www.cnblogs.com/flowingwind/p/8304668.html</a></p><p>åˆ¶ä½œå¥½.hæ–‡ä»¶åï¼Œåœ¨.cppæ–‡ä»¶ä¸­å¼•å…¥.hå¤´æ–‡ä»¶ï¼ˆ<code>#include &quot;mymath.h&quot;</code>ï¼‰ã€‚æ­¤æ—¶çš„ç¼–è¯‘å‘½ä»¤ä¸º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc main.c ./lib/libåº“å.a -o main.out -I ./inc</span><br></pre></td></tr></table></figure><p>é™æ€åº“æ–‡ä»¶æ”¾åœ¨libä¸­ï¼Œå¤´æ–‡ä»¶æ”¾åœ¨incä¸­</p><h2 id="åŠ¨æ€åº“åˆ¶ä½œ"><a href="#åŠ¨æ€åº“åˆ¶ä½œ" class="headerlink" title="åŠ¨æ€åº“åˆ¶ä½œ"></a>åŠ¨æ€åº“åˆ¶ä½œ</h2><p>å‚è€ƒï¼š<a href="https://cloud.tencent.com/developer/article/1711778">https://cloud.tencent.com/developer/article/1711778</a></p><ol><li><p>å°†.cæ–‡ä»¶ç¼–è¯‘ç”Ÿæˆä¸ä½ç½®æ— å…³çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š<code>gcc -c add.c -o add.o -fPIC </code></p></li><li><p>ä½¿ç”¨<code>gcc -shared</code>åˆ¶ä½œåŠ¨æ€åº“ï¼š<code>gcc -shared -o libåº“å.so add.o sub.o div.o</code></p></li><li><p>ç¼–è¯‘å¯æ‰§è¡Œç¨‹åºï¼ŒæŒ‡å®šæ‰€ä½¿ç”¨çš„åŠ¨æ€åº“ã€‚ <code>-l</code>æŒ‡å®šåº“åï¼Œ<code>-L</code>æŒ‡å®šåŠ¨æ€åº“è·¯å¾„, <code>-I</code>æŒ‡å®šåº“çš„å¤´æ–‡ä»¶è·¯å¾„</p><p><code>gcc test.c -o test.out -låº“å -L./lib -I ./inc</code></p></li></ol><p><strong>æ³¨æ„ï¼š-låè¾¹ç´§è·Ÿåº“åï¼Œ-Låç´§è·Ÿåº“è·¯å¾„ï¼Œç©ºæ ¼å¯æœ‰å¯æ— </strong></p><p>æŒ‰ä¸Šè¾¹æ­¥éª¤å®Œæˆåï¼Œè¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼ŒæŠ¥é”™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wufang@wufang:~/C++_base_learning/dynamic$ gcc test.c -o test.out -lmymath -L./lib -I./inc</span><br><span class="line">wufang@wufang:~/C++_base_learning/dynamic$ ./test.out </span><br><span class="line">./test.out: error <span class="keyword">while</span> loading shared libraries: libmymath.so: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæŠ¥é”™æ˜¯å› ä¸º<strong>åŠ¨æ€é“¾æ¥å™¨</strong>åœ¨è¿è¡Œç¨‹åºçš„æ—¶å€™æ‰¾ä¸åˆ°éœ€è¦é“¾æ¥çš„åº“ã€‚è§£å†³åŠæ³•æœ‰ä¸‰ç§ï¼Œå¦‚ä¸‹ç»™å‡ºè§†é¢‘ä¸­çš„æ–¹æ³•ï¼š</p><p>å³ å°†åŠ¨æ€åº“çš„è·¯å¾„å†™å…¥<strong>ç”¨æˆ·ç»ˆç«¯é…ç½®æ–‡ä»¶</strong><code>.bashrc</code>ä¸­ï¼Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.bachrc  <span class="comment">#æ‰“å¼€ç”¨æˆ·è‡ªå·±çš„ç»ˆç«¯é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=....  <span class="comment">#æ·»åŠ é“¾æ¥è·¯å¾„ï¼Œæœ€å¥½ä½¿ç”¨ç»å¯¹è·¯å¾„</span></span><br><span class="line"><span class="built_in">source</span> .bashrc   <span class="comment">#è¿è¡Œç”Ÿæ•ˆ</span></span><br></pre></td></tr></table></figure><p>è§£å†³æ–¹æ³•åˆé›†ï¼š<a href="https://www.jianshu.com/p/a3b2b6f5f0fc">https://www.jianshu.com/p/a3b2b6f5f0fc</a></p><h2 id="gdbè°ƒè¯•å·¥å…·"><a href="#gdbè°ƒè¯•å·¥å…·" class="headerlink" title="gdbè°ƒè¯•å·¥å…·"></a>gdbè°ƒè¯•å·¥å…·</h2><p>åŸºç¡€æŒ‡ä»¤ï¼š</p><ul><li><code>-g</code>ï¼šä½¿ç”¨è¯¥å‚æ•°ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¾—åˆ°è°ƒè¯•è¡¨</li><li><code>gdb ./a.out</code>ï¼š</li><li><code>set listsize è¡Œæ•°</code>ï¼šè®¾ç½®listæ‰“å°è¡Œæ•°</li><li><code>list 1</code>ï¼šä»ç¬¬ä¸€è¡Œå¼€å§‹æ‰“å°</li><li><code>b/break</code>ï¼šè®¾ç½®æ–­ç‚¹ï¼Œåè¾¹å¯ä»¥è·Ÿç€è¡Œå·æˆ–è€…å‡½æ•°å</li><li><code>run</code>ï¼šç›´æ¥è¿è¡Œç¨‹åºï¼Œå¦‚æœè®¾ç½®æ–­ç‚¹äº†ï¼Œä¼šè¿è¡Œåˆ°æ–­ç‚¹ï¼Œå¦‚æœç¨‹åºå‡ºé”™äº†ï¼Œä¼šç›´æ¥è¿è¡Œåˆ°å‡ºé”™ä½ç½®</li><li><code>s/step</code>ï¼šä¸‹ä¸€æ¡æŒ‡ä»¤ï¼ˆä¼šè¿›å…¥å‡½æ•°ï¼‰</li><li><code>n/next</code>ï¼šä¸‹ä¸€æ¡æŒ‡ä»¤ï¼ˆè¶Šè¿‡å‡½æ•°ï¼‰</li><li><code>finish</code>ï¼šè¿›å…¥å‡½æ•°åï¼Œç»“æŸå½“å‰å‡½æ•°è°ƒç”¨ï¼Œå³é€€å‡ºè¯¥å‡½æ•°</li><li><code>p/print</code>ï¼šp i æŸ¥çœ‹å˜é‡içš„å€¼</li><li><code>c/continue</code>ï¼šè¿è¡Œç¨‹åºåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹æˆ–è€…ç»“æŸ</li><li><code>quit</code>ï¼šé€€å‡ºgdb</li></ul><p>å…¶å®ƒæŒ‡ä»¤ï¼š</p><ul><li><p><code>start</code>ï¼šä»mainå‡½æ•°çš„ç¬¬ä¸€è¡Œå¼€å§‹</p></li><li><p><code>set args</code>ï¼šè®¾ç½®mainå‡½æ•°å‘½ä»¤è¡Œå‚æ•°</p></li><li><p><code>info b</code>ï¼šæŸ¥çœ‹æ‰€æœ‰æ–­ç‚¹ä¿¡æ¯</p></li><li><p><code>b 20 if i = 5</code>è®¾ç½®æ¡ä»¶æ–­ç‚¹ï¼Œç”¨åœ¨å¾ªç¯è¯­å¥ï¼ŒåµŒå¥—é€’å½’ä¸­</p></li><li><p><code>bt</code>ï¼šæŸ¥çœ‹ç¨‹åºä¸­æ­£åœ¨å­˜æ´»çš„æ ˆå¸§</p></li><li><p><code>fram æ ˆå¸§ç¼–å·</code>ï¼šåˆ‡æ¢æ ˆå¸§</p></li><li><p><code>display å˜é‡</code>ï¼šè·Ÿè¸ªå˜é‡</p></li><li><p><code>undisplay å˜é‡ç¼–å·</code>ï¼šå–æ¶ˆè·Ÿè¸ª</p></li></ul><h2 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h2><h3 id="ç®€æ˜“ç‰ˆ"><a href="#ç®€æ˜“ç‰ˆ" class="headerlink" title="ç®€æ˜“ç‰ˆ"></a>ç®€æ˜“ç‰ˆ</h3><p>test.cä¸­æ˜¯è¿™æ ·çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œå°†å‡½æ•°å£°æ˜å†™åœ¨äº†mainå‡½æ•°ä¸­ï¼Œåç»­ä¼šç»™å‡ºå°†å‡½æ•°å£°æ˜å†™åœ¨.hä¸­</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span>,<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sub</span><span class="params">(<span class="type">int</span>,<span class="type">int</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> a = <span class="number">14</span>, b = <span class="number">7</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d+%d=%d\n&quot;</span>,a,b,add(a,b));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d-%d=%d\n&quot;</span>,a,b,sub(a,b));</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>1ä¸ªè§„åˆ™ï¼š</strong></p><p>ç›®æ ‡ï¼šä¾èµ–æ¡ä»¶</p><p>â€‹ï¼ˆä¸€ä¸ªTabç¼©è¿›ï¼‰å‘½ä»¤</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">test:test.o add.o sub.o</span></span><br><span class="line">        gcc test.o add.o sub.o -o test</span><br><span class="line"></span><br><span class="line"><span class="section">test.o:test.c</span></span><br><span class="line">        gcc -c test.c -o test.o</span><br><span class="line"></span><br><span class="line"><span class="section">add.o:add.c</span></span><br><span class="line">        gcc -c add.c -o add.o</span><br><span class="line"></span><br><span class="line"><span class="section">sub.o:sub.c</span></span><br><span class="line">        gcc -c sub.c -o sub.o</span><br></pre></td></tr></table></figure><p>åŸºæœ¬åŸåˆ™ï¼š</p><ol><li>è‹¥æƒ³ç”Ÿæˆç›®æ ‡æ–‡ä»¶ï¼Œæ£€æŸ¥è§„åˆ™ä¸­çš„ä¾èµ–æ¡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚ä¸å­˜åœ¨ï¼Œåˆ™å¯»æ‰¾æ˜¯å¦æœ‰è§„åˆ™ç”¨æ¥ç”Ÿæˆè¯¥ä¾èµ–æ–‡ä»¶</li><li>æ£€æŸ¥è§„åˆ™ä¸­çš„ç›®æ ‡æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œå¿…é¡»å…ˆæ£€æŸ¥å®ƒçš„æ‰€æœ‰ä¾èµ–ï¼Œä¾èµ–ä¸­æœ‰ä»»ä½•ä¸€é¡¹è¢«æ›´æ–°ï¼Œåˆ™ç›®æ ‡æ›´æ–°</li></ol><p><strong>2ä¸ªå‡½æ•°ï¼š</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">src = <span class="variable">$(<span class="built_in">wildcard</span> *.c)</span>   <span class="comment">#æ‰¾åˆ°å½“å‰ç›®å½•ä¸‹æ‰€æœ‰åç¼€æœª.cçš„æ–‡ä»¶ï¼Œèµ‹å€¼ç»™src</span></span><br><span class="line">obj = <span class="variable">$(<span class="built_in">patsubst</span> %.c, %.o <span class="variable">$(src)</span>)</span>  <span class="comment">#å°†srcå˜é‡ä¸­åŒ…å«.cåç¼€çš„æ–‡ä»¶éƒ½æ›¿æ¢æˆ.oåç¼€</span></span><br><span class="line"></span><br><span class="line"><span class="section">test:@(obj)</span></span><br><span class="line">        gcc @(obj) -o test</span><br><span class="line"></span><br><span class="line"><span class="section">test.o:test.c</span></span><br><span class="line">        gcc -c test.c -o test.o</span><br><span class="line"></span><br><span class="line"><span class="section">add.o:add.c</span></span><br><span class="line">        gcc -c add.c -o add.o</span><br><span class="line"></span><br><span class="line"><span class="section">sub.o:sub.c</span></span><br><span class="line">        gcc -c sub.c -o sub.o</span><br><span class="line">        </span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">-rm -rf <span class="variable">$(obj)</span> test   <span class="comment">#å°†ç”Ÿæˆçš„.oæ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶éƒ½åˆ äº†ï¼Œrmå‰çš„&quot;-&quot;è¡¨ç¤ºå‡ºé”™ä¾ç„¶æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><p><strong>3ä¸ªå˜é‡ï¼š</strong></p><blockquote><p>$@ï¼šåœ¨ä¸€æ¡è§„åˆ™çš„<strong>å‘½ä»¤</strong>ä¸­ï¼Œè¡¨ç¤ºè¯¥è§„åˆ™çš„ç›®æ ‡</p><p>$^ï¼šåœ¨ä¸€æ¡è§„åˆ™çš„å‘½ä»¤ä¸­ä½¿ç”¨ï¼Œç”¨äºè¡¨ç¤ºè¿™æ¡è§„åˆ™çš„æ‰€æœ‰ä¾èµ–æ¡ä»¶</p><p>$&lt;ï¼šåœ¨ä¸€æ¡è§„åˆ™çš„å‘½ä»¤ä¸­ä½¿ç”¨ï¼Œç”¨äºè¡¨ç¤ºè¿™æ¡è§„åˆ™çš„ä¾èµ–æ¡ä»¶åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªä¾èµ–æ¡ä»¶</p></blockquote><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">src = <span class="variable">$(<span class="built_in">wildcard</span> *.c)</span>  </span><br><span class="line">obj = <span class="variable">$(<span class="built_in">patsubst</span> %.c, %.o, <span class="variable">$(src)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">test:<span class="variable">$(obj)</span></span></span><br><span class="line">gcc <span class="variable">$^</span>  -o test</span><br><span class="line"></span><br><span class="line"><span class="section">test.o:test.c</span></span><br><span class="line">gcc -c <span class="variable">$&lt;</span> -o test.o</span><br><span class="line"></span><br><span class="line"><span class="section">add.o:add.c</span></span><br><span class="line">gcc -c <span class="variable">$&lt;</span> -o add.o</span><br><span class="line"></span><br><span class="line"><span class="section">sub.o:sub.c</span></span><br><span class="line">gcc -c <span class="variable">$&lt;</span> -o sub.o</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">-rm -rf <span class="variable">$(obj)</span> test</span><br></pre></td></tr></table></figure><p><strong>æ¨¡å¼è§„åˆ™ï¼š</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">test.o:test.c</span></span><br><span class="line">gcc -c <span class="variable">$&lt;</span> -o test.o</span><br><span class="line"><span class="section">add.o:add.c</span></span><br><span class="line">gcc -c <span class="variable">$&lt;</span> -o add.o</span><br><span class="line"><span class="section">sub.o:sub.c</span></span><br><span class="line">gcc -c <span class="variable">$&lt;</span> -o sub.o</span><br><span class="line"><span class="comment"># å¯ä»¥å°†ä¸Šé¢çš„ç»“æ„é‡å¤çš„ä»£ç åšå¦‚ä¸‹æ›¿æ¢</span></span><br><span class="line"><span class="section">%.o:%.c</span></span><br><span class="line">gcc -c <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆçš„makefileä»£ç å¯ä»¥è¿™æ ·å†™</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">src = <span class="variable">$(<span class="built_in">wildcard</span> *.c)</span>  </span><br><span class="line">obj = <span class="variable">$(<span class="built_in">patsubst</span> %.c, %.o, <span class="variable">$(src)</span>)</span></span><br><span class="line"></span><br><span class="line">CXX = gcc  <span class="comment">#ç¼–è¯‘å™¨ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ”¹æˆg++</span></span><br><span class="line">myArgs = -Wall -g <span class="comment">#è°ƒè¯•é€‰é¡¹ï¼Œä½¿å¾—ç¼–è¯‘çš„æ–‡ä»¶å¯ä»¥è¿›è¡Œè°ƒè¯•</span></span><br><span class="line"></span><br><span class="line"><span class="section">test:<span class="variable">$(obj)</span></span></span><br><span class="line"><span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span> <span class="variable">$(myArgs)</span></span><br><span class="line"><span class="section">%.o:%.c</span></span><br><span class="line"><span class="variable">$(CXX)</span> -c <span class="variable">$&lt;</span> -o <span class="variable">$@</span> <span class="variable">$(myArgs)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>:clean  #ä¼ªç›®æ ‡ï¼Œå› ä¸ºæ–‡ä»¶å¤¹ä¸­å¯èƒ½å­˜åœ¨åŒåçš„cleanæ–‡ä»¶</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">-rm -rf <span class="variable">$(obj)</span> test</span><br></pre></td></tr></table></figure><h3 id="é‡æ„ç‰ˆ"><a href="#é‡æ„ç‰ˆ" class="headerlink" title="é‡æ„ç‰ˆ"></a>é‡æ„ç‰ˆ</h3><p>é¡¹ç›®æ–‡ä»¶å¤¹ä¸‹æœ‰å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inc       makefile  obj       src</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>inc</code>æ–‡ä»¶å¤¹å­˜æ”¾<code>å¤´æ–‡ä»¶</code>ï¼Œ<code>src</code>æ–‡ä»¶å¤¹å­˜æ”¾<code>.cæˆ–è€….cppæºä»£ç </code>ï¼Œ<code>obj</code>æ–‡ä»¶å¤¹å­˜æ”¾<code>.oç›®æ ‡æ–‡ä»¶</code></p><p><code>makefile</code>æ–‡ä»¶å¦‚ä¸‹</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">src = <span class="variable">$(<span class="built_in">wildcard</span> ./src/*.c)</span></span><br><span class="line">obj = <span class="variable">$(<span class="built_in">patsubst</span> ./src/%.c, ./obj/%.o, <span class="variable">$(src)</span>)</span></span><br><span class="line"></span><br><span class="line">inc_path = ./inc  <span class="comment">#å¤´æ–‡ä»¶æ‰€åœ¨ä½ç½®</span></span><br><span class="line">myArgs = -Wall -g</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">test:<span class="variable">$(obj)</span></span></span><br><span class="line">        gcc <span class="variable">$^</span> -o test <span class="variable">$(myArgs)</span></span><br><span class="line">        </span><br><span class="line"><span class="variable">$(obj)</span>:./obj%.o:./src%.c</span><br><span class="line">        gcc -c <span class="variable">$&lt;</span> -o <span class="variable">$@</span> <span class="variable">$(myArgs)</span> -I <span class="variable">$(inc_path)</span>  <span class="comment">#åœ¨ç¼–è¯‘ç”Ÿæˆç›®æ ‡æ–‡ä»¶æ—¶éœ€è¦æŒ‡å‡ºå¤´æ–‡ä»¶ä½ç½®</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">        -rm -rf <span class="variable">$(obj)</span> test</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ç½‘ç»œç¼–ç¨‹ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Vscodeè°ƒè¯•Linuxå†…æ ¸</title>
      <link href="/2023/11/20/Vscode%E8%B0%83%E8%AF%95Linux%E5%86%85%E6%A0%B8/"/>
      <url>/2023/11/20/Vscode%E8%B0%83%E8%AF%95Linux%E5%86%85%E6%A0%B8/</url>
      
        <content type="html"><![CDATA[<h1 id="ä½¿ç”¨Vscodeè°ƒè¯•Linuxå†…æ ¸"><a href="#ä½¿ç”¨Vscodeè°ƒè¯•Linuxå†…æ ¸" class="headerlink" title="ä½¿ç”¨Vscodeè°ƒè¯•Linuxå†…æ ¸"></a>ä½¿ç”¨Vscodeè°ƒè¯•Linuxå†…æ ¸</h1><p>ä¸Šä¸€ç¯‡åšå®¢æˆ‘ä»¬åœ¨è™šæ‹Ÿæœºä¸­ç¼–è¯‘äº†Linuxå†…æ ¸ï¼Œå¹¶ä¸”ä½¿ç”¨Qemuå’Œgdbè¿›è¡Œè°ƒè¯•ï¼Œä½†æ˜¯gdbçš„æŒ‡ä»¤æˆ‘è¿˜ä¸ç†Ÿç»ƒï¼Œè¿˜æ˜¯æƒ³ç”¨vscodeæ¥è°ƒè¯•ï¼Œè¿™æ ·ä¹Ÿæ›´åŠ æ–¹ä¾¿</p><h2 id="Vscodeæ’ä»¶å®‰è£…"><a href="#Vscodeæ’ä»¶å®‰è£…" class="headerlink" title="Vscodeæ’ä»¶å®‰è£…"></a>Vscodeæ’ä»¶å®‰è£…</h2><h3 id="remote-ssh"><a href="#remote-ssh" class="headerlink" title="remote-ssh"></a>remote-ssh</h3><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202311201245007.png" alt="image-20231120124509960"></p><p>å®‰è£…å®Œæˆåå³è¾¹å·¥å…·æ ä¼šå¤šå‡ºä¸€ä¸ªåŠŸèƒ½</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202311201246229.png" alt="image-20231120124653194"></p><p>æŒ‰F1å‘¼å‡ºå¯¹è¯æ¡†ï¼Œè¾“å…¥<code>remote-ssh</code>ï¼Œé€‰æ‹©open ssh configuration fileã€‚</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202311201247886.png" alt="image-20231120124748850"></p><p>é€‰æ‹©ç¬¬ä¸€ä¸ªé…ç½®æ–‡ä»¶</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202311201248231.png" alt="image-20231120124824202"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Host è‡ªå®šä¹‰è¿æ¥åç§°</span><br><span class="line">    HostName æœåŠ¡å™¨IPåœ°å€</span><br><span class="line">    User ç”¨æˆ·å</span><br></pre></td></tr></table></figure><h3 id="C-C"><a href="#C-C" class="headerlink" title="C&#x2F;C++"></a>C&#x2F;C++</h3><p>å®‰è£…C&#x2F;C++æ’ä»¶</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202311201251048.png" alt="image-20231120125110014"></p><p>ä¾æ¬¡ç‚¹å‡»ã€è¿è¡Œã€‘-&gt;ã€æ‰“å¼€é…ç½®ã€‘ï¼Œå°†ä»¥ä¸‹é…ç½®å¤åˆ¶åˆ°launch.jsonä¸­ã€‚</p><p><strong>è¯¥ä»£ç ä¸éœ€è¦æ›´æ”¹ï¼Œç›´æ¥ç²˜è´´</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ IntelliSense äº†è§£ç›¸å…³å±æ€§ã€‚ </span></span><br><span class="line">    <span class="comment">// æ‚¬åœä»¥æŸ¥çœ‹ç°æœ‰å±æ€§çš„æè¿°ã€‚</span></span><br><span class="line">    <span class="comment">// æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kernel-debug&quot;</span><span class="punctuation">,</span>   <span class="comment">//éšä¾¿èµ·å</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;miDebuggerServerAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1:1234&quot;</span><span class="punctuation">,</span>  <span class="comment">//è¿œç«¯è°ƒè¯•åœ°å€ï¼Œ1234ä¸ºqemuçš„ç›‘è§†ç«¯å£</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/vmlinux&quot;</span><span class="punctuation">,</span>     <span class="comment">//å½“å‰ç›®å½•ä¸‹çš„vmlinux</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;stopAtEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;externalConsole&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;engineLogging&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MIMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="Vscodeè°ƒè¯•"><a href="#Vscodeè°ƒè¯•" class="headerlink" title="Vscodeè°ƒè¯•"></a>Vscodeè°ƒè¯•</h2><h3 id="åœ¨è™šæ‹Ÿæœºä¸­å¯åŠ¨qemu"><a href="#åœ¨è™šæ‹Ÿæœºä¸­å¯åŠ¨qemu" class="headerlink" title="åœ¨è™šæ‹Ÿæœºä¸­å¯åŠ¨qemu"></a>åœ¨è™šæ‹Ÿæœºä¸­å¯åŠ¨qemu</h3><p>åœ¨<strong>Linuxå†…æ ¸æ–‡ä»¶å¤¹ä¸‹</strong>è¿è¡Œæ­¤å‘½ä»¤</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -kernel ./arch/x86/boot/bzImage -initrd ../initramfs.cpio.gz -append <span class="string">&quot;nokaslr console=ttyS0&quot;</span> -s -S -nographic</span><br></pre></td></tr></table></figure><h3 id="æ‰“æ–­ç‚¹"><a href="#æ‰“æ–­ç‚¹" class="headerlink" title="æ‰“æ–­ç‚¹"></a>æ‰“æ–­ç‚¹</h3><p>æ‰“å¼€init&#x2F;main.cï¼Œæˆ‘æ‰“äº†å¦‚ä¸‹çš„æ–­ç‚¹</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202311201300424.png" alt="image-20231120130037370"></p><h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202311201305050.png" alt="image-20231120130522009"></p><p>ç„¶ååœ¨vscodeä¸­å°±å¯ä»¥çœ‹åˆ°è°ƒè¯•ç»“æœäº†</p><h2 id="ä»£ç ä¸­æ ‡çº¢çš„é—®é¢˜"><a href="#ä»£ç ä¸­æ ‡çº¢çš„é—®é¢˜" class="headerlink" title="ä»£ç ä¸­æ ‡çº¢çš„é—®é¢˜"></a>ä»£ç ä¸­æ ‡çº¢çš„é—®é¢˜</h2><p>ä»£ç æ ‡çº¢æ˜¯ç¼ºå°‘compile_commands.jsonæ–‡ä»¶</p><p>æˆ‘åœ¨Bç«™ä¸Šå­¦ä¹ çš„æ—¶å€™ï¼Œæ˜¯è·Ÿç€è¿™ä½upä¸»æ¥çš„ï¼ˆæºç è¢«çŒ«åƒäº†ï¼‰ï¼Œä»–çš„è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><p>åœ¨ç»ˆç«¯é”®å…¥å‘½ä»¤</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./scripts/clang-tools/gen_compile_commands.py</span><br></pre></td></tr></table></figure><p>åœ¨æºç ç›®å½•ä¸‹å°±ç”Ÿæˆäº†<code>compile_commands.json</code>æ–‡ä»¶</p><p>åœ¨vscodeä¸­ï¼š<code>ctrl+shipt+p</code>é€‰æ‹©C&#x2F;C++ï¼šEdit Coonfigurations,</p><p>åœ¨c_cpp_properties.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;includePath&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;$&#123;workspaceFolder&#125;/**&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;defines&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;compilerPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/usr/bin/gcc&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c17&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cppStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gnu++17&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;intelliSenseMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux-gcc-x64&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;compileCommands&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/compile_commands.json&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æ­¤åï¼Œmain.cä¸­çš„ä»£ç å°±ä¸æ ‡çº¢äº†</p>]]></content>
      
      
      <categories>
          
          <category> Linuxå†…æ ¸ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨è™šæ‹Ÿæœºè¿›è¡ŒåŸºäºqemuå’Œgdbçš„Linuxå†…æ ¸è°ƒè¯•</title>
      <link href="/2023/11/20/%E4%BD%BF%E7%94%A8%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%9B%E8%A1%8C%E5%9F%BA%E4%BA%8Eqemu%E5%92%8Cgdb%E7%9A%84Linux%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95/"/>
      <url>/2023/11/20/%E4%BD%BF%E7%94%A8%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%9B%E8%A1%8C%E5%9F%BA%E4%BA%8Eqemu%E5%92%8Cgdb%E7%9A%84Linux%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h1 id="ä½¿ç”¨è™šæ‹Ÿæœºè¿›è¡ŒåŸºäºqemuå’Œgdbçš„Linuxå†…æ ¸è°ƒè¯•"><a href="#ä½¿ç”¨è™šæ‹Ÿæœºè¿›è¡ŒåŸºäºqemuå’Œgdbçš„Linuxå†…æ ¸è°ƒè¯•" class="headerlink" title="ä½¿ç”¨è™šæ‹Ÿæœºè¿›è¡ŒåŸºäºqemuå’Œgdbçš„Linuxå†…æ ¸è°ƒè¯•"></a>ä½¿ç”¨è™šæ‹Ÿæœºè¿›è¡ŒåŸºäºqemuå’Œgdbçš„Linuxå†…æ ¸è°ƒè¯•</h1><h2 id="è™šæ‹Ÿæœºé…ç½®"><a href="#è™šæ‹Ÿæœºé…ç½®" class="headerlink" title="è™šæ‹Ÿæœºé…ç½®"></a>è™šæ‹Ÿæœºé…ç½®</h2><p>è‡³å°‘åˆ†8ä¸ªæ ¸å¿ƒï¼ˆä¸ç„¶ç¼–è¯‘é€Ÿåº¦å¾ˆæ…¢ï¼Œäº²æµ‹ï¼‰</p><p>ç£ç›˜å¤§å°åˆ†50Gï¼ˆç¼–è¯‘åçš„å†…æ ¸å¤§å°æœ‰20å¤šä¸ªGï¼ï¼‰</p><h2 id="æ‰“å¼€SSH"><a href="#æ‰“å¼€SSH" class="headerlink" title="æ‰“å¼€SSH"></a>æ‰“å¼€SSH</h2><p>è™šæ‹Ÿæœºä¸­å®‰è£…çš„æ˜¯ubuntu22.04ç‰ˆæœ¬ï¼Œé»˜è®¤æ²¡æœ‰å®‰è£…å’Œå¯ç”¨SSHæœåŠ¡</p><p><strong>æ›´æ–°è½¯ä»¶æº</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt upgrade -y</span><br></pre></td></tr></table></figure><p><strong>å®‰è£…SSH(OpenSSH)</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install openssh-server -y</span><br></pre></td></tr></table></figure><p><strong>å¯åŠ¨SSHæœåŠ¡</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> --now ssh</span><br></pre></td></tr></table></figure><p><strong>æ£€æŸ¥æ˜¯å¦å¯åŠ¨æˆåŠŸ</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status ssh</span><br></pre></td></tr></table></figure><h2 id="å†…æ ¸ç¼–è¯‘"><a href="#å†…æ ¸ç¼–è¯‘" class="headerlink" title="å†…æ ¸ç¼–è¯‘"></a>å†…æ ¸ç¼–è¯‘</h2><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…ç›¸å…³ä¾èµ–</span></span><br><span class="line">sudo apt-get install libncurses5-dev libssl-dev bison flex libelf-dev gcc g++ make openssl libc6-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…gdbï¼Œè¿™é‡Œä½¿ç”¨aptå®‰è£…ï¼ˆå¤šæ¬¡å°è¯•çš„ç»“æœï¼‰</span></span><br><span class="line">sudo apt-get install gdb</span><br><span class="line">gdb --version <span class="comment"># gdbç‰ˆæœ¬ä¸º12.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿™é‡Œé€‰æ‹©æ¸…åæºï¼Œå›½å†…é€Ÿåº¦ä¼šå¿«å¾ˆå¤š</span></span><br><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/kernel/v5.x/linux-5.14.tar.gz</span><br><span class="line"><span class="comment"># è§£å‹</span></span><br><span class="line">tar -xvf linux-5.14.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#é…ç½®ç¼–è¯‘é€‰é¡¹</span></span><br><span class="line">make menuconfig</span><br></pre></td></tr></table></figure><p>ç„¶åä¼šåœ¨æ­¤æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆ <strong>.&#x2F;config</strong>æ–‡ä»¶</p><p><strong>è¿›å…¥è¯¥æ–‡ä»¶ï¼Œå¹¶åšä»¥ä¸‹2å¤„ä¿®æ”¹</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ./.config</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202311201128412.png" alt="image-20231117212013850"></p><p><strong>å®‰è£…dwarvesè½¯ä»¶åŒ…ï¼ˆç¼–è¯‘æŠ¥é”™å¾—å‡ºç»“è®ºï¼‰</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install dwarves</span><br></pre></td></tr></table></figure><p><strong>BTFæŠ¥é”™è§£å†³</strong></p><p>å¦‚æœä»…ä»…åªè¿›è¡Œäº†ä¸Šè¾¹çš„é…ç½®ï¼Œä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼ˆæˆ‘ä¸ªäººæ˜¯è¿™æ ·ï¼‰</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  KSYMS   .tmp_vmlinux.kallsyms1.S</span><br><span class="line">  AS      .tmp_vmlinux.kallsyms1.S</span><br><span class="line">  LD      .tmp_vmlinux.kallsyms2</span><br><span class="line">  KSYMS   .tmp_vmlinux.kallsyms2.S</span><br><span class="line">  AS      .tmp_vmlinux.kallsyms2.S</span><br><span class="line">  LD      vmlinux</span><br><span class="line">  BTFIDS  vmlinux</span><br><span class="line">FAILED: load BTF from vmlinux: Invalid argument</span><br><span class="line">make: *** [Makefile:1187: vmlinux] Error 255</span><br><span class="line">make: *** Deleting file <span class="string">&#x27;vmlinux&#x27;</span></span><br></pre></td></tr></table></figure><p>æŸ¥é˜…èµ„æ–™åï¼Œæœ‰ä¸‰ç§è§£å†³æ–¹æ¡ˆï¼š<a href="https://devkernel.io/posts/pahole-error/">https://devkernel.io/posts/pahole-error/</a></p><p>æˆ‘ä½¿ç”¨çš„æ˜¯<strong>ç¬¬äºŒç§æ–¹æ³•</strong>ï¼Œå¯¹paholeè½¯ä»¶åŒ…è¿›è¡Œé™çº§ :</p><p>æŸ¥çœ‹paholeçš„ç‰ˆæœ¬ï¼Œæ˜¯1.25</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pahole --version  </span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹paholeçš„æ‰€æœ‰å¯ç”¨å®‰è£…ç‰ˆæœ¬</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-cache policy pahole</span><br></pre></td></tr></table></figure><p>æˆªå›¾å¦‚ä¸‹</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202311201127209.png" alt="1"></p><p>æˆ‘ä»¬å‘ç°åªæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œå› æ­¤åªèƒ½é™çº§ä¸º 1.22-8</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install pahole=1.22-8</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j8      <span class="comment">#8ä¸ªçº¿ç¨‹å¹¶è¡Œç¼–è¯‘ï¼Œ</span></span><br></pre></td></tr></table></figure><p>ç„¶åå¯èƒ½ä¼šå¼¹å‡ºä¸€ä¸ªé€‰æ‹©ï¼ˆ1ï¼Œ2ï¼Œ3ï¼‰ï¼Œç›´æ¥é€‰æ‹©1å³å¯ã€‚ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œ30åˆ†é’Ÿå·¦å³</p><h3 id="æ˜¯å¦æˆåŠŸ"><a href="#æ˜¯å¦æˆåŠŸ" class="headerlink" title="æ˜¯å¦æˆåŠŸ"></a>æ˜¯å¦æˆåŠŸ</h3><p>ç¼–è¯‘å®Œæˆåï¼Œç›®å½•ä¸‹ä¼šç”Ÿæˆä»¥ä¸‹,é‚£ä¹ˆå°±ç¼–è¯‘æˆåŠŸäº†</p><blockquote><p>.&#x2F;vmLinux</p><p>.&#x2F;arch&#x2F;x86&#x2F;boot&#x2F;bzImage</p><p>å…¶ä¸­vmLinuxä¸ºGDBæ‰€éœ€çš„è°ƒè¯•Mapæ–‡ä»¶ï¼ŒbzImageä¸ºå¤§å†…æ ¸æ–‡ä»¶</p></blockquote><h2 id="å®‰è£…Qemu"><a href="#å®‰è£…Qemu" class="headerlink" title="å®‰è£…Qemu"></a>å®‰è£…Qemu</h2><p>qemuæ˜¯ä¸€æ¬¾å®Œå…¨è½¯ä»¶æ¨¡æ‹Ÿ(Binary translation)çš„è™šæ‹ŸåŒ–è½¯ä»¶ï¼Œåœ¨è™šæ‹ŸåŒ–çš„å®ç°ä¸­æ€§èƒ½ç›¸å¯¹è¾ƒå·®ã€‚ä½†åˆ©ç”¨å®ƒåœ¨æµ‹è¯•ç¯å¢ƒä¸­gdbè°ƒè¯•Linuxå†…æ ¸ä»£ç ï¼Œæ˜¯ç†Ÿæ‚‰Linuxå†…æ ¸ä»£ç çš„ä¸€ä¸ªå¥½æ–¹æ³•ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å®‰è£…qemu</span></span><br><span class="line">sudo apt-get install qemu</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…ç¼–è¯‘busybox"><a href="#å®‰è£…ç¼–è¯‘busybox" class="headerlink" title="å®‰è£…ç¼–è¯‘busybox"></a>å®‰è£…ç¼–è¯‘busybox</h2><p>å®‰è£…busyboxçš„ç›®çš„æ˜¯ï¼šå€ŸåŠ©BusyBoxæ„å»ºæç®€initramfsï¼Œæä¾›åŸºæœ¬çš„ç”¨æˆ·æ€å¯æ‰§è¡Œç¨‹åºã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2  <span class="comment"># å»å®˜ç½‘æ‰¾æœ€æ–°ç‰ˆ</span></span><br><span class="line">tar -xvf busybox-1.36.1.tar.bz2</span><br><span class="line"><span class="built_in">cd</span> busybox-1.36.1/</span><br><span class="line">make menuconfig</span><br></pre></td></tr></table></figure><p>åœ¨ç¼–è¯‘busyboxä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œè®¾ç½®ï¼Œæ‰§è¡Œ<code>make menuconfig</code>ï¼Œå¦‚ä¸‹</p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202311201135953.png" alt="image-20231120113536905"></p><p><img src="https://raw.githubusercontent.com/wfloveiu/blogImage/main/img/202311201136740.png" alt="image-20231120113608696"></p><p>è¿™é‡Œä¸€å®šè¦é€‰æ‹©<strong>é™æ€ç¼–è¯‘</strong>ï¼Œç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶<code>busybox</code>ä¸ä¾èµ–åŠ¨æ€é“¾æ¥åº“ï¼Œå¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œæ–¹ä¾¿æ„å»ºinitramfsã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j 8</span><br><span class="line">make &amp;&amp; make install <span class="comment"># å®‰è£…å®Œæˆåç”Ÿæˆçš„ç›¸å…³æ–‡ä»¶ä¼šåœ¨ _install ç›®å½•ä¸‹</span></span><br></pre></td></tr></table></figure><h2 id="æ„å»ºinitramfsæ ¹æ–‡ä»¶ç³»ç»Ÿ"><a href="#æ„å»ºinitramfsæ ¹æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="æ„å»ºinitramfsæ ¹æ–‡ä»¶ç³»ç»Ÿ"></a>æ„å»ºinitramfsæ ¹æ–‡ä»¶ç³»ç»Ÿ</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨busyboxå‹ç¼©åŒ…çš„ä¸‹è½½ç›®å½•ä¸‹,åˆ›å»ºçš„è¯¥æ–‡ä»¶å¤¹ï¼Œè¯¥æ–‡ä»¶å¤¹ä¸‹æœ‰</span></span><br><span class="line"><span class="comment"># wufang@wufang:~/linux_kernel/kernel_compile$ ls</span></span><br><span class="line"><span class="comment"># busybox-1.36.1   busybox-1.36.1.tar.bz2   linux-5.14  linux-5.14.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> initramfs</span><br><span class="line"><span class="built_in">cd</span> initramfs</span><br><span class="line"><span class="built_in">cp</span> ../busybox-1.29.0/_install/* -rf ./ <span class="comment">#å°†_installæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°initramfsæ–‡ä»¶å¤¹ä¸‹</span></span><br><span class="line"><span class="built_in">mkdir</span> dev proc sys</span><br><span class="line">sudo <span class="built_in">cp</span> -a /dev/&#123;null,console,<span class="built_in">tty</span>,tty1,tty2,tty3,tty4&#125; dev/</span><br><span class="line"><span class="built_in">rm</span> -f linuxrc</span><br><span class="line">vim init</span><br></pre></td></tr></table></figure><p>æ·»åŠ å¦‚ä¸‹ä»£ç </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/busybox sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&#123;==DBG==&#125; INIT SCRIPT&quot;</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;&#123;==DBG==&#125; Boot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds&quot;</span></span><br><span class="line"><span class="built_in">exec</span> /sbin/init</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> a+x init ä¿®æ”¹æ–‡ä»¶æƒé™</span><br><span class="line"><span class="comment"># å®Œæˆåï¼Œinitramsä¸‹æœ‰å¦‚ä¸‹æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># bin   dev   init  proc  sbin  sys   usr</span></span><br></pre></td></tr></table></figure><p><strong>æ‰“åŒ…initramfs</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">find . -print0 | cpio --null -ov --format=newc | gzip -9 &gt; ../initramfs.cpio.gz</span><br><span class="line"><span class="comment"># æ­¤æ—¶åœ¨busyboxå‹ç¼©åŒ…çš„ä¸‹è½½ç›®å½•ä¸‹ï¼Œæœ‰å¦‚ä¸‹æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># busybox-1.36.1          initramfs               linux-5.14</span></span><br><span class="line"><span class="comment"># busybox-1.36.1.tar.bz2  initramfs.cpio.gz       linux-5.14.tar.gz</span></span><br></pre></td></tr></table></figure><h2 id="å¯åŠ¨Qemuè°ƒè¯•å†…æ ¸"><a href="#å¯åŠ¨Qemuè°ƒè¯•å†…æ ¸" class="headerlink" title="å¯åŠ¨Qemuè°ƒè¯•å†…æ ¸"></a>å¯åŠ¨Qemuè°ƒè¯•å†…æ ¸</h2><p>ä¸Šè¿°å®Œæˆä¹‹åï¼Œå°±å¯ä»¥å¯åŠ¨Qemuæ¥è°ƒè¯•å†…æ ¸äº†,å¯åŠ¨ä»£ç å¦‚ä¸‹ï¼ˆæ˜¯ä¸€ä¸ªæŒ‡ä»¤ï¼‰</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -kernel ./arch/x86/boot/bzImage -initrd ../initramfs.cpio.gz -append <span class="string">&quot;nokaslr console=ttyS0&quot;</span> -s -S -nographic</span><br></pre></td></tr></table></figure><ul><li><code>qemu-system-x86_64</code>ï¼šæŒ‡å®šæ˜¯x86ï¼Œ64ä½;</li><li><code>-kernel ./arch/x86/boot/bzImage</code>ï¼šæŒ‡å®šå¯ç”¨çš„å†…æ ¸é•œåƒï¼›</li><li><code>-initrd ../initramfs.cpio.gz</code>ï¼šæŒ‡å®šå¯åŠ¨çš„å†…å­˜æ–‡ä»¶ç³»ç»Ÿ</li><li><code>-append &quot;nokaslr console=ttyS0&quot;</code> ï¼šé™„åŠ å‚æ•°ï¼Œå…¶ä¸­ <code>nokaslr</code> å‚æ•°<strong>å¿…é¡»æ·»åŠ è¿›æ¥</strong>ï¼Œé˜²æ­¢å†…æ ¸èµ·å§‹åœ°å€éšæœºåŒ–ï¼Œè¿™æ ·ä¼šå¯¼è‡´ gdb æ–­ç‚¹ä¸èƒ½å‘½ä¸­ï¼›</li><li><code>-s</code> ï¼šç›‘å¬åœ¨ gdb 1234 ç«¯å£ï¼›</li><li><code>-S</code> ï¼šè¡¨ç¤ºå¯åŠ¨åå°±æŒ‚èµ·ï¼Œç­‰å¾… gdb è¿æ¥ï¼›</li><li><code>-nographic</code>ï¼šä¸å¯åŠ¨å›¾å½¢ç•Œé¢</li></ul><p>å¼€å¯å¦ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¾“å…¥<strong>gdb</strong>ï¼Œå³å¯å¼€å¯è°ƒè¯•</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) target remote localhost:1234  <span class="comment">#è¿æ¥qemuç›‘å¬çš„ç«¯å£</span></span><br><span class="line">(gdb) <span class="built_in">break</span> start_kernel      <span class="comment">#åœ¨start_kernelæ‰“æ–­ç‚¹</span></span><br><span class="line">(gdb) <span class="built_in">break</span>  rest_init        <span class="comment">#åœ¨res_initæ‰“æ–­ç‚¹</span></span><br><span class="line">(gdb) c                       <span class="comment">#è¿è¡Œåˆ°æ–­ç‚¹å¤„</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linuxå†…æ ¸ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Butterflyä¸­å–æ¶ˆå¤´åƒè½¬åŠ¨</title>
      <link href="/2023/11/18/hexo1/"/>
      <url>/2023/11/18/hexo1/</url>
      
        <content type="html"><![CDATA[<h2 id="Hexo-Butterflyä¸­é¼ æ ‡æ”¾åˆ°å¤´åƒä¸Šå¤´åƒä¼šè½¬åŠ¨ï¼Œå¦‚ä½•å–æ¶ˆè½¬åŠ¨"><a href="#Hexo-Butterflyä¸­é¼ æ ‡æ”¾åˆ°å¤´åƒä¸Šå¤´åƒä¼šè½¬åŠ¨ï¼Œå¦‚ä½•å–æ¶ˆè½¬åŠ¨" class="headerlink" title="Hexo+Butterflyä¸­é¼ æ ‡æ”¾åˆ°å¤´åƒä¸Šå¤´åƒä¼šè½¬åŠ¨ï¼Œå¦‚ä½•å–æ¶ˆè½¬åŠ¨"></a>Hexo+Butterflyä¸­é¼ æ ‡æ”¾åˆ°å¤´åƒä¸Šå¤´åƒä¼šè½¬åŠ¨ï¼Œå¦‚ä½•å–æ¶ˆè½¬åŠ¨</h2><p>è¿™ä¸ªåœ¨_configä¸­æ”¹ä¸äº†ï¼Œç»è¿‡æŸ¥é˜…èµ„æ–™ï¼Œå‘ç°åœ¨ hexo-theme-butterfly&#x2F;source&#x2F;css&#x2F;_layout&#x2F;aside.stylä¸­è¿›è¡Œæ›´æ”¹,å¤§çº¦åœ¨324è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">img</span><br><span class="line">  width: 100%</span><br><span class="line">  height: 100%</span><br><span class="line">  transition: filter 375ms ease-in .2s, transform .3s</span><br><span class="line">  object-fit: cover</span><br><span class="line"></span><br><span class="line">  &amp;:hover</span><br><span class="line">    transform: rotate(360deg)</span><br></pre></td></tr></table></figure><p>å°†åä¸¤è¡Œåˆ æ‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">img</span><br><span class="line">  width: 100%</span><br><span class="line">  height: 100%</span><br><span class="line">  transition: filter 375ms ease-in .2s, transform .3s</span><br><span class="line">  object-fit: cover</span><br></pre></td></tr></table></figure><p>è¿™æ ·å¤´åƒå°±ä¸ä¼šè½¬åŠ¨äº†</p><p>å‚è€ƒé“¾æ¥: <a href="https://github.com/jerryc127/hexo-theme-butterfly/discussions/878">https://github.com/jerryc127/hexo-theme-butterfly/discussions/878</a></p>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ›´æ”¹é…ç½® </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
